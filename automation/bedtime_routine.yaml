blueprint:
  name: "Bedtime routine – LLM-driven goodnight (Audiobook)"
  author: madalone
  description: '![Image](https://raw.githubusercontent.com/mmadalone/HA-Master-Repo/main/images/header/bedtime_routine-header.jpeg)

    # Bedtime routine – LLM-driven goodnight (Audiobook)

    Fully LLM-orchestrated bedtime wind-down with audiobook playback via Music
    Assistant. Conversational modes (curated/freeform/both) use multi-turn LLM
    dialogue for audiobook selection. Preset mode plays a configured URI directly
    — no conversation, maximum efficiency.

    All modes: stops the TV, kills lights (except living room lamp), countdown
    timer, bathroom occupancy guard, then final lamp-off.

    > **Looking for Kodi/TV playback?** See the companion *Bedtime Routine Plus*
    blueprint (`bedtime_routine_plus.yaml`).

    ### Recent changes

    - **v4.1.1:** Fixed LLM error messages spoken as TTS — added response_type guard

    - **v4.1.0:** Optional presence sensor gate — skip routine if nobody home
    (configurable ANY/ALL, min duration, manual trigger bypass)

    - **v4.0.1:** Clarified name/description — this is the Audiobook/MA variant

    - **v4:** Preset audiobook mode — direct URI play, media pause-with-fallback,
    settling-in and final-goodnight contextual TTS slots'
  domain: automation
  homeassistant:
    min_version: "2024.10.0"
  input:
    # ===========================================================================
    # ① TRIGGER
    # ===========================================================================
    trigger_settings:
      name: "① Trigger"
      icon: mdi:play-circle-outline
      description: >
        How the bedtime routine starts. Enable scheduled, manual, or both.
      input:
        scheduled_time:
          name: Scheduled bedtime
          description: >
            Time to automatically trigger bedtime. Leave empty to disable
            the scheduled trigger.
          default:
          selector:
            time: {}

        manual_trigger:
          name: Manual trigger boolean
          description: >
            An input_boolean entity exposed to voice assistants (e.g. Alexa).
            Toggling it ON triggers the bedtime routine. Leave empty to disable
            manual triggering.
          default:
          selector:
            entity:
              domain: input_boolean

        presence_sensors:
          name: Presence sensors (optional)
          description: >
            One or more occupancy/presence/motion sensors. If ANY (default) or
            ALL report occupied for the minimum duration, the routine proceeds.
            Leave empty to disable the presence gate entirely — the routine
            always runs. Manual triggers bypass this gate regardless.
          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class:
                - occupancy
                - presence
                - motion
              multiple: true

        presence_minimum_minutes:
          name: Minimum presence duration (minutes)
          description: >
            Minimum consecutive minutes a sensor must report occupied before
            the gate passes. Set to 0 to check current state only (is anyone
            there right now?). Higher values prevent false positives from
            someone walking through.
          default: 0
          selector:
            number:
              min: 0
              max: 300
              unit_of_measurement: minutes

        presence_require_all:
          name: Require ALL sensors
          description: >
            If enabled, ALL configured presence sensors must confirm presence.
            If disabled (default), ANY single sensor confirming presence is
            sufficient to pass the gate.
          default: false
          selector:
            boolean: {}

    # ===========================================================================
    # ② DEVICES
    # ===========================================================================
    devices:
      name: "② Devices"
      icon: mdi:television-off
      description: >
        TV, lights, and speaker switches involved in the bedtime shutdown.
      input:
        tv_entity:
          name: TV media player (optional)
          description: >
            The TV to stop/turn off via media_player.turn_off (CEC/software).
            Leave empty if your TV is IR-only.
          default:
          selector:
            entity:
              domain: media_player

        tv_off_script:
          name: TV off script (optional)
          description: >
            A script entity that handles TV shutdown — useful for complex IR
            sequences, multi-step power-off, or any hardware-specific logic.
            The blueprint fires it with script.turn_on; the script handles
            the rest. Leave empty if not needed.
          default:
          selector:
            entity:
              domain: script

        tv_ir_remote:
          name: IR remote entity (optional)
          description: >
            A remote entity (e.g. Broadlink, SmartIR) for sending a direct
            IR power-off command. Used with the IR command below. Leave empty
            if not needed.
          default:
          selector:
            entity:
              domain: remote

        tv_ir_command:
          name: IR power-off command
          description: >
            The command string to send via remote.send_command (e.g. "Power",
            "power_off", "turn_off"). Only used if an IR remote entity is set.
          default: "Power"
          selector:
            text: {}

        tv_ir_device:
          name: IR device name
          description: >
            The learned device name in your Broadlink/SmartIR remote (e.g.
            "Philips TV", "Sony_TV", "TV"). This must match the device name
            used when you learned the IR codes. Only used if an IR remote
            entity is set.
          default: ""
          selector:
            text: {}

        lights_off_target:
          name: Lights to turn off
          description: >
            Lights or switches to kill immediately. Use area or label targeting
            to auto-include future devices. The living room lamp (below) is
            excluded separately — it stays on during the countdown.
          selector:
            target:
              entity:
                domain:
                  - light
                  - switch

        living_room_lamp:
          name: Living room lamp
          description: >
            The lamp that stays on during the countdown and is turned off last,
            after the bathroom guard clears. Can be a light or a switch (smart plug).
          selector:
            entity:
              domain:
                - light
                - switch

        reset_switches:
          name: Speaker reset switches (optional)
          description: >
            Switches to power-cycle before TTS (e.g. smart plugs on speakers).
            Leave empty if your speakers don't need a reset.
          default: {}
          selector:
            target:
              entity:
                domain: switch

        reset_switch_delay:
          name: Speaker reset delay
          description: >
            How long to wait between turning reset switches off and on.
          default: "0:00:02"
          selector:
            duration: {}

        media_players_stop:
          name: Media players to pause/stop (optional)
          description: >
            Additional media players to pause before lights-off — Chromecast,
            Sonos, Music Assistant players, etc. The TV is handled separately
            by the CEC/IR/script methods above. In preset mode, pause is
            attempted first with a fallback to stop. In conversational modes,
            stop is used directly (legacy behavior). Leave empty if not needed.
          default: {}
          selector:
            target:
              entity:
                domain: media_player

    # ===========================================================================
    # ③ AI CONVERSATION
    # ===========================================================================
    conversation:
      name: "③ AI conversation"
      icon: mdi:robot-happy
      description: >
        Conversation agent, satellite, and bedtime announcement settings.
      input:
        conversation_agent:
          name: Conversation agent
          description: >
            Dedicated bedtime conversation agent. Its system prompt handles
            personality, permissions, and behavioral rules. The blueprint only
            sends dynamic per-run context.
          default: conversation.quark_extended_bedtime
          selector:
            conversation_agent:

        assist_satellites:
          name: Assist satellites
          description: >
            Voice PE / Assist satellites that deliver the bedtime conversation.
          selector:
            target:
              entity:
                domain: assist_satellite

        tts_engine:
          name: TTS engine
          description: >
            Text-to-speech engine for spoken messages (e.g. ElevenLabs, Piper).
          selector:
            entity:
              domain: tts

        voice_profile:
          name: TTS voice profile (optional)
          description: >
            ElevenLabs voice profile name. Leave empty for the engine default
            or if not using ElevenLabs.
          default: ""
          selector:
            text: {}

        default_countdown_minutes:
          name: Default countdown (minutes)
          description: >
            How many minutes before the lamp turns off. In conversational modes
            the LLM announces this and (if enabled) lets the user negotiate more
            time. In preset mode this is the fixed countdown — no negotiation.
          default: 4
          selector:
            number:
              min: 1
              max: 30
              unit_of_measurement: minutes

        enable_countdown_negotiation:
          name: Enable countdown negotiation
          description: >
            Allow the LLM to negotiate extra time with the user. If disabled,
            the default countdown is used without asking. Ignored in preset
            audiobook mode (negotiation is always off in preset).
          default: true
          selector:
            boolean: {}

        enable_audiobook_offer:
          name: Enable audiobook offer
          description: >
            Let the LLM offer a bedtime audiobook after the countdown
            announcement. If disabled, skips straight to goodnight. Ignored
            in preset mode (audiobook always plays in preset).
          default: true
          selector:
            boolean: {}

        bedtime_prompt:
          name: Bedtime announcement prompt
          description: >
            Prompt sent to the conversation agent to generate the bedtime
            announcement. Available variables: {{ countdown_minutes }}.
            Used in all modes — preset and conversational.
          default: >
            It's bedtime. Lights out in {{ countdown_minutes }} minutes.
            Announce this and ask if the user wants more time.
            Keep it short — max 2 sentences.
          selector:
            text:
              multiline: true

        goodnight_prompt:
          name: Goodnight prompt (conversational modes)
          description: >
            Prompt for the final goodnight message in curated/freeform/both
            modes — fires after countdown and audiobook decisions are settled.
            Not used in preset mode (use the contextual goodnight in ⑦ instead).
          default: >
            Say goodnight. Be warm but brief — one or two sentences max.
          selector:
            text:
              multiline: true

    # ===========================================================================
    # ④ AUDIOBOOK
    # ===========================================================================
    audiobook:
      name: "④ Audiobook"
      icon: mdi:book-open-page-variant
      description: >
        Audiobook playback settings. Conversational modes (curated/freeform/both)
        use an LLM satellite conversation for selection. Preset mode plays a
        configured URI directly — no conversation, no choice.
      input:
        audiobook_player:
          name: Music Assistant player (bedroom)
          description: >
            The MA player for audiobook playback. Must be a Music Assistant
            media_player entity.
          selector:
            entity:
              filter:
                - integration: music_assistant
                  domain:
                    - media_player

        audiobook_mode:
          name: Audiobook selection mode
          description: >
            How audiobook playback works at bedtime. Curated/freeform/both use
            LLM conversations for interactive selection. Preset plays a fixed
            URI every night — no conversation, no negotiation, maximum efficiency.
          default: both
          selector:
            select:
              options:
                - label: "Curated list only"
                  value: curated
                - label: "Freeform (LLM picks via Music Assistant)"
                  value: freeform
                - label: "Both (curated first, freeform fallback)"
                  value: both
                - label: "Preset (fixed URI, no conversation)"
                  value: preset

        curated_audiobooks:
          name: Curated audiobook list
          description: >
            Comma-separated list of audiobook titles available for bedtime.
            The LLM presents these as options. Only used in curated/both modes.
          default: "The Hitchhiker's Guide to the Galaxy, Dune, The Hobbit"
          selector:
            text:
              multiline: true

        audiobook_preset_uri:
          name: Preset audiobook URI
          description: >
            Music Assistant content ID for preset mode. Can be an MA library
            URI (e.g. "library://playlist/157"), a playlist name, album name,
            or any string MA can resolve via play_media. Only used in preset mode.
          default: ""
          selector:
            text: {}

        audiobook_media_type:
          name: Audiobook media type
          description: >
            How Music Assistant should search/resolve the audiobook. In preset
            mode, "auto" usually works since MA can infer type from the URI.
          default: auto
          selector:
            select:
              options:
                - label: "Auto (let MA decide)"
                  value: auto
                - label: "Audiobook"
                  value: audiobook
                - label: "Album"
                  value: album
                - label: "Playlist"
                  value: playlist
                - label: "Track"
                  value: track

        audiobook_volume:
          name: Audiobook playback volume
          description: >
            Volume level for audiobook playback (0.0 to 1.0).
          default: 0.25
          selector:
            number:
              min: 0.05
              max: 1.0
              step: 0.05

    # ===========================================================================
    # ⑤ BATHROOM GUARD & TIMING
    # ===========================================================================
    timing_and_guards:
      name: "⑤ Bathroom guard & timing"
      icon: mdi:timer-sand
      description: >
        Bathroom occupancy detection, grace periods, and cleanup timing.
      input:
        bathroom_sensor:
          name: Bathroom occupancy sensor
          description: >
            Binary sensor that detects bathroom occupancy. The lamp stays on
            while this sensor is occupied, with a grace period after it clears.
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy

        bathroom_grace_period:
          name: Bathroom grace period
          description: >
            How long to keep the lamp on after the bathroom sensor clears.
            Prevents lights-out while someone walks between bathroom and bedroom.
          default: "0:02:00"
          selector:
            duration: {}

        bathroom_max_timeout:
          name: Bathroom guard max timeout
          description: >
            Maximum time to wait for the bathroom to clear. After this, the lamp
            turns off regardless — can't wait forever.
          default: "0:10:00"
          selector:
            duration: {}

        countdown_helper:
          name: Countdown minutes helper
          description: >
            An input_number helper that the conversation agent uses to set
            the negotiated countdown duration (via an exposed script).
            Create one with min=1, max=30, step=1.
          selector:
            entity:
              domain: input_number

        temporary_switches:
          name: Temporary switches (optional)
          description: >
            Switches turned on during the bedtime flow and cleaned up at the end.
            E.g. a "bedtime_active" indicator boolean.
          default: {}
          selector:
            target:
              entity:
                domain:
                  - switch
                  - input_boolean

        post_tts_delay:
          name: Post-TTS delay (seconds)
          description: >
            Buffer after TTS speak actions to let streaming audio finish.
            ElevenLabs needs 5+ seconds; Piper may need less.
          default: 5
          selector:
            number:
              min: 1
              max: 15
              unit_of_measurement: seconds

    # ===========================================================================
    # ⑥ SETTLING-IN TTS (PRESET MODE)
    # ===========================================================================
    settling_tts:
      name: "⑥ Settling-in TTS (preset mode)"
      icon: mdi:weather-night
      description: >
        Optional contextual TTS announcement after the audiobook starts playing
        in preset mode. The LLM receives sensor states for context — e.g.
        temperature, weather, humidity — and generates a brief settling-in message.
        Ignored in conversational audiobook modes.
      input:
        enable_settling_tts:
          name: Enable settling-in TTS
          description: >
            Deliver a short contextual announcement after the audiobook starts.
            Only used in preset audiobook mode.
          default: false
          selector:
            boolean: {}

        settling_prompt:
          name: Settling-in prompt
          description: >
            Prompt for the settling-in message. Sensor states are injected
            automatically — the agent sees them as context. Keep it brief.
          default: >
            The user is settling in for bed. The audiobook is already playing.
            Give a very brief, warm observation based on the sensor data
            provided. One sentence max. Don't mention the audiobook.
          selector:
            text:
              multiline: true

        settling_sensors:
          name: Settling-in context sensors
          description: >
            Entities whose current state is injected into the LLM prompt for
            context. E.g. outdoor temperature, bedroom humidity, weather
            condition. The agent receives "entity_id: state" pairs.
          default: []
          selector:
            entity:
              multiple: true

    # ===========================================================================
    # ⑦ FINAL GOODNIGHT TTS (PRESET MODE)
    # ===========================================================================
    goodnight_context_tts:
      name: "⑦ Final goodnight TTS (preset mode)"
      icon: mdi:moon-waning-crescent
      description: >
        Optional contextual goodnight announcement after the bathroom guard
        clears in preset mode. The LLM receives sensor states and generates
        a final goodnight. Ignored in conversational audiobook modes (which
        use the simpler goodnight prompt in ③ instead).
      input:
        enable_goodnight_tts:
          name: Enable final goodnight TTS
          description: >
            Deliver a contextual goodnight after the bathroom guard clears.
            Only used in preset audiobook mode.
          default: false
          selector:
            boolean: {}

        goodnight_context_prompt:
          name: Final goodnight prompt
          description: >
            Prompt for the final goodnight message. Sensor states are injected
            automatically. This fires right before the lamp turns off.
          default: >
            The user is about to sleep. Lights are going off. Say goodnight
            with a brief, warm message informed by the sensor data. One or
            two sentences max.
          selector:
            text:
              multiline: true

        goodnight_sensors:
          name: Goodnight context sensors
          description: >
            Entities whose current state is injected into the LLM prompt for
            the final goodnight. Can differ from settling-in sensors — e.g.
            include tomorrow's weather forecast, alarm time, etc.
          default: []
          selector:
            entity:
              multiple: true

# ═══════════════════════════════════════════════════════════════════════
# Variables
# ═══════════════════════════════════════════════════════════════════════
variables:
  # --- Trigger inputs ---
  scheduled_time_val: !input scheduled_time
  manual_trigger_val: !input manual_trigger

  # --- Presence gate inputs ---
  presence_sensors_val: !input presence_sensors
  presence_min_minutes: !input presence_minimum_minutes
  presence_require_all_val: !input presence_require_all
  presence_gate_passed: >-
    {% set sensors = presence_sensors_val | default([]) %}
    {% if sensors | length == 0 %}
      true
    {% else %}
      {% set ns = namespace(results=[]) %}
      {% for sensor in sensors %}
        {% set s = states(sensor) | default('unavailable') %}
        {% if s in ['unavailable', 'unknown'] %}
          {% set ns.results = ns.results + [true] %}
        {% elif s == 'on' %}
          {% if presence_min_minutes | int(0) == 0 %}
            {% set ns.results = ns.results + [true] %}
          {% else %}
            {% set changed = state_attr(sensor, 'last_changed') | default(none) %}
            {% if changed is none %}
              {% set ns.results = ns.results + [true] %}
            {% else %}
              {% set elapsed = (now() - changed).total_seconds() / 60 %}
              {% set ns.results = ns.results + [(elapsed >= presence_min_minutes | int(0))] %}
            {% endif %}
          {% endif %}
        {% else %}
          {% set ns.results = ns.results + [false] %}
        {% endif %}
      {% endfor %}
      {% if presence_require_all_val %}
        {{ ns.results | reject('eq', true) | list | length == 0 }}
      {% else %}
        {{ ns.results | select('eq', true) | list | length > 0 }}
      {% endif %}
    {% endif %}

  # --- Device inputs ---
  tv_entity: !input tv_entity
  tv_off_script: !input tv_off_script
  tv_ir_remote: !input tv_ir_remote
  tv_ir_command: !input tv_ir_command
  tv_ir_device: !input tv_ir_device
  living_room_lamp: !input living_room_lamp
  reset_switches_val: !input reset_switches
  media_players_stop_val: !input media_players_stop

  # --- Conversation inputs ---
  conversation_agent: !input conversation_agent
  tts_engine_entity: !input tts_engine
  voice_profile_val: !input voice_profile
  default_countdown: !input default_countdown_minutes
  enable_negotiation: !input enable_countdown_negotiation
  enable_audiobook: !input enable_audiobook_offer
  bedtime_prompt_tpl: !input bedtime_prompt
  goodnight_prompt_tpl: !input goodnight_prompt

  # --- Audiobook inputs ---
  audiobook_player: !input audiobook_player
  audiobook_mode: !input audiobook_mode
  curated_list: !input curated_audiobooks
  preset_uri: !input audiobook_preset_uri
  audiobook_media_type: !input audiobook_media_type
  audiobook_volume: !input audiobook_volume

  # --- Timing inputs ---
  bathroom_sensor: !input bathroom_sensor
  countdown_helper: !input countdown_helper
  post_tts_delay_val: !input post_tts_delay

  # --- Settling-in TTS inputs ---
  enable_settling: !input enable_settling_tts
  settling_prompt_tpl: !input settling_prompt
  settling_sensor_list: !input settling_sensors

  # --- Final goodnight TTS inputs ---
  enable_gn_context: !input enable_goodnight_tts
  gn_context_prompt_tpl: !input goodnight_context_prompt
  gn_sensor_list: !input goodnight_sensors

  # --- Derived ---
  is_preset_mode: "{{ audiobook_mode == 'preset' }}"
  countdown_minutes: >-
    {{ states(countdown_helper) | int(default_countdown) }}

# ═══════════════════════════════════════════════════════════════════════
# Triggers
# ═══════════════════════════════════════════════════════════════════════
triggers:
  - alias: "Scheduled bedtime trigger"
    trigger: time
    at: !input scheduled_time
    id: scheduled

  - alias: "Manual trigger — input_boolean toggled on"
    trigger: state
    entity_id: !input manual_trigger
    to: "on"
    id: manual

conditions: []

# ═══════════════════════════════════════════════════════════════════════
# Actions
# ═══════════════════════════════════════════════════════════════════════
actions:
  # --- Common preamble (all modes) --------------------------------------------

  - alias: "Auto-reset manual trigger boolean — must happen before any condition can abort (§7.7)"
    choose:
      - alias: "Manual trigger was used — reset the boolean"
        conditions:
          - condition: trigger
            id: manual
        sequence:
          - alias: "Turn off the manual trigger boolean"
            action: input_boolean.turn_off
            target:
              entity_id: !input manual_trigger

  - alias: "Presence gate — abort if configured sensors show nobody present (manual trigger bypasses)"
    choose:
      - alias: "Presence gate active and failed — nobody home, abort routine"
        conditions:
          - condition: template
            alias: "Trigger is scheduled (manual bypasses gate)"
            value_template: "{{ trigger.id | default('scheduled') == 'scheduled' }}"
          - condition: template
            alias: "Presence sensors are configured"
            value_template: "{{ presence_sensors_val | default([]) | length > 0 }}"
          - condition: template
            alias: "Presence gate did not pass"
            value_template: "{{ not (presence_gate_passed | bool(true)) }}"
        sequence:
          - alias: "Log presence gate failure — routine skipped"
            action: logbook.log
            data:
              name: "Bedtime Routine"
              message: >-
                Presence gate: no presence detected. Routine skipped.
                Sensors: {{ presence_sensors_val | join(', ') }}.
                Mode: {{ 'require ALL' if presence_require_all_val else 'require ANY' }}.
                Min duration: {{ presence_min_minutes }} min.

          - alias: "Cleanup — turn off temporary switches before aborting"
            action: homeassistant.turn_off
            target: !input temporary_switches

          - stop: "Presence gate failed — nobody detected, routine aborted."

  - alias: "Initialize countdown helper to default minutes — agent may override via exposed script"
    action: input_number.set_value
    target:
      entity_id: !input countdown_helper
    data:
      value: "{{ default_countdown }}"

  - alias: "Activate temporary switches — bedtime_active indicator, etc."
    action: homeassistant.turn_on
    target: !input temporary_switches

  - alias: "Reset speakers — power-cycle to clear stale connections (skipped if no switches configured)"
    choose:
      - alias: "Reset switches are configured — power-cycle them"
        conditions:
          - condition: template
            value_template: >-
              {{ reset_switches_val is mapping
                 and (reset_switches_val.get('entity_id', []) | length > 0
                      or reset_switches_val.get('area_id', []) | length > 0
                      or reset_switches_val.get('label_id', []) | length > 0) }}
        sequence:
          - alias: "Power off reset switches"
            action: switch.turn_off
            target: !input reset_switches

          - alias: "Wait for speaker hardware to discharge"
            delay: !input reset_switch_delay

          - alias: "Power on reset switches"
            action: switch.turn_on
            target: !input reset_switches

          - alias: "Wait for speakers to boot and become available"
            delay:
              seconds: 3

  # --- Mode branch — preset vs conversational ---------------------------------

  - alias: "Mode branch — preset audiobook mode vs conversational modes"
    choose:
      # =====================================================================
      # PRESET MODE — direct play, no LLM audiobook conversation
      # =====================================================================
      - alias: "Preset audiobook mode — streamlined flow with direct play"
        conditions:
          - condition: template
            value_template: "{{ is_preset_mode }}"
        sequence:
          # --- LLM bedtime announcement (one-shot TTS, no negotiation) ---
          - alias: "Generate bedtime announcement via conversation agent (preset — no negotiation)"
            continue_on_error: true
            action: conversation.process
            response_variable: bedtime_response
            data:
              agent_id: "{{ conversation_agent }}"
              text: "{{ bedtime_prompt_tpl }}"

          - alias: "Extract bedtime announcement with defensive fallback"
            variables:
              bedtime_message: >-
                {% if bedtime_response is defined
                   and bedtime_response.response is defined
                   and bedtime_response.response.response_type | default('') != 'error'
                   and bedtime_response.response.speech is defined %}
                  {{ bedtime_response.response.speech.plain.speech
                     | default("Time for bed. Lights out in " ~ default_countdown ~ " minutes.") }}
                {% else %}
                  Time for bed. Lights out in {{ default_countdown }} minutes.
                {% endif %}

          - alias: "Deliver bedtime announcement via TTS — one-shot, no satellite conversation"
            choose:
              - alias: "TTS with voice profile (ElevenLabs)"
                conditions:
                  - condition: template
                    value_template: "{{ voice_profile_val | default('') | string | length > 0 }}"
                sequence:
                  - alias: "Speak bedtime announcement with custom voice profile"
                    action: tts.speak
                    target:
                      entity_id: "{{ tts_engine_entity }}"
                    data:
                      media_player_entity_id: "{{ audiobook_player }}"
                      message: "{{ bedtime_message }}"
                      options:
                        voice_profile: "{{ voice_profile_val }}"
            default:
              - alias: "Speak bedtime announcement with default TTS voice"
                action: tts.speak
                target:
                  entity_id: "{{ tts_engine_entity }}"
                data:
                  media_player_entity_id: "{{ audiobook_player }}"
                  message: "{{ bedtime_message }}"

          - alias: "Post-TTS buffer — let streaming audio finish before TV/lights actions"
            delay:
              seconds: "{{ post_tts_delay_val }}"

          # --- TV shutdown (same three-method stack) ---
          - alias: "TV shutdown — media_player.turn_off (skipped if no TV entity configured)"
            choose:
              - alias: "TV media player is configured — send software/CEC off"
                conditions:
                  - condition: template
                    value_template: "{{ tv_entity | default('') | string not in ['', 'none', 'None'] }}"
                sequence:
                  - alias: "Stop the TV via media_player — CEC/software shutdown"
                    action: media_player.turn_off
                    target:
                      entity_id: "{{ tv_entity }}"

          - alias: "Wait for CEC state to propagate before IR check"
            delay:
              seconds: 2

          - alias: "TV shutdown — fire custom off script (skipped if no script configured)"
            choose:
              - alias: "TV off script is configured — fire it"
                conditions:
                  - condition: template
                    value_template: "{{ tv_off_script | default('') | string not in ['', 'none', 'None'] }}"
                sequence:
                  - alias: "Fire the user's TV off script — handles IR sequences, delays, etc."
                    action: script.turn_on
                    target:
                      entity_id: "{{ tv_off_script }}"

          - alias: "TV shutdown — IR remote power-off (skipped if no remote configured, or TV already off)"
            choose:
              - alias: "IR remote is configured AND TV not already off — send power-off command"
                conditions:
                  - condition: template
                    alias: "IR remote entity is configured"
                    value_template: "{{ tv_ir_remote | default('') | string not in ['', 'none', 'None'] }}"
                  - condition: template
                    alias: "TV state guard — skip IR if CEC reports off/standby (fail-open if no CEC entity)"
                    value_template: >-
                      {% set tv = tv_entity | default('') | string %}
                      {% if tv in ['', 'none', 'None'] %}
                        true
                      {% else %}
                        {{ states(tv) not in ['off', 'standby', 'unavailable'] }}
                      {% endif %}
                sequence:
                  - alias: "Send IR power-off command via remote.send_command"
                    action: remote.send_command
                    target:
                      entity_id: "{{ tv_ir_remote }}"
                    data:
                      device: "{{ tv_ir_device }}"
                      command: "{{ tv_ir_command | default('Power') }}"

          # --- Lights off except lamp ---
          - alias: "Turn off targeted lights/switches — lamp stays on for the countdown"
            action: homeassistant.turn_off
            target: !input lights_off_target

          - alias: "Ensure the living room lamp is ON — nightlight during the countdown"
            action: homeassistant.turn_on
            target:
              entity_id: "{{ living_room_lamp }}"

          # --- Media players: pause with fallback to stop ---
          - alias: "Pause additional media players — fallback to stop on error (skipped if none configured)"
            choose:
              - alias: "Media players are configured — attempt pause then fallback stop"
                conditions:
                  - condition: template
                    value_template: >-
                      {{ media_players_stop_val is mapping
                         and (media_players_stop_val.get('entity_id', []) | length > 0
                              or media_players_stop_val.get('area_id', []) | length > 0
                              or media_players_stop_val.get('label_id', []) | length > 0) }}
                sequence:
                  - alias: "Attempt pause on media players — not all players support pause cleanly"
                    continue_on_error: true
                    action: media_player.media_pause
                    target: !input media_players_stop

                  - alias: "Fallback stop — catches players where pause failed or isn't supported"
                    continue_on_error: true
                    action: media_player.media_stop
                    target: !input media_players_stop

          # --- Direct audiobook play via Music Assistant ---
          - alias: "Set audiobook player volume before playback"
            action: media_player.volume_set
            target:
              entity_id: "{{ audiobook_player }}"
            data:
              volume_level: "{{ audiobook_volume }}"

          - alias: "Play preset audiobook — direct URI, no conversation, enqueue replace (restart)"
            action: music_assistant.play_media
            target:
              entity_id: "{{ audiobook_player }}"
            data:
              media_id: "{{ preset_uri }}"
              media_type: "{{ audiobook_media_type }}"
              enqueue: replace

          - alias: "Brief buffer after audiobook play command"
            delay:
              seconds: 3

          # --- Optional settling-in contextual TTS ---
          - alias: "Settling-in TTS — optional contextual announcement after audiobook starts"
            choose:
              - alias: "Settling-in TTS is enabled — generate and deliver"
                conditions:
                  - condition: template
                    value_template: "{{ enable_settling }}"
                sequence:
                  - alias: "Build sensor context string for settling-in prompt"
                    variables:
                      settling_sensor_context: >-
                        {% set ns = namespace(lines=[]) %}
                        {% for eid in settling_sensor_list %}
                          {% set ns.lines = ns.lines + [eid ~ ': ' ~ states(eid) | default('unknown')] %}
                        {% endfor %}
                        {{ ns.lines | join('\n') }}

                  - alias: "Generate settling-in message via conversation agent with sensor context"
                    continue_on_error: true
                    action: conversation.process
                    response_variable: settling_response
                    data:
                      agent_id: "{{ conversation_agent }}"
                      text: >-
                        {{ settling_prompt_tpl }}

                        Current sensor readings:
                        {{ settling_sensor_context }}

                  - alias: "Extract settling-in message with defensive fallback"
                    variables:
                      settling_message: >-
                        {% if settling_response is defined
                           and settling_response.response is defined
                           and settling_response.response.response_type | default('') != 'error'
                           and settling_response.response.speech is defined %}
                          {{ settling_response.response.speech.plain.speech
                             | default('') }}
                        {% else %}

                        {% endif %}

                  - alias: "Deliver settling-in TTS if agent produced a message"
                    choose:
                      - alias: "Agent returned a non-empty settling message — speak it"
                        conditions:
                          - condition: template
                            value_template: "{{ settling_message | default('') | trim | length > 0 }}"
                        sequence:
                          - alias: "Speak settling-in message via TTS"
                            choose:
                              - alias: "TTS with voice profile (ElevenLabs)"
                                conditions:
                                  - condition: template
                                    value_template: "{{ voice_profile_val | default('') | string | length > 0 }}"
                                sequence:
                                  - alias: "Speak settling-in with custom voice profile"
                                    action: tts.speak
                                    target:
                                      entity_id: "{{ tts_engine_entity }}"
                                    data:
                                      media_player_entity_id: "{{ audiobook_player }}"
                                      message: "{{ settling_message }}"
                                      options:
                                        voice_profile: "{{ voice_profile_val }}"
                            default:
                              - alias: "Speak settling-in with default TTS voice"
                                action: tts.speak
                                target:
                                  entity_id: "{{ tts_engine_entity }}"
                                data:
                                  media_player_entity_id: "{{ audiobook_player }}"
                                  message: "{{ settling_message }}"

                          - alias: "Post-TTS buffer for settling-in message"
                            delay:
                              seconds: "{{ post_tts_delay_val }}"

          # --- Countdown (non-negotiable in preset mode) ---
          - alias: "Wait the default countdown — lamp stays on, user settles in with audiobook"
            delay:
              minutes: "{{ default_countdown }}"

          # --- Bathroom guard (same logic as conversational mode) ---
          - alias: "Bathroom guard — check if bathroom is currently occupied"
            choose:
              - alias: "Bathroom occupied — wait for it to clear before turning off lamp"
                conditions:
                  - condition: state
                    entity_id: !input bathroom_sensor
                    state: "on"
                sequence:
                  - alias: "Wait for bathroom sensor to clear — max timeout prevents infinite wait"
                    wait_for_trigger:
                      - trigger: state
                        entity_id: !input bathroom_sensor
                        to: "off"
                    timeout: !input bathroom_max_timeout
                    continue_on_timeout: true

                  - alias: "Handle bathroom guard timeout — lights off regardless"
                    if:
                      - condition: template
                        value_template: "{{ not wait.completed }}"
                    then:
                      - alias: "Bathroom guard timed out — proceeding with lamp off anyway"
                        action: logbook.log
                        data:
                          name: "Bedtime Routine"
                          message: >-
                            Bathroom guard timed out after max wait. Turning off lamp regardless.
                    else:
                      - alias: "Bathroom cleared — grace period before turning off lamp"
                        delay: !input bathroom_grace_period

            default:
              - alias: "Bathroom not occupied — check it's been clear long enough"
                choose:
                  - alias: "Bathroom was recently occupied — enforce grace period"
                    conditions:
                      - condition: state
                        entity_id: !input bathroom_sensor
                        state: "off"
                        for: !input bathroom_grace_period
                    sequence:
                      - alias: "Grace period already satisfied — proceed to lamp off"
                        action: logbook.log
                        data:
                          name: "Bedtime Routine"
                          message: "Bathroom clear and grace period satisfied. Turning off lamp."
                default:
                  - alias: "Bathroom recently cleared — wait remaining grace period"
                    delay: !input bathroom_grace_period

          # --- Optional final goodnight contextual TTS ---
          - alias: "Final goodnight TTS — optional contextual announcement after bathroom clears"
            choose:
              - alias: "Final goodnight TTS is enabled — generate and deliver"
                conditions:
                  - condition: template
                    value_template: "{{ enable_gn_context }}"
                sequence:
                  - alias: "Build sensor context string for goodnight prompt"
                    variables:
                      gn_sensor_context: >-
                        {% set ns = namespace(lines=[]) %}
                        {% for eid in gn_sensor_list %}
                          {% set ns.lines = ns.lines + [eid ~ ': ' ~ states(eid) | default('unknown')] %}
                        {% endfor %}
                        {{ ns.lines | join('\n') }}

                  - alias: "Generate final goodnight via conversation agent with sensor context"
                    continue_on_error: true
                    action: conversation.process
                    response_variable: gn_context_response
                    data:
                      agent_id: "{{ conversation_agent }}"
                      text: >-
                        {{ gn_context_prompt_tpl }}

                        Current sensor readings:
                        {{ gn_sensor_context }}

                  - alias: "Extract goodnight context message with defensive fallback"
                    variables:
                      gn_context_message: >-
                        {% if gn_context_response is defined
                           and gn_context_response.response is defined
                           and gn_context_response.response.response_type | default('') != 'error'
                           and gn_context_response.response.speech is defined %}
                          {{ gn_context_response.response.speech.plain.speech
                             | default('Goodnight. Sleep well.') }}
                        {% else %}
                          Goodnight. Sleep well.
                        {% endif %}

                  - alias: "Deliver final goodnight via TTS"
                    choose:
                      - alias: "TTS with voice profile (ElevenLabs)"
                        conditions:
                          - condition: template
                            value_template: "{{ voice_profile_val | default('') | string | length > 0 }}"
                        sequence:
                          - alias: "Speak goodnight with custom voice profile"
                            action: tts.speak
                            target:
                              entity_id: "{{ tts_engine_entity }}"
                            data:
                              media_player_entity_id: "{{ audiobook_player }}"
                              message: "{{ gn_context_message }}"
                              options:
                                voice_profile: "{{ voice_profile_val }}"
                    default:
                      - alias: "Speak goodnight with default TTS voice"
                        action: tts.speak
                        target:
                          entity_id: "{{ tts_engine_entity }}"
                        data:
                          media_player_entity_id: "{{ audiobook_player }}"
                          message: "{{ gn_context_message }}"

                  - alias: "Post-TTS buffer for final goodnight"
                    delay:
                      seconds: "{{ post_tts_delay_val }}"

    # =====================================================================
    # CONVERSATIONAL MODES — curated / freeform / both (existing v3 flow)
    # =====================================================================
    default:
      # --- TV shutdown (same three-method stack) ---
      - alias: "TV shutdown — media_player.turn_off (skipped if no TV entity configured)"
        choose:
          - alias: "TV media player is configured — send software/CEC off"
            conditions:
              - condition: template
                value_template: "{{ tv_entity | default('') | string not in ['', 'none', 'None'] }}"
            sequence:
              - alias: "Stop the TV via media_player — CEC/software shutdown"
                action: media_player.turn_off
                target:
                  entity_id: "{{ tv_entity }}"

      - alias: "Wait for CEC state to propagate before IR check"
        delay:
          seconds: 2

      - alias: "TV shutdown — fire custom off script (skipped if no script configured)"
        choose:
          - alias: "TV off script is configured — fire it"
            conditions:
              - condition: template
                value_template: "{{ tv_off_script | default('') | string not in ['', 'none', 'None'] }}"
            sequence:
              - alias: "Fire the user's TV off script — handles IR sequences, delays, etc."
                action: script.turn_on
                target:
                  entity_id: "{{ tv_off_script }}"

      - alias: "TV shutdown — IR remote power-off (skipped if no remote configured, or TV already off)"
        choose:
          - alias: "IR remote is configured AND TV not already off — send power-off command"
            conditions:
              - condition: template
                alias: "IR remote entity is configured"
                value_template: "{{ tv_ir_remote | default('') | string not in ['', 'none', 'None'] }}"
              - condition: template
                alias: "TV state guard — skip IR if CEC reports off/standby (fail-open if no CEC entity)"
                value_template: >-
                  {% set tv = tv_entity | default('') | string %}
                  {% if tv in ['', 'none', 'None'] %}
                    true
                  {% else %}
                    {{ states(tv) not in ['off', 'standby', 'unavailable'] }}
                  {% endif %}
            sequence:
              - alias: "Send IR power-off command via remote.send_command"
                action: remote.send_command
                target:
                  entity_id: "{{ tv_ir_remote }}"
                data:
                  device: "{{ tv_ir_device }}"
                  command: "{{ tv_ir_command | default('Power') }}"

      # --- Stop additional media players (legacy stop behavior) ---
      - alias: "Stop additional media players — Chromecast, Sonos, MA players, etc. (skipped if none configured)"
        choose:
          - alias: "Media players to stop are configured"
            conditions:
              - condition: template
                value_template: >-
                  {{ media_players_stop_val is mapping
                     and (media_players_stop_val.get('entity_id', []) | length > 0
                          or media_players_stop_val.get('area_id', []) | length > 0
                          or media_players_stop_val.get('label_id', []) | length > 0) }}
            sequence:
              - alias: "Stop playback on selected media players"
                action: media_player.media_stop
                target: !input media_players_stop
                continue_on_error: true

      # --- Kill lights except the living room lamp ---
      - alias: "Turn off targeted lights/switches — lamp stays on for the countdown"
        action: homeassistant.turn_off
        target: !input lights_off_target

      - alias: "Ensure the living room lamp is ON — nightlight during the countdown"
        action: homeassistant.turn_on
        target:
          entity_id: "{{ living_room_lamp }}"

      # --- LLM bedtime announcement + countdown negotiation ---
      - alias: "Generate bedtime announcement via conversation agent"
        continue_on_error: true
        action: conversation.process
        response_variable: bedtime_response
        data:
          agent_id: "{{ conversation_agent }}"
          text: "{{ bedtime_prompt_tpl }}"

      - alias: "Extract bedtime announcement with defensive fallback"
        variables:
          bedtime_message: >-
            {% if bedtime_response is defined
               and bedtime_response.response is defined
               and bedtime_response.response.response_type | default('') != 'error'
               and bedtime_response.response.speech is defined %}
              {{ bedtime_response.response.speech.plain.speech
                 | default("Time for bed. Lights out in " ~ default_countdown ~ " minutes.") }}
            {% else %}
              Time for bed. Lights out in {{ default_countdown }} minutes.
            {% endif %}

      - alias: "Deliver bedtime announcement and open conversation — agent handles negotiation via exposed scripts"
        choose:
          - alias: "Countdown negotiation enabled — start interactive conversation"
            conditions:
              - condition: template
                value_template: "{{ enable_negotiation }}"
            sequence:
              - alias: "Start conversation on satellites — agent can negotiate countdown via voice_set_bedtime_countdown script"
                continue_on_error: true
                action: assist_satellite.start_conversation
                target: !input assist_satellites
                data:
                  preannounce: true
                  start_message: "{{ bedtime_message }}"
                  extra_system_prompt: >-
                    Bedtime routine active. Default countdown: {{ default_countdown }} minutes.
                    The user may ask for more time. Use the voice_set_bedtime_countdown tool
                    to change the countdown (min 1, max 15 minutes). Current lamp entity:
                    {{ living_room_lamp }}. Bathroom sensor: {{ bathroom_sensor }}.

              - alias: "Wait for conversation to settle — agent has had time to set the countdown helper"
                delay:
                  seconds: "{{ post_tts_delay_val }}"

        default:
          - alias: "Negotiation disabled — just announce via TTS, no conversation"
            choose:
              - alias: "TTS with voice profile (ElevenLabs)"
                conditions:
                  - condition: template
                    value_template: "{{ voice_profile_val | default('') | string | length > 0 }}"
                sequence:
                  - alias: "Speak bedtime announcement with custom voice profile"
                    action: tts.speak
                    target:
                      entity_id: "{{ tts_engine_entity }}"
                    data:
                      media_player_entity_id: "{{ audiobook_player }}"
                      message: "{{ bedtime_message }}"
                      options:
                        voice_profile: "{{ voice_profile_val }}"
            default:
              - alias: "Speak bedtime announcement with default TTS voice"
                action: tts.speak
                target:
                  entity_id: "{{ tts_engine_entity }}"
                data:
                  media_player_entity_id: "{{ audiobook_player }}"
                  message: "{{ bedtime_message }}"

          - alias: "Post-TTS buffer — let streaming audio finish"
            delay:
              seconds: "{{ post_tts_delay_val }}"

      # --- Re-read countdown — agent may have changed it ---
      - alias: "Re-read countdown helper — the agent may have negotiated a different value"
        variables:
          final_countdown: >-
            {{ states(countdown_helper) | int(default_countdown) }}

      # --- Audiobook offer (conditional) ---
      - alias: "Audiobook offer — skip entirely if feature is disabled"
        choose:
          - alias: "Audiobook offer enabled — ask via LLM"
            conditions:
              - condition: template
                value_template: "{{ enable_audiobook }}"
            sequence:
              - alias: "Build audiobook prompt based on selection mode"
                variables:
                  audiobook_prompt: >-
                    {% if audiobook_mode == 'curated' %}
                      Ask if they want a bedtime audiobook. Offer ONLY these choices: {{ curated_list }}.
                      If they decline, say okay. If they pick one, use the voice_play_bedtime_audiobook tool
                      with exactly the title they chose. If they want none, just acknowledge and move on.
                    {% elif audiobook_mode == 'freeform' %}
                      Ask if they want a bedtime audiobook. Let them request anything — a title, author, or genre.
                      Use the voice_play_bedtime_audiobook tool with whatever they ask for.
                      If they decline, just acknowledge and move on.
                    {% else %}
                      Ask if they want a bedtime audiobook. Offer these favorites: {{ curated_list }}.
                      But also accept any other request — if they want something not on the list, that's fine.
                      Use the voice_play_bedtime_audiobook tool with their choice.
                      If they decline, just acknowledge and move on.
                    {% endif %}

              - alias: "Pause before audiobook — let satellite fully close the previous conversation"
                delay:
                  seconds: 3

              - alias: "Start audiobook conversation — agent uses exposed scripts for playback control"
                continue_on_error: true
                action: assist_satellite.start_conversation
                target: !input assist_satellites
                data:
                  preannounce: true
                  start_message: >-
                    {% if audiobook_mode == 'freeform' %}
                      Would you like a bedtime audiobook? You can ask for anything.
                    {% elif curated_list | default('') | length > 0 %}
                      Would you like a bedtime audiobook? I've got {{ curated_list }} — or ask for something else.
                    {% else %}
                      Would you like a bedtime audiobook?
                    {% endif %}
                  extra_system_prompt: >-
                    {{ audiobook_prompt }}
                    The audiobook player is {{ audiobook_player }}.
                    Media type for search: {{ audiobook_media_type }}.
                    Volume: {{ audiobook_volume }}.

              - alias: "Wait for audiobook conversation to settle — satellite needs time for the full exchange"
                delay:
                  seconds: 30

      # --- Goodnight message (conversational modes only) ---
      - alias: "Generate goodnight message via conversation agent"
        continue_on_error: true
        action: conversation.process
        response_variable: goodnight_response
        data:
          agent_id: "{{ conversation_agent }}"
          text: "{{ goodnight_prompt_tpl }}"

      - alias: "Extract goodnight message with defensive fallback"
        variables:
          goodnight_message: >-
            {% if goodnight_response is defined
               and goodnight_response.response is defined
               and goodnight_response.response.response_type | default('') != 'error'
               and goodnight_response.response.speech is defined %}
              {{ goodnight_response.response.speech.plain.speech
                 | default("Goodnight. Sleep well.") }}
            {% else %}
              Goodnight. Sleep well.
            {% endif %}

      - alias: "Deliver goodnight via TTS"
        choose:
          - alias: "TTS with voice profile (ElevenLabs)"
            conditions:
              - condition: template
                value_template: "{{ voice_profile_val | default('') | string | length > 0 }}"
            sequence:
              - alias: "Speak goodnight message with custom voice profile"
                action: tts.speak
                target:
                  entity_id: "{{ tts_engine_entity }}"
                data:
                  media_player_entity_id: "{{ audiobook_player }}"
                  message: "{{ goodnight_message }}"
                  options:
                    voice_profile: "{{ voice_profile_val }}"
        default:
          - alias: "Speak goodnight message with default TTS voice"
            action: tts.speak
            target:
              entity_id: "{{ tts_engine_entity }}"
            data:
              media_player_entity_id: "{{ audiobook_player }}"
              message: "{{ goodnight_message }}"

      - alias: "Post-TTS buffer — let goodnight finish playing"
        delay:
          seconds: "{{ post_tts_delay_val }}"

      # --- Countdown — wait the negotiated duration ---
      - alias: "Wait the negotiated countdown — lamp stays on, user goes to bed"
        delay:
          minutes: "{{ final_countdown | int(default_countdown) }}"

      # --- Bathroom guard ---
      - alias: "Bathroom guard — check if bathroom is currently occupied"
        choose:
          - alias: "Bathroom occupied — wait for it to clear before turning off lamp"
            conditions:
              - condition: state
                entity_id: !input bathroom_sensor
                state: "on"
            sequence:
              - alias: "Wait for bathroom sensor to clear — max timeout prevents infinite wait"
                wait_for_trigger:
                  - trigger: state
                    entity_id: !input bathroom_sensor
                    to: "off"
                timeout: !input bathroom_max_timeout
                continue_on_timeout: true

              - alias: "Handle bathroom guard timeout — lights off regardless, can't wait forever"
                if:
                  - condition: template
                    value_template: "{{ not wait.completed }}"
                then:
                  - alias: "Bathroom guard timed out — proceeding with lamp off anyway"
                    action: logbook.log
                    data:
                      name: "Bedtime Routine"
                      message: >-
                        Bathroom guard timed out after max wait. Turning off lamp regardless.
                else:
                  - alias: "Bathroom cleared — grace period before turning off lamp"
                    delay: !input bathroom_grace_period

        default:
          - alias: "Bathroom not occupied — check it's been clear long enough"
            choose:
              - alias: "Bathroom was recently occupied — enforce grace period"
                conditions:
                  - condition: state
                    entity_id: !input bathroom_sensor
                    state: "off"
                    for: !input bathroom_grace_period
                sequence:
                  - alias: "Grace period already satisfied — proceed to lamp off"
                    action: logbook.log
                    data:
                      name: "Bedtime Routine"
                      message: "Bathroom clear and grace period satisfied. Turning off lamp."
            default:
              - alias: "Bathroom recently cleared — wait remaining grace period"
                delay: !input bathroom_grace_period

  # --- Common tail (both modes) — lamp off + cleanup ----------------------------

  - alias: "Lights out — turn off the living room lamp"
    action: homeassistant.turn_off
    target:
      entity_id: "{{ living_room_lamp }}"

  - alias: "Cleanup — turn off temporary switches"
    action: homeassistant.turn_off
    target: !input temporary_switches

  - alias: "Reset countdown helper to default for next run"
    action: input_number.set_value
    target:
      entity_id: !input countdown_helper
    data:
      value: "{{ default_countdown }}"

# ═══════════════════════════════════════════════════════════════════════
# Mode — single, no overlapping bedtime runs
# ═══════════════════════════════════════════════════════════════════════
mode: single

trace:
  stored_traces: 15
