blueprint:
  name: "Proactive – Presence-based suggestions (v5 – direct LLM)"
  author: madalone
  description: >
    ![Image](https://raw.githubusercontent.com/mmadalone/HA-Master-Repo/main/images/header/proactive_llm-header.jpeg)

    # Proactive – Presence-based suggestions

    When presence is detected in an area during a configured time window,
    proactively speaks a message via TTS. Messages are generated on the
    fly by a Conversation / LLM agent (OpenAI Conversation, Extended
    OpenAI Conversation, Llama, etc.) using a prompt you configure in
    this automation. Includes a configurable cooldown to avoid spam,
    optional repeated nagging while you're present, support for both
    standard TTS entities (tts.speak) and the ElevenLabs custom
    integration (tts.elevenlabs_custom_tts with voice_profile), and an
    optional bedtime yes/no question via an Assist Satellite (Voice
    Preview) that can call a bedtime script when you say yes.

    ### Recent changes
    - **v5:** Style guide compliance — collapsible inputs, modern syntax, aliases
    - **v4:** Direct LLM generation with conversation.process
    - **v3:** Added bedtime yes/no question via Assist Satellite
  domain: automation
  homeassistant:
    min_version: "2024.10.0"

  input:
    # ===========================================================================
    # ① PRESENCE & SCHEDULE
    # ===========================================================================
    presence_schedule:
      name: "① Presence & schedule"
      icon: mdi:motion-sensor
      description: Configure presence detection and the active time window.
      input:
        presence_sensors:
          name: Presence sensors for this area
          description: >
            One or more binary sensors that indicate presence in this area
            (e.g. FP2 room groups for Living room, Workshop, etc.).
            The automation will fire when ANY of these is used as a trigger.
          selector:
            entity:
              domain: binary_sensor
              multiple: true

        start_time:
          name: Active from
          description: >
            Start time of the daily window where allowed to be
            proactive in this area.
          default: "08:00:00"
          selector:
            time: {}

        end_time:
          name: Active until
          description: >
            End time of the daily window where allowed to be
            proactive in this area. Can be earlier than "Active from" to
            create a window that crosses midnight (e.g. 23:00 → 02:00).
          default: "23:00:00"
          selector:
            time: {}

    # ===========================================================================
    # ② SPEAKER & TTS
    # ===========================================================================
    speaker_tts:
      name: "② Speaker & TTS"
      icon: mdi:speaker-message
      description: Configure the speaker and TTS integration for announcements.
      input:
        media_player:
          name: Speaker / media player to speak from
          description: >
            Media player that should talk in this area.
            Can be a Home Assistant Voice Preview speaker, Sonos, etc.
          selector:
            entity:
              domain: media_player

        tts_mode:
          name: TTS mode
          description: >
            Choose which TTS integration to use:
            - "standard_tts_entity": Any normal tts.speak entity
            - "elevenlabs_custom_service": ElevenLabs custom service
              using options.voice_profile
          default: standard_tts_entity
          selector:
            select:
              options:
                - standard_tts_entity
                - elevenlabs_custom_service

        tts_entity:
          name: TTS entity to use with tts.speak
          description: >
            TTS entity used by tts.speak.
            Examples:
            - For official ElevenLabs: tts.elevenlabs
            - For custom 11Labs: tts.elevenlabs_custom_tts
            - Any other TTS entity also works.
          selector:
            entity:
              domain: tts

        elevenlabs_voice_profile:
          name: ElevenLabs voice profile (for custom mode)
          description: >
            Only used when TTS mode is "elevenlabs_custom_service".
            Voice profile name/ID for the ElevenLabs custom integration,
            e.g. "Quark - Custom 11". Should match your working
            tts.speak options.voice_profile.
          default: ""
          selector:
            text:
              multiline: false

    # ===========================================================================
    # ③ AI / LLM
    # ===========================================================================
    ai_llm:
      name: "③ AI / LLM"
      icon: mdi:robot
      description: Configure the conversation agent and prompt style.
      input:
        conversation_agent:
          name: Conversation / LLM agent
          description: >
            Conversation agent that will generate the proactive sentence and,
            optionally, the bedtime question. This can be OpenAI Conversation,
            Extended OpenAI Conversation, Llama, or any other conversation
            agent that supports the conversation.process action.
          selector:
            conversation_agent:

        area_name:
          name: Area name (for the message)
          description: >
            Friendly name of this area for it to mention in speech.
            This is a menu with common room names, but you can also type
            your own value. Used in fallback messages and can be referenced
            in AI-generated text.
          default: Workshop
          selector:
            select:
              options:
                - Workshop
                - Living room
                - Bedroom
                - Office
                - Kitchen
                - Bathroom
              custom_value: true

        llm_prompt:
          name: LLM prompt / style for proactive messages
          description: >
            Instructions for how the AI should talk when generating the
            proactive presence-based line. This will be combined with the
            area name and time of day and sent to the selected conversation
            agent. Keep it short; this blueprint will still ask for ONE
            short sentence.
          default: >
            You are Quark from Star Trek: Deep Space Nine acting as Miquel's
            smart home. Reply with ONE short, playful sentence you would say
            out loud to Miquel in this area right now, maximum 220 characters
            and without quotation marks.
          selector:
            text:
              multiline: true

    # ===========================================================================
    # ④ NAGGING BEHAVIOR
    # ===========================================================================
    nagging_behavior:
      name: "④ Nagging behavior"
      icon: mdi:repeat
      description: Cooldown, repeat nagging, and session limits.
      input:
        cooldown_minutes:
          name: Cooldown / nag interval (minutes)
          description: >
            Minimum time between proactive messages in this area. When
            'Keep nagging while present' is enabled, this acts as the nag
            interval while presence is on. Default is 30 minutes.
          default: 30
          selector:
            number:
              min: 1
              max: 240
              step: 1
              unit_of_measurement: "min"

        repeat_while_present:
          name: Keep nagging while present
          description: >
            If enabled, will keep nagging at the chosen interval
            (cooldown) as long as at least one presence sensor is on within
            the active time window. If disabled, it only speaks when presence
            turns on (until you leave and re-enter).
          default: false
          selector:
            boolean: {}

        max_nags_per_session:
          name: Max nags per presence session (0 = unlimited)
          description: >
            Only used when 'Keep nagging while present' is enabled.
            Limits how long it can keep nagging while presence stays on.
            The session start is approximated as the earliest last_changed
            among the ON sensors; max session duration =
            cooldown_minutes * max_nags_per_session.
            Set to 0 for unlimited nags while present.
          default: 3
          selector:
            number:
              min: 0
              max: 48
              step: 1

    # ===========================================================================
    # ⑤ BEDTIME FEATURE
    # ===========================================================================
    bedtime_feature:
      name: "⑤ Bedtime feature"
      icon: mdi:bed
      description: Optional bedtime yes/no question via Assist Satellite.
      input:
        enable_bedtime_question:
          name: Ask if you want help going to bed
          description: >
            If enabled, after it speaks it will also ask a yes/no bedtime
            question on the selected Assist Satellite (Voice Preview). The
            wording of this question is generated by the LLM using the
            bedtime prompt below; if you answer YES, an optional bedtime
            script can be run.
          default: false
          selector:
            boolean: {}

        bedtime_assist_satellite:
          name: Assist Satellite for bedtime question
          description: >
            Assist Satellite (Voice Preview) entity that should ask the
            bedtime question. Typically the satellite in the same area as
            the media player.
          selector:
            entity:
              domain: assist_satellite

        bedtime_llm_prompt:
          name: Bedtime LLM prompt / style
          description: >
            Instructions for how the AI should phrase the bedtime question.
            The blueprint will ask the LLM to produce one short yes/no
            question about going to bed or starting your bedtime routine.
          default: >
            You are Quark speaking to Miquel at bedtime. Ask ONE short yes/no
            question to check if he wants to go to bed now or start his
            bedtime routine. Maximum 200 characters, no quotation marks.
          selector:
            text:
              multiline: true

        bedtime_question_text:
          name: Fallback bedtime question text
          description: >
            Fallback text for the bedtime question if the LLM fails to
            generate one or returns an empty answer. Should be a short
            yes/no question like "Miquel, do you want me to help you go to
            bed now?".
          default: "Miquel, do you want me to help you go to bed now?"
          selector:
            text:
              multiline: true

        bedtime_question_delay:
          name: Delay between evening message and bedtime question (seconds)
          description: >
            How long to wait after the proactive TTS message before asking
            the bedtime question. Needed because some TTS integrations
            (like ElevenLabs) may still be playing audio even when the media
            player looks idle.
          default: 5
          selector:
            number:
              min: 0
              max: 30
              unit_of_measurement: seconds
              mode: slider
              step: 1

        bedtime_help_script:
          name: Script to run when you say yes
          description: >
            Script that will be called when the bedtime question is answered
            with YES. This should be your 'put me to bed' routine. You will
            create this script separately (e.g. via a script blueprint) and
            then select it here. Leave empty if you are not using the bedtime
            script feature.
          default:
          selector:
            entity:
              domain: script

mode: single
max_exceeded: silent

variables:
  cooldown: !input cooldown_minutes
  presence_entities: !input presence_sensors
  repeat_while_present: !input repeat_while_present
  max_nags_per_session: !input max_nags_per_session

  enable_bedtime_question: !input enable_bedtime_question
  bedtime_assist_satellite: !input bedtime_assist_satellite
  bedtime_question_text: !input bedtime_question_text
  bedtime_help_script: !input bedtime_help_script
  bedtime_question_delay: !input bedtime_question_delay
  bedtime_llm_prompt: !input bedtime_llm_prompt

triggers:
  - alias: "Presence on — first nag when someone enters"
    trigger: state
    entity_id: !input presence_sensors
    from: "off"
    to: "on"

  - alias: "Periodic tick — repeat nag check every minute"
    trigger: time_pattern
    minutes: "/1"

conditions:
  - alias: "Time window — only during active hours"
    condition: time
    after: !input start_time
    before: !input end_time

  - condition: template
    alias: "Presence still detected"
    value_template: >
      {% set sensors = presence_entities %}
      {{ expand(sensors) | selectattr('state', 'eq', 'on') | list | length > 0 }}

  - condition: template
    alias: "Trigger allowed by repeat mode"
    value_template: >
      {% if not repeat_while_present and trigger.platform == 'time_pattern' %}
        false
      {% else %}
        true
      {% endif %}

  - condition: template
    alias: "Cooldown + max nags per session"
    value_template: >
      {% set mins = cooldown | int %}
      {% set max_nags = max_nags_per_session | int %}
      {% set last = this.attributes.last_triggered %}
      {% set enough_time = last is none
        or (as_timestamp(now()) - as_timestamp(last)) > (mins * 60) %}
      {% if not enough_time %}
        false
      {% elif max_nags == 0 %}
        true
      {% else %}
        {% set sensors = presence_entities %}
        {% set on_sensors = expand(sensors)
          | selectattr('state', 'eq', 'on') | list %}
        {% if on_sensors | length == 0 %}
          true
        {% else %}
          {% set session_start = (on_sensors
              | map(attribute='last_changed') | min) %}
          {% set max_duration = max_nags * mins * 60 %}
          {{ (as_timestamp(now()) - as_timestamp(session_start)) < max_duration }}
        {% endif %}
      {% endif %}

actions:
  - alias: "Resolve inputs into action-scoped variables"
    variables:
      player: !input media_player
      tts_mode: !input tts_mode
      tts_entity: !input tts_entity
      area_name: !input area_name
      voice_profile: !input elevenlabs_voice_profile
      llm_prompt: !input llm_prompt

      tod_label: >
        {% if enable_bedtime_question %}
          evening
        {% else %}
          {% set h = now().hour %}
          {% if 5 <= h < 12 %}
            morning
          {% elif 12 <= h < 18 %}
            afternoon
          {% else %}
            evening
          {% endif %}
        {% endif %}

  - alias: "Generate proactive message with conversation / LLM agent"
    action: conversation.process
    data:
      agent_id: !input conversation_agent
      text: >
        {{ llm_prompt }}

        context:
        - area: {{ area_name }}
        - time_of_day: {{ tod_label }}
        - trigger_type: {{ trigger.platform }}
        - current_time: {{ now().strftime('%Y-%m-%d %H:%M') }}

        task:
        respond with ONE short, natural sentence you would say out loud to Miquel
        in this situation. maximum 220 characters. do not include quotation marks
        or any surrounding formatting.
    response_variable: ai_result

  - alias: "Parse LLM response with fallback message"
    variables:
      proactive_message: >
        {% set resp = ai_result.response if ai_result is defined else none %}

        {% set fallback %}
          {% if tod_label == 'morning' %}
            good {{ tod_label }} in the {{ area_name }}, you just stepped in. want me to start your usual chaos.. i mean, music?
          {% elif tod_label == 'afternoon' %}
            back in the {{ area_name }}, huh? need me to resume your tunes or handle something for you?
          {% else %}
            it's {{ tod_label }} in the {{ area_name }}. i can play something relaxing or set the mood if you want.
          {% endif %}
        {% endset %}

        {% if resp is not none
              and resp.speech is defined
              and resp.speech.plain is defined
              and resp.speech.plain.speech is defined %}
          {% set txt = resp.speech.plain.speech | trim %}
          {% if not txt %}
            {{ fallback | trim }}
          {% else %}
            {{ txt }}
          {% endif %}
        {% else %}
          {{ fallback | trim }}
        {% endif %}

  - alias: "Route TTS — choose integration based on tts_mode"
    choose:
      - alias: "ElevenLabs custom service path"
        conditions:
          - condition: template
            value_template: "{{ tts_mode == 'elevenlabs_custom_service' }}"
        sequence:
          - alias: "Speak proactive message via ElevenLabs"
            action: tts.speak
            target:
              entity_id: "{{ tts_entity }}"
            data:
              message: "{{ proactive_message }}"
              media_player_entity_id: "{{ player }}"
              options:
                voice_profile: "{{ voice_profile }}"

      - alias: "Standard TTS entity path"
        conditions:
          - condition: template
            value_template: "{{ tts_mode == 'standard_tts_entity' }}"
        sequence:
          - alias: "Speak proactive message via standard TTS"
            action: tts.speak
            target:
              entity_id: "{{ tts_entity }}"
            data:
              message: "{{ proactive_message }}"
              media_player_entity_id: "{{ player }}"

  - alias: "Bedtime question gate — only if feature enabled"
    if:
      - condition: template
        value_template: "{{ enable_bedtime_question }}"
    then:
      - alias: "Post-TTS delay — wait for audio to finish before asking question"
        delay:
          seconds: "{{ bedtime_question_delay | int }}"

      - alias: "Generate bedtime question with conversation / LLM agent"
        action: conversation.process
        data:
          agent_id: !input conversation_agent
          text: >
            {{ bedtime_llm_prompt }}

            context:
            - area: {{ area_name }}
            - current_time: {{ now().strftime('%Y-%m-%d %H:%M') }}

            task:
            respond with ONE short yes/no question to ask miquel about whether
            he wants to go to bed now or start his bedtime routine.
            maximum 200 characters. do not include quotation marks.
        response_variable: bedtime_llm_result

      - alias: "Parse bedtime LLM response with fallback text"
        variables:
          final_bedtime_question: >
            {% set resp = bedtime_llm_result.response if bedtime_llm_result is defined else none %}
            {% if resp is not none
                  and resp.speech is defined
                  and resp.speech.plain is defined
                  and resp.speech.plain.speech is defined %}
              {% set txt = resp.speech.plain.speech | trim %}
              {% if txt %}
                {{ txt }}
              {% else %}
                {{ bedtime_question_text }}
              {% endif %}
            {% else %}
              {{ bedtime_question_text }}
            {% endif %}

      - alias: "Ask bedtime yes/no question via satellite"
        action: assist_satellite.ask_question
        continue_on_error: true
        data:
          entity_id: "{{ bedtime_assist_satellite }}"
          question: "{{ final_bedtime_question }}"
          answers:
            - id: "yes"
              sentences:
                - "yes"
                - "yeah"
                - "sure"
                - "ok"
                - "okay"
                - "please"
            - id: "no"
              sentences:
                - "no"
                - "no thanks"
                - "not now"
                - "cancel"
        response_variable: bedtime_answer

      - alias: "Handle bedtime answer — run script if yes"
        choose:
          - conditions:
              - condition: template
                value_template: >
                  {{ bedtime_answer is defined
                     and bedtime_answer.id == 'yes'
                     and bedtime_help_script is not none
                     and bedtime_help_script != '' }}
            sequence:
              - alias: "Run bedtime help script"
                action: script.turn_on
                target:
                  entity_id: "{{ bedtime_help_script }}"
