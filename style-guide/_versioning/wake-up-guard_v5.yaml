blueprint:
  name: "Wake-up guard – Snooze/Stop with TTS & mobile"
  author: madalone
  description: >
    ![Wake-up guard header](/local/blueprint-images/wake-up-guard-header.jpg)

    # Wake-up guard

    Time-based wake-up with bed/workshop presence conditions, TTS announcements
    (static or LLM-generated), one snooze, mobile push with Snooze/Stop buttons,
    optional Assist Satellite TTS interrupt, and a music handoff script.

    ### Flow

    1. Fires at wake-up time on selected weekdays.
    2. Checks bed presence duration and workshop emptiness duration.
    3. Optionally turns on switches/lights.
    4. Prepares wake-up message (static or LLM).
    5. Optional mobile notification with Snooze/Stop.
    6. TTS announcement → wait for Snooze/Stop/timeout.
    7. If Snooze: pause, then repeat TTS + wait once more (second snooze = Stop).
    8. If Stop or final timeout: run music script, restore volume, clean up.

    ### Recent changes

    - **v5:** Added trigger ID. Stripped redundant numbered comments — aliases
      are the primary documentation now. Added template justification comment
      on weekday condition. Added runtime validation warning on notify_service.
    - **v4:** Replaced hardcoded helper script calls with configurable inputs.
      Added `person_display_name` input for notification messages.
      Added selector documentation comments.
    - **v3:** Extracted TTS routing and stop-cleanup into helper scripts
      (`script.wake_guard_tts_speak`, `script.wake_guard_stop_cleanup`).
      Changed `llm_agent_id` to `conversation_agent` selector.
      Added description image.
    - **v2:** Fixed bed/workshop duration checks (were broken — only checked current
      state, not duration). Added collapsible input sections. Migrated service → action.
      Fixed toggle cleanup on default path.

  domain: automation
  homeassistant:
    min_version: 2024.6.0

  input:
    # ── Stage 1 — Schedule & Presence ──────────────────────────────────
    stage_1_schedule:
      name: "Stage 1 — Schedule & presence"
      icon: mdi:calendar-clock
      description: >
        When the wake-up fires and what presence conditions must be met.
      input:
        active_days:
          name: Active weekdays
          description: >
            Days on which this wake-up should run. Only fires on selected days.
          default:
            - mon
            - tue
            - wed
            - thu
            - fri
          selector:
            select:
              multiple: true
              mode: list
              options:
                - label: Monday
                  value: mon
                - label: Tuesday
                  value: tue
                - label: Wednesday
                  value: wed
                - label: Thursday
                  value: thu
                - label: Friday
                  value: fri
                - label: Saturday
                  value: sat
                - label: Sunday
                  value: sun

        wakeup_time:
          name: Wake-up time
          description: >
            Time at which the wake-up guard fires. Combined with active weekdays
            to determine when the automation triggers.
          selector:
            time: {}

        bed_presence_sensors:
          name: Bed presence sensors
          description: >
            One or more binary sensors that are ON when you are in bed (e.g. mmWave
            bed presence). ALL must have been continuously ON for at least the
            configured minimum minutes before wake-up time.
          selector:
            entity:
              multiple: true
              domain: binary_sensor

        min_bed_minutes:
          name: Minutes in bed before wake-up
          description: >
            How many minutes ALL bed presence sensors must have been continuously ON
            before the wake-up time. This prevents false triggers if you just sat on
            the bed briefly. Uses last_changed to verify actual duration.
          default: 30
          selector:
            number:
              min: 1
              max: 240
              unit_of_measurement: min
              mode: slider

        workshop_presence_sensors:
          name: Workshop / living room presence sensors
          description: >
            One or more presence sensors for areas you'd be in if already awake.
            ALL must have been continuously OFF for the configured minimum minutes.
            Leave empty to skip this check entirely.
          default: []
          selector:
            entity:
              multiple: true
              domain: binary_sensor

        min_workshop_empty_minutes:
          name: Minutes workshop must have been empty
          description: >
            How many minutes ALL workshop sensors must have been continuously OFF
            before the wake-up time. Prevents firing if you're already up and about.
            Uses last_changed to verify actual duration.
          default: 15
          selector:
            number:
              min: 1
              max: 180
              unit_of_measurement: min
              mode: slider

    # ── Stage 2 — Lights & Switches ───────────────────────────────────
    stage_2_devices:
      name: "Stage 2 — Lights & switches"
      icon: mdi:lightbulb-on
      description: >
        Optional devices to turn on when the wake-up fires, and off during snooze.
      input:
        workshop_switches:
          name: Switches to turn on at wake-up
          description: >
            Optional switches (e.g. smart plugs, lamps) to turn ON when the wake-up
            triggers. Turned OFF during snooze, back ON after. Leave empty to skip.
          default: []
          selector:
            entity:
              domain: switch
              multiple: true

        workshop_lights:
          name: Lights to turn on at wake-up
          description: >
            Optional lights to turn ON when the wake-up triggers. Turned OFF during
            snooze, back ON after. Leave empty to skip.
          default: []
          selector:
            entity:
              domain: light
              multiple: true

    # ── Stage 3 — TTS & Voice ─────────────────────────────────────────
    stage_3_tts:
      name: "Stage 3 — TTS & voice output"
      icon: mdi:account-voice
      description: >
        TTS engine, output speaker, volume levels, and ElevenLabs voice profile.
      input:
        tts_engine:
          name: TTS entity
          description: >
            TTS entity used for the wake-up announcement. If this is exactly
            tts.elevenlabs_custom_tts (HACS custom integration), the blueprint
            passes the voice profile string via options.voice_profile.
          selector:
            entity:
              domain: tts

        tts_output_player:
          name: Media player for TTS output
          description: >
            Speaker or speaker group where TTS will play.
          selector:
            entity:
              domain: media_player

        tts_volume_before:
          name: Volume before TTS
          description: >
            Volume level set on the TTS player BEFORE the wake-up announcement.
          default: 0.4
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        tts_volume_after:
          name: Volume after flow completes
          description: >
            Volume level restored on the TTS player AFTER the entire wake-up flow
            completes (Stop, snooze timeout, or music handoff).
          default: 0.4
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        stop_restore_delay:
          name: Delay before restoring volume on Stop
          description: >
            Seconds to wait before restoring TTS player volume after Stop. Prevents
            restoring volume while TTS audio is still draining from the buffer.
          default: 1
          selector:
            number:
              min: 0
              max: 30
              unit_of_measurement: s
              mode: slider

        tts_voice_profile:
          name: ElevenLabs Custom voice profile
          description: >
            ONLY used when TTS entity is exactly tts.elevenlabs_custom_tts (HACS
            custom integration). Passed as options.voice_profile. Ignored for all
            other TTS entities.
          default: "Wake-up voice profile"
          selector:
            text: {}

    # ── Stage 4 — Wake-up Message ─────────────────────────────────────
    stage_4_message:
      name: "Stage 4 — Wake-up message"
      icon: mdi:robot-outline
      description: >
        Static fallback message or LLM-generated wake-up rant.
      input:
        tts_message:
          name: Static wake-up message (fallback)
          description: >
            Static message text used when LLM generation is disabled or when
            the LLM call fails. Always have a sensible fallback here.
          default: "good morning miquel, time to get up."
          selector:
            text:
              multiline: true

        use_llm_wake_message:
          name: Generate message with LLM
          description: >
            If enabled, the wake-up message is generated on the fly by the
            conversation agent below. If disabled or the LLM call fails,
            falls back to the static message above.
          default: false
          selector:
            boolean: {}

        llm_agent_id:
          name: Conversation agent
          description: >
            The conversation agent used to generate the wake-up message via
            conversation.process. Leave empty to always use the static message.
          default: ""
          selector:
            conversation_agent: {}

        llm_wake_prompt:
          name: LLM prompt
          description: >
            Prompt sent to the conversation agent to generate the wake-up rant.
            The blueprint appends the snooze/stop window duration automatically
            so the LLM can calibrate message length.
          default: >-
            you are a sarcastic but supportive assistant waking miquel up. make a
            single, continuous rant that roughly fits within the snooze/stop window,
            is annoying but not genuinely cruel, and ends with a clear call to get
            out of bed now.
          selector:
            text:
              multiline: true

    # ── Stage 5 — Snooze/Stop Controls ────────────────────────────────
    stage_5_controls:
      name: "Stage 5 — Snooze/Stop controls"
      icon: mdi:alarm-snooze
      description: >
        Control toggles, music handoff, and timing for snooze/stop behavior.
      input:
        snooze_toggle:
          name: Snooze toggle (input_boolean)
          description: >
            Boolean helper used as the Snooze control flag. This blueprint turns it
            ON when snooze is triggered via mobile notification. Can also be driven
            from a dashboard button or another automation.
          selector:
            entity:
              domain: input_boolean

        stop_toggle:
          name: Stop toggle (input_boolean)
          description: >
            Boolean helper used as the Stop control flag. This blueprint turns it
            ON when stop is triggered via mobile notification. Can also be driven
            from a dashboard button or another automation.
          selector:
            entity:
              domain: input_boolean

        music_script:
          name: Wake-up music script
          description: >
            Script that starts your wake-up music or hands off to your music
            helper logic. Called when the snooze/stop window times out without
            user intervention.
          selector:
            entity:
              domain: script

        post_tts_timeout:
          name: Snooze/Stop window after TTS (seconds)
          description: >
            Seconds after TTS starts during which Snooze/Stop presses are
            listened for. If nothing is pressed, the automation proceeds to
            the music script.
          default: 40
          selector:
            number:
              min: 1
              max: 600
              unit_of_measurement: s
              mode: slider

        snooze_minutes:
          name: Snooze duration (minutes)
          description: >
            Minutes to wait during snooze before repeating the TTS announcement.
            Only ONE snooze is allowed — a second snooze press is treated as Stop.
          default: 7
          selector:
            number:
              min: 1
              max: 60
              unit_of_measurement: min
              mode: slider

    # ── Stage 6 — Optional Integrations ───────────────────────────────
    stage_6_optional:
      name: "Stage 6 — Optional integrations"
      icon: mdi:puzzle-outline
      description: >
        Mobile notifications, Assist Satellite, person name, and companion
        helper scripts. All have sensible defaults.
      input:
        person_display_name:
          name: Person display name
          description: >
            Name used in notification messages (e.g. "time to get up, miquel").
            Change this to the name of the person being woken up.
          default: "miquel"
          selector:
            text: {}

        # NOTE: text selector used because HA blueprints have no native
        # notify-service selector. The value is injected as a dynamic action
        # via `action: !input notify_service`, so load-time validation is
        # not possible — a bad value will only fail at runtime.
        notify_service:
          name: Mobile notify service
          description: >
            Notify service for mobile push with Snooze/Stop buttons (e.g.
            notify.mobile_app_miquel). Leave empty to skip mobile notifications.
            The notification uses actions GUARD_SNOOZE and GUARD_STOP.
          default: ""
          selector:
            text: {}

        # NOTE: assist_satellite domain has no device_class to filter on;
        # domain-only filter is the best available constraint.
        assist_satellite_entity:
          name: Assist Satellite entity
          description: >
            Optional Assist Satellite for interrupting TTS faster and speaking
            short confirmations (e.g. "ok, snoozing"). Leave empty to skip.
          default: ""
          selector:
            entity:
              domain: assist_satellite

        tts_speak_script:
          name: TTS speak helper script
          description: >
            Script that routes TTS announcements (handles ElevenLabs custom
            vs standard engines). Override only if you use a different helper.
          default: script.wake_guard_tts_speak
          selector:
            entity:
              domain: script

        stop_cleanup_script:
          name: Stop cleanup helper script
          description: >
            Script that handles stop cleanup (stop playback, satellite
            announcement, volume restore, toggle reset). Override only if
            you use a different helper.
          default: script.wake_guard_stop_cleanup
          selector:
            entity:
              domain: script

mode: single
max_exceeded: silent

variables:
  v_active_days: !input active_days
  v_tts_engine: !input tts_engine
  v_tts_output_player: !input tts_output_player
  v_notify_service: !input notify_service
  v_assist_satellite: !input assist_satellite_entity
  v_use_llm_wake: !input use_llm_wake_message
  v_llm_agent_id: !input llm_agent_id
  v_llm_wake_prompt: !input llm_wake_prompt
  v_post_tts_timeout: !input post_tts_timeout
  v_bed_presence_sensors: !input bed_presence_sensors
  v_min_bed_minutes: !input min_bed_minutes
  v_workshop_presence_sensors: !input workshop_presence_sensors
  v_min_workshop_empty_minutes: !input min_workshop_empty_minutes
  v_snooze_toggle: !input snooze_toggle
  v_stop_toggle: !input stop_toggle
  v_workshop_switches: !input workshop_switches
  v_workshop_lights: !input workshop_lights
  v_tts_volume_before: !input tts_volume_before
  v_tts_volume_after: !input tts_volume_after
  v_stop_restore_delay: !input stop_restore_delay
  v_tts_voice_profile: !input tts_voice_profile
  v_music_script: !input music_script
  v_snooze_minutes: !input snooze_minutes
  v_person_name: !input person_display_name
  v_tts_speak_script: !input tts_speak_script
  v_stop_cleanup_script: !input stop_cleanup_script

trigger:
  - alias: "Wake-up time on selected days"
    id: wake_time
    trigger: time
    at: !input wakeup_time

condition:
  # NOTE: No native condition for "is today in a user-selected list of
  # weekday abbreviations." Template is the only option here.
  - alias: "Today is in active_days"
    condition: template
    value_template: >-
      {{ ['mon','tue','wed','thu','fri','sat','sun'][now().weekday()] in v_active_days }}

  # Uses last_changed to check actual duration, not just current state.
  # Returns false if no sensors configured (safety).
  - alias: "Bed presence ON for at least min_bed_minutes"
    condition: template
    value_template: >-
      {% set sensors = expand(v_bed_presence_sensors | default([])) %}
      {% set min_secs = (v_min_bed_minutes | int(0)) * 60 %}
      {% if sensors | length == 0 %}
        false
      {% else %}
        {% set ns = namespace(ok=true) %}
        {% for s in sensors %}
          {% if s.state != 'on'
             or (now() - s.last_changed).total_seconds() < min_secs %}
            {% set ns.ok = false %}
          {% endif %}
        {% endfor %}
        {{ ns.ok }}
      {% endif %}

  # Skipped (returns true) when no sensors are configured.
  - alias: "Workshop empty for at least min_workshop_empty_minutes (if configured)"
    condition: template
    value_template: >-
      {% set sensors = expand(v_workshop_presence_sensors | default([])) %}
      {% if sensors | length == 0 %}
        true
      {% else %}
        {% set min_secs = (v_min_workshop_empty_minutes | int(0)) * 60 %}
        {% set ns = namespace(ok=true) %}
        {% for s in sensors %}
          {% if s.state != 'off'
             or (now() - s.last_changed).total_seconds() < min_secs %}
            {% set ns.ok = false %}
          {% endif %}
        {% endfor %}
        {{ ns.ok }}
      {% endif %}

action:
  - alias: "Turn ON switches (optional)"
    action: switch.turn_on
    target:
      entity_id: !input workshop_switches
    continue_on_error: true

  - alias: "Turn ON lights (optional)"
    action: light.turn_on
    target:
      entity_id: !input workshop_lights
    continue_on_error: true

  - alias: "Set TTS player volume before wake-up TTS"
    action: media_player.volume_set
    target:
      entity_id: !input tts_output_player
    data:
      volume_level: !input tts_volume_before

  # LLM step below may overwrite this if enabled and successful.
  - alias: "Prepare wake-up message (static fallback)"
    variables:
      wake_message: !input tts_message

  # Falls back to static message on failure via continue_on_error + default().
  - alias: "Generate wake-up text via LLM (if enabled)"
    choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ v_use_llm_wake and (v_llm_agent_id | default('') | string | length > 0) }}
        sequence:
          - alias: "Call conversation.process for wake-up message"
            action: conversation.process
            data:
              agent_id: "{{ v_llm_agent_id }}"
              text: >-
                {{ (v_llm_wake_prompt | default('') | string)
                   ~ '\n\nsnooze_stop_window_seconds: '
                   ~ (v_post_tts_timeout | string) }}
            response_variable: wake_llm
            continue_on_error: true

          - alias: "Extract LLM response (fall back to static on any failure)"
            variables:
              wake_message: >-
                {% set speech = (wake_llm | default({}))
                    .get('response', {})
                    .get('speech', {})
                    .get('plain', {})
                    .get('speech', '') %}
                {{ speech if speech | length > 0 else wake_message }}

  - alias: "Send mobile notification (optional)"
    choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ (v_notify_service | default('')) | string | length > 0 }}
        sequence:
          # NOTE: action: !input injects the service name as a string at
          # runtime — a typo in the input will only fail when this fires,
          # not at automation load time. No load-time validation is possible.
          - alias: "Push Snooze/Stop notification"
            action: !input notify_service
            data:
              title: "Wake-up alarm"
              message: "time to get up, {{ v_person_name }}. snooze or stop?"
              data:
                actions:
                  - action: "GUARD_SNOOZE"
                    title: "Snooze alarm"
                  - action: "GUARD_STOP"
                    title: "Stop alarm"
    default: []

  # Routes ElevenLabs custom vs standard engine internally.
  - alias: "Wake-up TTS announcement"
    action: "{{ v_tts_speak_script }}"
    data:
      tts_engine: "{{ v_tts_engine }}"
      tts_output_player: "{{ v_tts_output_player }}"
      message: "{{ wake_message }}"
      tts_voice_profile: "{{ v_tts_voice_profile }}"

  # Listens for mobile notification action events AND input_boolean toggles
  # (dashboard / other automation).
  - alias: "Wait for snooze/stop or timeout (pass 1)"
    wait_for_trigger:
      - trigger: event
        event_type: mobile_app_notification_action
        event_data:
          action: "GUARD_SNOOZE"
      - trigger: event
        event_type: mobile_app_notification_action
        event_data:
          action: "GUARD_STOP"
      - trigger: state
        entity_id: !input snooze_toggle
        to: "on"
      - trigger: state
        entity_id: !input stop_toggle
        to: "on"
    timeout:
      seconds: !input post_tts_timeout
    continue_on_timeout: true

  # Normalize mobile events into toggles so downstream logic only checks
  # toggle state.
  - alias: "Sync mobile events into toggles (pass 1)"
    choose:
      - conditions:
          - condition: template
            value_template: >-
              {{ wait.trigger is not none
                 and wait.trigger.platform == 'event'
                 and (wait.trigger.event.data.action | default('')) == 'GUARD_SNOOZE' }}
        sequence:
          - alias: "Set snooze toggle ON"
            action: input_boolean.turn_on
            target:
              entity_id: !input snooze_toggle

      - conditions:
          - condition: template
            value_template: >-
              {{ wait.trigger is not none
                 and wait.trigger.platform == 'event'
                 and (wait.trigger.event.data.action | default('')) == 'GUARD_STOP' }}
        sequence:
          - alias: "Set stop toggle ON"
            action: input_boolean.turn_on
            target:
              entity_id: !input stop_toggle
    default: []

  # Main state machine branch point.
  - alias: "Handle snooze / stop / timeout (pass 1)"
    choose:
      # ── STOP BRANCH ──────────────────────────────────────────────────
      - alias: "STOP: user pressed stop"
        conditions:
          - condition: state
            entity_id: !input stop_toggle
            state: "on"
        sequence:
          - alias: "Stop cleanup via helper script"
            action: "{{ v_stop_cleanup_script }}"
            data:
              tts_output_player: "{{ v_tts_output_player }}"
              assist_satellite_entity: "{{ v_assist_satellite }}"
              satellite_message: "ok, stopping the wake-up alarm."
              tts_volume_after: "{{ v_tts_volume_after }}"
              stop_restore_delay: "{{ v_stop_restore_delay }}"
              snooze_toggle: "{{ v_snooze_toggle }}"
              stop_toggle: "{{ v_stop_toggle }}"

          - stop: "Wake-up completed after Stop."

      # ── SNOOZE BRANCH ────────────────────────────────────────────────
      - alias: "SNOOZE: user pressed snooze"
        conditions:
          - condition: state
            entity_id: !input snooze_toggle
            state: "on"
        sequence:
          - alias: "Stop TTS playback for snooze"
            action: media_player.media_stop
            target:
              entity_id: !input tts_output_player

          - alias: "Announce snooze via Assist Satellite (if configured)"
            choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ (v_assist_satellite | default('')) | length > 0 }}
                sequence:
                  - alias: "Satellite: snoozing announcement"
                    action: assist_satellite.announce
                    target:
                      entity_id: !input assist_satellite_entity
                    data:
                      message: "ok, snoozing the wake-up alarm."
            default: []

          - alias: "Reset snooze toggle"
            action: input_boolean.turn_off
            target:
              entity_id: !input snooze_toggle
            continue_on_error: true

          # Turn off devices so the room goes dark during snooze.
          - alias: "Turn OFF switches during snooze"
            action: switch.turn_off
            target:
              entity_id: !input workshop_switches
            continue_on_error: true

          - alias: "Turn OFF lights during snooze"
            action: light.turn_off
            target:
              entity_id: !input workshop_lights
            continue_on_error: true

          - alias: "Snooze delay"
            delay:
              minutes: !input snooze_minutes

          - alias: "Resend mobile notification after snooze"
            choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ (v_notify_service | default('')) | string | length > 0 }}
                sequence:
                  - alias: "Push Snooze/Stop notification (after snooze)"
                    action: !input notify_service
                    data:
                      title: "Wake-up alarm (after snooze)"
                      message: "the wake-up alarm is back. snooze or stop?"
                      data:
                        actions:
                          - action: "GUARD_SNOOZE"
                            title: "Snooze again"
                          - action: "GUARD_STOP"
                            title: "Stop alarm"
            default: []

          - alias: "Turn ON switches after snooze"
            action: switch.turn_on
            target:
              entity_id: !input workshop_switches
            continue_on_error: true

          - alias: "Turn ON lights after snooze"
            action: light.turn_on
            target:
              entity_id: !input workshop_lights
            continue_on_error: true

          - alias: "Set TTS player volume before wake-up TTS (pass 2)"
            action: media_player.volume_set
            target:
              entity_id: !input tts_output_player
            data:
              volume_level: !input tts_volume_before

          - alias: "Wake-up TTS announcement (pass 2)"
            action: "{{ v_tts_speak_script }}"
            data:
              tts_engine: "{{ v_tts_engine }}"
              tts_output_player: "{{ v_tts_output_player }}"
              message: "{{ wake_message }}"
              tts_voice_profile: "{{ v_tts_voice_profile }}"

          - alias: "Wait for snooze/stop or timeout (pass 2)"
            wait_for_trigger:
              - trigger: event
                event_type: mobile_app_notification_action
                event_data:
                  action: "GUARD_SNOOZE"
              - trigger: event
                event_type: mobile_app_notification_action
                event_data:
                  action: "GUARD_STOP"
              - trigger: state
                entity_id: !input snooze_toggle
                to: "on"
              - trigger: state
                entity_id: !input stop_toggle
                to: "on"
            timeout:
              seconds: !input post_tts_timeout
            continue_on_timeout: true

          - alias: "Sync mobile events into toggles (pass 2)"
            choose:
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ wait.trigger is not none
                         and wait.trigger.platform == 'event'
                         and (wait.trigger.event.data.action | default('')) == 'GUARD_SNOOZE' }}
                sequence:
                  - alias: "Set snooze toggle ON (pass 2)"
                    action: input_boolean.turn_on
                    target:
                      entity_id: !input snooze_toggle
              - conditions:
                  - condition: template
                    value_template: >-
                      {{ wait.trigger is not none
                         and wait.trigger.platform == 'event'
                         and (wait.trigger.event.data.action | default('')) == 'GUARD_STOP' }}
                sequence:
                  - alias: "Set stop toggle ON (pass 2)"
                    action: input_boolean.turn_on
                    target:
                      entity_id: !input stop_toggle
            default: []

          # Second snooze press is treated as Stop.
          - alias: "Handle snooze/stop/timeout (pass 2)"
            choose:
              # STOP after snooze
              - alias: "STOP after snooze"
                conditions:
                  - condition: state
                    entity_id: !input stop_toggle
                    state: "on"
                sequence:
                  - alias: "Stop cleanup via helper script (after snooze)"
                    action: "{{ v_stop_cleanup_script }}"
                    data:
                      tts_output_player: "{{ v_tts_output_player }}"
                      assist_satellite_entity: "{{ v_assist_satellite }}"
                      satellite_message: "ok, stopping the wake-up alarm."
                      tts_volume_after: "{{ v_tts_volume_after }}"
                      stop_restore_delay: "{{ v_stop_restore_delay }}"
                      snooze_toggle: "{{ v_snooze_toggle }}"
                      stop_toggle: "{{ v_stop_toggle }}"

                  - stop: "Wake-up completed after snooze + Stop."

              # Second snooze = treated as Stop (no infinite snooze)
              - alias: "Second snooze = Stop"
                conditions:
                  - condition: state
                    entity_id: !input snooze_toggle
                    state: "on"
                sequence:
                  - alias: "Stop cleanup via helper script (second snooze)"
                    action: "{{ v_stop_cleanup_script }}"
                    data:
                      tts_output_player: "{{ v_tts_output_player }}"
                      assist_satellite_entity: "{{ v_assist_satellite }}"
                      satellite_message: "no more snoozing. get up."
                      tts_volume_after: "{{ v_tts_volume_after }}"
                      stop_restore_delay: "{{ v_stop_restore_delay }}"
                      snooze_toggle: "{{ v_snooze_toggle }}"
                      stop_toggle: "{{ v_stop_toggle }}"

                  - stop: "Wake-up completed after second snooze (treated as Stop)."

            # No input received — hand off to music.
            default:
              - alias: "Run wake-up music script (after snooze timeout)"
                action: script.turn_on
                target:
                  entity_id: !input music_script

              - alias: "Restore TTS player volume (after snooze, music path)"
                action: media_player.volume_set
                target:
                  entity_id: !input tts_output_player
                data:
                  volume_level: !input tts_volume_after

              - alias: "Reset snooze/stop toggles (after snooze, music path)"
                action: input_boolean.turn_off
                target:
                  entity_id:
                    - !input snooze_toggle
                    - !input stop_toggle
                continue_on_error: true

          - stop: "Wake-up completed after snooze + music."

    # ── DEFAULT: no snooze/stop pressed on pass 1 ──────────────────────
    default:
      - alias: "Run wake-up music script (normal path)"
        action: script.turn_on
        target:
          entity_id: !input music_script

      - alias: "Restore TTS player volume (normal path)"
        action: media_player.volume_set
        target:
          entity_id: !input tts_output_player
        data:
          volume_level: !input tts_volume_after

      - alias: "Reset snooze/stop toggles (normal path)"
        action: input_boolean.turn_off
        target:
          entity_id:
            - !input snooze_toggle
            - !input stop_toggle
        continue_on_error: true
