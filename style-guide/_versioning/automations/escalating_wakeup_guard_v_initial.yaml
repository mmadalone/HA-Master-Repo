blueprint:
  name: "Escalating wake-up guard – inverted presence"
  author: madalone
  description: '![Escalating wake-up guard](/local/blueprint-images/escalating_wakeup_guard-header.jpeg)

    # Escalating wake-up guard – inverted presence

    Multi-stage escalation alarm that uses inverted presence logic: instead
    of checking if you are in bed, it checks whether you have gotten up by
    monitoring non-bedroom activity sensors. No activity = still asleep =
    escalate further. Designed as Layer 2 behind llm_alarm.yaml.

    Volume and brightness interpolate smoothly from start to end values
    across a configurable number of stages (1–6). Lights, music, and LLM
    messages are all optional.

    ### Recent changes

    - **v1:** Initial version'
  domain: automation
  homeassistant:
    min_version: "2024.6.0"
  input:

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 1 — Schedule
    # ═══════════════════════════════════════════════════════════════════════

    section_1_schedule:
      name: "① Schedule"
      icon: mdi:calendar-clock
      description: When the escalation guard fires.
      input:

        active_days:
          name: Active weekdays
          description: >
            Days on which this guard should run. Typically matches your
            primary alarm days.
          default:
            - mon
            - tue
            - wed
            - thu
            - fri
          selector:
            select:
              multiple: true
              mode: list
              options:
                - label: Monday
                  value: mon
                - label: Tuesday
                  value: tue
                - label: Wednesday
                  value: wed
                - label: Thursday
                  value: thu
                - label: Friday
                  value: fri
                - label: Saturday
                  value: sat
                - label: Sunday
                  value: sun

        guard_time:
          name: Guard time
          description: >
            When escalation begins. Set this 5–10 minutes after your
            primary alarm so it only fires if you slept through Layer 1.
          selector:
            time: {}

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 2 — Activity sensors
    # ═══════════════════════════════════════════════════════════════════════

    section_2_activity:
      name: "② Activity sensors"
      icon: mdi:motion-sensor
      description: >
        Non-bedroom sensors used for inverted presence detection. If ANY
        of these have been active recently, the user is considered awake
        and escalation stops immediately.
      input:

        activity_sensors:
          name: Activity sensors
          description: >
            Binary sensors outside the bedroom — motion, presence zones,
            door sensors. If any have been ON (or recently turned OFF
            within the lookback window), you are considered awake.
          selector:
            entity:
              domain: binary_sensor
              multiple: true

        activity_lookback:
          name: Activity lookback (minutes)
          description: >
            How recently a sensor must have been ON to count as activity.
            A sensor that turned OFF 3 minutes ago still means you were
            up 3 minutes ago. Default 5 minutes.
          default: 5
          selector:
            number:
              min: 1
              max: 30
              step: 1
              unit_of_measurement: min
              mode: slider

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 3 — TTS & voice
    # ═══════════════════════════════════════════════════════════════════════

    section_3_tts:
      name: "③ TTS & voice"
      icon: mdi:volume-high
      description: Text-to-speech engine, output player, and voice settings.
      input:

        tts_engine:
          name: TTS engine
          description: TTS entity to use with tts.speak.
          selector:
            entity:
              domain: tts

        tts_output_player:
          name: TTS output player
          description: Media player where TTS announcements will play.
          selector:
            entity:
              domain: media_player

        voice_profile:
          name: Voice profile (optional)
          description: >
            ElevenLabs voice profile name. Leave empty if not using
            ElevenLabs or to use the default voice.
          default: ""
          selector:
            text: {}

        tts_speak_script:
          name: TTS speak script
          description: >
            Script that handles TTS playback (e.g. script.wake_guard_tts_speak).
            Must accept message, tts_engine, tts_output_player, and
            voice_profile as variables.
          selector:
            entity:
              domain: script

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 4 — Escalation
    # ═══════════════════════════════════════════════════════════════════════

    section_4_escalation:
      name: "④ Escalation"
      icon: mdi:volume-vibrate
      description: >
        Configure the escalation ramp. Volume interpolates from start to
        end across all stages. Lights and music are optional — leave
        unconfigured to skip those features entirely.
      input:

        num_stages:
          name: Number of stages
          description: >
            How many escalation stages before giving up. Each stage
            increases volume and brightness (if configured) via
            smooth interpolation.
          default: 4
          selector:
            number:
              min: 1
              max: 6
              step: 1
              mode: slider

        stage_delay_minutes:
          name: Delay between stages (minutes)
          description: >
            Time to wait between each escalation stage. During this
            wait, activity sensors are monitored — if you get up,
            escalation stops.
          default: 10
          selector:
            number:
              min: 1
              max: 30
              step: 1
              unit_of_measurement: min
              mode: slider

        start_volume:
          name: Start volume
          description: TTS volume for the first stage.
          default: 0.30
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        end_volume:
          name: End volume
          description: TTS volume for the final stage.
          default: 1.0
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        lights:
          name: Lights (optional)
          description: >
            Lights to ramp up during escalation. Leave empty to skip
            all light actions. Brightness interpolates from start to
            end across stages.
          default: []
          selector:
            entity:
              domain: light
              multiple: true

        start_brightness:
          name: Start brightness
          description: >
            Brightness for the first stage (0–255). Ignored if no
            lights are configured.
          default: 50
          selector:
            number:
              min: 0
              max: 255
              step: 5
              mode: slider

        end_brightness:
          name: End brightness
          description: >
            Brightness for the final stage (0–255). Ignored if no
            lights are configured.
          default: 255
          selector:
            number:
              min: 0
              max: 255
              step: 5
              mode: slider

        flash_final_stage:
          name: Flash lights on final stage
          description: >
            Rapidly flash lights on/off during the final stage for
            maximum annoyance. Ignored if no lights are configured.
          default: true
          selector:
            boolean: {}

        flash_count:
          name: Flash count
          description: >
            Number of on/off flash cycles in the final stage.
            Ignored if flash is disabled or no lights configured.
          default: 10
          selector:
            number:
              min: 1
              max: 20
              step: 1
              mode: slider

        music_script:
          name: Music script (optional)
          description: >
            Script to start music playback (e.g. script.play_morning_radio).
            Leave empty to skip music entirely.
          default: ""
          selector:
            entity:
              domain: script

        music_at_stage:
          name: Start music at stage
          description: >
            Stage number at which music begins (0 = never). Ignored
            if no music script is configured. Music starts once and
            keeps playing through subsequent stages.
          default: 3
          selector:
            number:
              min: 0
              max: 6
              step: 1
              mode: slider

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 5 — Messages
    # ═══════════════════════════════════════════════════════════════════════

    section_5_messages:
      name: "⑤ Messages"
      icon: mdi:message-text
      collapsed: true
      description: >
        Static fallback messages for each tier. All three tiers can
        optionally use LLM-generated messages — enable per tier below
        and configure the LLM agent in section 6.
      input:

        first_stage_message:
          name: First stage message
          description: >
            Gentle first wake-up message. Used when LLM is disabled
            for the first stage, or as fallback if LLM fails.
          default: "Good morning. Time to get up."
          selector:
            text:
              multiline: true

        use_llm_first_stage:
          name: Use LLM for first stage
          description: >
            Generate the first-stage message via conversation agent
            instead of using the static message above.
          default: false
          selector:
            boolean: {}

        llm_prompt_first_stage:
          name: LLM prompt — first stage
          description: >
            Prompt sent to the conversation agent for the first stage.
            Only used if LLM is enabled above.
          default: >-
            Generate a gentle, friendly wake-up message. Keep it under
            two sentences. Be warm but clear that it is time to get up.
          selector:
            text:
              multiline: true

        middle_stage_message:
          name: Middle stage message
          description: >
            Message for stages between first and last. Supports Jinja2:
            {{ stage }} = current stage number, {{ total }} = total stages.
            Used when LLM is disabled, or as fallback if LLM fails.
          default: >-
            You are still in bed. This is stage {{ stage }} of {{ total }}.
          selector:
            text:
              multiline: true

        use_llm_middle_stage:
          name: Use LLM for middle stages
          description: >
            Generate middle-stage messages via conversation agent.
          default: false
          selector:
            boolean: {}

        llm_prompt_middle_stage:
          name: LLM prompt — middle stages
          description: >
            Prompt for middle stages. The agent receives stage context
            automatically. Only used if LLM is enabled above.
          default: >-
            Generate an escalating wake-up message. This is stage {{ stage }}
            of {{ total }}. Be progressively more insistent but not angry.
          selector:
            text:
              multiline: true

        final_stage_message:
          name: Final stage message
          description: >
            Nuclear last-resort message. Supports Jinja2: {{ stage }} and
            {{ total }}. Used when LLM is disabled, or as fallback.
          default: >-
            Last warning. Stage {{ stage }} of {{ total }}. I am not asking again.
          selector:
            text:
              multiline: true

        use_llm_final_stage:
          name: Use LLM for final stage
          description: >
            Generate the final-stage message via conversation agent.
          default: false
          selector:
            boolean: {}

        llm_prompt_final_stage:
          name: LLM prompt — final stage
          description: >
            Prompt for the final stage. Should produce an urgent,
            no-nonsense message. Only used if LLM is enabled above.
          default: >-
            Generate an urgent, final wake-up warning. This is the LAST
            stage. Be direct and firm. No pleasantries.
          selector:
            text:
              multiline: true

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 6 — LLM configuration
    # ═══════════════════════════════════════════════════════════════════════

    section_6_llm:
      name: "⑥ LLM agent"
      icon: mdi:robot
      collapsed: true
      description: >
        Only needed if LLM is enabled for any message tier above.
      input:

        llm_agent:
          name: Conversation agent
          description: >
            The conversation agent to use for LLM message generation.
            Leave empty if not using LLM for any tier.
          default: ""
          selector:
            conversation_agent: {}

        llm_context_entities:
          name: Context entities (optional)
          description: >
            Sensor entities whose states will be included in the LLM
            prompt for richer context (weather, temperature, etc.).
          default: []
          selector:
            entity:
              multiple: true

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 7 — Mobile notifications
    # ═══════════════════════════════════════════════════════════════════════

    section_7_notifications:
      name: "⑦ Mobile notifications"
      icon: mdi:cellphone-message
      collapsed: true
      description: >
        Optional mobile push with a STOP button. No snooze — this IS
        the snooze escalation.
      input:

        notify_service:
          name: Notification service (optional)
          description: >
            Mobile notification service name, e.g. notify.mobile_app_pixel.
            Leave empty to skip mobile notifications.
          default: ""
          selector:
            text: {}

        mobile_stop_action_id:
          name: Mobile stop action ID
          description: >
            Action identifier for the STOP button on the notification.
            Must be unique across your automations.
          default: "ESCALATION_STOP"
          selector:
            text: {}

    # ═══════════════════════════════════════════════════════════════════════
    # SECTION 8 — Cleanup & restore
    # ═══════════════════════════════════════════════════════════════════════

    section_8_cleanup:
      name: "⑧ Cleanup & restore"
      icon: mdi:broom
      collapsed: true
      description: Post-escalation cleanup — volume restore, toggle reset, scripts.
      input:

        tts_volume_after:
          name: Restore volume
          description: Volume to restore on the TTS player after escalation ends.
          default: 0.4
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        stop_cleanup_script:
          name: Cleanup script (optional)
          description: >
            Script to fire after escalation ends (e.g. stop music, reset
            lights). Leave empty to skip.
          default: ""
          selector:
            entity:
              domain: script

        stop_toggle:
          name: Stop toggle (input_boolean)
          description: >
            An input_boolean that can be toggled ON from the HA UI or
            another automation to cancel escalation immediately. Gets
            reset to OFF on exit.
          selector:
            entity:
              domain: input_boolean

# ═════════════════════════════════════════════════════════════════════════
# TRIGGER
# ═════════════════════════════════════════════════════════════════════════

mode: restart

trigger:
  - trigger: time
    at: !input guard_time

# ═════════════════════════════════════════════════════════════════════════
# CONDITION — only run on selected days
# ═════════════════════════════════════════════════════════════════════════

condition:
  - alias: "Only run on active weekdays"
    condition: template
    value_template: >-
      {% set days = ['mon','tue','wed','thu','fri','sat','sun'] %}
      {{ days[now().weekday()] in active_days }}

# ═════════════════════════════════════════════════════════════════════════
# VARIABLES — resolve inputs into template-usable values
# ═════════════════════════════════════════════════════════════════════════

variables:
  active_days: !input active_days
  v_activity_sensors: !input activity_sensors
  v_activity_lookback: !input activity_lookback
  v_tts_engine: !input tts_engine
  v_tts_output_player: !input tts_output_player
  v_voice_profile: !input voice_profile
  v_tts_speak_script: !input tts_speak_script
  v_num_stages: !input num_stages
  v_stage_delay: !input stage_delay_minutes
  v_start_volume: !input start_volume
  v_end_volume: !input end_volume
  v_lights: !input lights
  v_has_lights: "{{ (v_lights | default([])) | length > 0 }}"
  v_start_brightness: !input start_brightness
  v_end_brightness: !input end_brightness
  v_flash_final_stage: !input flash_final_stage
  v_flash_count: !input flash_count
  v_music_script: !input music_script
  v_has_music: >-
    {{ v_music_script | default('') | string | length > 0
       and v_music_script not in ['[]', 'none', 'None', 'unknown'] }}
  v_music_at_stage: !input music_at_stage
  v_first_stage_message: !input first_stage_message
  v_use_llm_first: !input use_llm_first_stage
  v_llm_prompt_first: !input llm_prompt_first_stage
  v_middle_stage_message: !input middle_stage_message
  v_use_llm_middle: !input use_llm_middle_stage
  v_llm_prompt_middle: !input llm_prompt_middle_stage
  v_final_stage_message: !input final_stage_message
  v_use_llm_final: !input use_llm_final_stage
  v_llm_prompt_final: !input llm_prompt_final_stage
  v_llm_agent: !input llm_agent
  v_llm_context_entities: !input llm_context_entities
  v_notify_service: !input notify_service
  v_has_notify: "{{ v_notify_service | default('') | string | length > 0 }}"
  v_mobile_stop_action_id: !input mobile_stop_action_id
  v_tts_volume_after: !input tts_volume_after
  v_stop_cleanup_script: !input stop_cleanup_script
  v_has_cleanup_script: >-
    {{ v_stop_cleanup_script | default('') | string | length > 0
       and v_stop_cleanup_script not in ['[]', 'none', 'None', 'unknown'] }}
  v_stop_toggle: !input stop_toggle

# ═════════════════════════════════════════════════════════════════════════
# ACTION — escalation loop with inverted presence detection
# ═════════════════════════════════════════════════════════════════════════

action:

  # ── Initial activity check — bail immediately if user is already up ──

  - alias: "Check activity sensors before starting — skip if user already awake"
    if:
      - condition: template
        value_template: >-
          {% set sensors = expand(v_activity_sensors | default([])) %}
          {% set lookback_secs = (v_activity_lookback | int(5)) * 60 %}
          {% set ns = namespace(awake=false) %}
          {% for s in sensors %}
            {% if s.state == 'on' %}
              {% set ns.awake = true %}
            {% elif s.state == 'off'
                and (now() - s.last_changed).total_seconds() < lookback_secs %}
              {% set ns.awake = true %}
            {% endif %}
          {% endfor %}
          {{ ns.awake }}
    then:
      - stop: "User already up — activity detected before escalation started."

  # ── Escalation repeat loop ──

  - alias: "Escalation loop — repeat for each configured stage"
    repeat:
      count: "{{ v_num_stages | int(4) }}"
      sequence:

        # ── Compute interpolated values for this stage ──

        - alias: "Compute interpolation values for current stage"
          variables:
            progress: >-
              {{ (repeat.index - 1) / (v_num_stages | int(4) - 1)
                 if (v_num_stages | int(4)) > 1 else 1.0 }}
            volume: >-
              {{ (v_start_volume | float(0.3))
                 + ((v_end_volume | float(1.0)) - (v_start_volume | float(0.3)))
                 * (progress | float(0)) }}
            brightness: >-
              {{ ((v_start_brightness | int(50))
                  + ((v_end_brightness | int(255)) - (v_start_brightness | int(50)))
                  * (progress | float(0))) | int }}
            is_first: "{{ repeat.index == 1 }}"
            is_last: "{{ repeat.index == (v_num_stages | int(4)) }}"
            is_middle: "{{ repeat.index != 1 and repeat.index != (v_num_stages | int(4)) }}"
            start_music: >-
              {{ v_has_music
                 and (v_music_at_stage | int(0)) > 0
                 and repeat.index == (v_music_at_stage | int(0)) }}
            do_flash: >-
              {{ is_last and (v_flash_final_stage | default(true))
                 and v_has_lights }}
            stage: "{{ repeat.index }}"
            total: "{{ v_num_stages | int(4) }}"

        # ── Wait between stages (skip on first iteration) ──

        - alias: "Wait for next stage or cancellation — skip on first iteration"
          if:
            - condition: template
              value_template: "{{ not is_first }}"
          then:
            - alias: "Wait for stage delay — monitor for cancellation signals"
              wait_for_trigger:
                - trigger: event
                  event_type: mobile_app_notification_action
                  event_data:
                    action: "{{ v_mobile_stop_action_id }}"
                - trigger: state
                  entity_id: !input stop_toggle
                  to: "on"
                - trigger: state
                  entity_id: !input activity_sensors
                  to: "on"
              timeout:
                minutes: "{{ v_stage_delay | int(10) }}"
              continue_on_timeout: true

            - alias: "Handle cancellation — if wait was triggered, user is up or stopped"
              if:
                - condition: template
                  value_template: "{{ wait.trigger is not none }}"
              then:
                - alias: "Restore TTS volume after cancellation"
                  action: media_player.volume_set
                  target:
                    entity_id: !input tts_output_player
                  data:
                    volume_level: "{{ v_tts_volume_after | float(0.4) }}"

                - alias: "Reset stop toggle after cancellation"
                  action: input_boolean.turn_off
                  target:
                    entity_id: !input stop_toggle

                - alias: "Fire cleanup script after cancellation — if configured"
                  if:
                    - condition: template
                      value_template: "{{ v_has_cleanup_script }}"
                  then:
                    - action: script.turn_on
                      target:
                        entity_id: !input stop_cleanup_script

                - stop: "Escalation cancelled — activity detected or stop triggered."

            # Re-check activity sensors after the wait in case of lookback match
            - alias: "Re-check activity sensors after delay — stop if user got up during wait"
              if:
                - condition: template
                  value_template: >-
                    {% set sensors = expand(v_activity_sensors | default([])) %}
                    {% set lookback_secs = (v_activity_lookback | int(5)) * 60 %}
                    {% set ns = namespace(awake=false) %}
                    {% for s in sensors %}
                      {% if s.state == 'on' %}
                        {% set ns.awake = true %}
                      {% elif s.state == 'off'
                          and (now() - s.last_changed).total_seconds() < lookback_secs %}
                        {% set ns.awake = true %}
                      {% endif %}
                    {% endfor %}
                    {{ ns.awake }}
              then:
                - alias: "Restore TTS volume — user detected awake during re-check"
                  action: media_player.volume_set
                  target:
                    entity_id: !input tts_output_player
                  data:
                    volume_level: "{{ v_tts_volume_after | float(0.4) }}"

                - alias: "Reset stop toggle — user detected awake during re-check"
                  action: input_boolean.turn_off
                  target:
                    entity_id: !input stop_toggle

                - alias: "Fire cleanup script — user detected awake during re-check"
                  if:
                    - condition: template
                      value_template: "{{ v_has_cleanup_script }}"
                  then:
                    - action: script.turn_on
                      target:
                        entity_id: !input stop_cleanup_script

                - stop: "User detected awake during inter-stage re-check."

        # ── Set volume for this stage ──

        - alias: "Set TTS volume to interpolated level for this stage"
          action: media_player.volume_set
          target:
            entity_id: !input tts_output_player
          data:
            volume_level: "{{ volume | float(0.3) }}"

        # ── Set lights (optional) ──

        - alias: "Set lights to interpolated brightness — only if lights configured"
          if:
            - condition: template
              value_template: "{{ v_has_lights }}"
          then:
            - action: light.turn_on
              target:
                entity_id: !input lights
              data:
                brightness: "{{ brightness | int(50) }}"

        # ── Resolve message for this stage ──

        - alias: "Resolve TTS message — choose tier based on stage position"
          choose:

            # ── First stage ──
            - conditions:
                - condition: template
                  value_template: "{{ is_first }}"
              sequence:
                - alias: "First stage — try LLM or use static message"
                  if:
                    - condition: template
                      value_template: >-
                        {{ v_use_llm_first
                           and (v_llm_agent | default('') | string | length > 0) }}
                  then:
                    - alias: "Generate first-stage message via LLM"
                      action: conversation.process
                      data:
                        agent_id: "{{ v_llm_agent }}"
                        text: "{{ v_llm_prompt_first }}"
                      response_variable: llm_response
                      continue_on_error: true
                    - variables:
                        resolved_message: >-
                          {% set speech = (llm_response | default({}))
                            .get('response', {})
                            .get('speech', {})
                            .get('plain', {})
                            .get('speech', '') %}
                          {{ speech if speech | length > 0
                             else v_first_stage_message }}
                  else:
                    - variables:
                        resolved_message: "{{ v_first_stage_message }}"

            # ── Final stage ──
            - conditions:
                - condition: template
                  value_template: "{{ is_last and not is_first }}"
              sequence:
                - alias: "Final stage — try LLM or use static message"
                  if:
                    - condition: template
                      value_template: >-
                        {{ v_use_llm_final
                           and (v_llm_agent | default('') | string | length > 0) }}
                  then:
                    - alias: "Generate final-stage message via LLM"
                      action: conversation.process
                      data:
                        agent_id: "{{ v_llm_agent }}"
                        text: >-
                          {{ v_llm_prompt_final }}
                          Current stage: {{ stage }} of {{ total }}.
                      response_variable: llm_response
                      continue_on_error: true
                    - variables:
                        resolved_message: >-
                          {% set speech = (llm_response | default({}))
                            .get('response', {})
                            .get('speech', {})
                            .get('plain', {})
                            .get('speech', '') %}
                          {% set fallback = v_final_stage_message
                            | replace('{{ stage }}', stage | string)
                            | replace('{{ total }}', total | string) %}
                          {{ speech if speech | length > 0 else fallback }}
                  else:
                    - variables:
                        resolved_message: >-
                          {{ v_final_stage_message
                             | replace('{{ stage }}', stage | string)
                             | replace('{{ total }}', total | string) }}

          # ── Default: middle stages ──
          default:
            - alias: "Middle stage — try LLM or use static message"
              if:
                - condition: template
                  value_template: >-
                    {{ v_use_llm_middle
                       and (v_llm_agent | default('') | string | length > 0) }}
              then:
                - alias: "Generate middle-stage message via LLM"
                  action: conversation.process
                  data:
                    agent_id: "{{ v_llm_agent }}"
                    text: >-
                      {{ v_llm_prompt_middle }}
                      Current stage: {{ stage }} of {{ total }}.
                  response_variable: llm_response
                  continue_on_error: true
                - variables:
                    resolved_message: >-
                      {% set speech = (llm_response | default({}))
                        .get('response', {})
                        .get('speech', {})
                        .get('plain', {})
                        .get('speech', '') %}
                      {% set fallback = v_middle_stage_message
                        | replace('{{ stage }}', stage | string)
                        | replace('{{ total }}', total | string) %}
                      {{ speech if speech | length > 0 else fallback }}
              else:
                - variables:
                    resolved_message: >-
                      {{ v_middle_stage_message
                         | replace('{{ stage }}', stage | string)
                         | replace('{{ total }}', total | string) }}

        # ── Speak TTS via helper script ──

        - alias: "Speak resolved message via TTS helper script"
          action: script.turn_on
          target:
            entity_id: !input tts_speak_script
          data:
            variables:
              message: "{{ resolved_message | default('Wake up.') }}"
              tts_engine: "{{ v_tts_engine }}"
              tts_output_player: "{{ v_tts_output_player }}"
              voice_profile: "{{ v_voice_profile | default('') }}"

        # ── Start music (optional — once, at configured stage) ──

        - alias: "Start music if configured and this is the start stage"
          if:
            - condition: template
              value_template: "{{ start_music }}"
          then:
            - alias: "Fire music playback script"
              action: script.turn_on
              target:
                entity_id: !input music_script

        # ── Mobile notification with STOP button (first stage only) ──

        - alias: "Send mobile notification with STOP button — first stage only"
          if:
            - condition: template
              value_template: "{{ is_first and v_has_notify }}"
          then:
            - alias: "Fire mobile notification with actionable STOP button"
              action: "{{ v_notify_service }}"
              data:
                title: "⏰ Wake-up escalation started"
                message: >-
                  Escalation guard is active — {{ v_num_stages }} stages,
                  {{ v_stage_delay }} min apart. Tap STOP to cancel.
                data:
                  actions:
                    - action: "{{ v_mobile_stop_action_id }}"
                      title: "STOP"

        # ── Flash lights on final stage (optional) ──

        - alias: "Flash lights on final stage — maximum annoyance mode"
          if:
            - condition: template
              value_template: "{{ do_flash }}"
          then:
            - alias: "Flash cycle — repeat for configured count"
              repeat:
                count: "{{ v_flash_count | int(10) }}"
                sequence:
                  - alias: "Flash off"
                    action: light.turn_off
                    target:
                      entity_id: !input lights
                  - delay:
                      milliseconds: 500
                  - alias: "Flash on at full brightness"
                    action: light.turn_on
                    target:
                      entity_id: !input lights
                    data:
                      brightness: 255
                  - delay:
                      milliseconds: 500

  # ═══════════════════════════════════════════════════════════════════════
  # CLEANUP — runs after all stages complete (user never got up)
  # ═══════════════════════════════════════════════════════════════════════

  - alias: "Restore TTS volume after escalation completes"
    action: media_player.volume_set
    target:
      entity_id: !input tts_output_player
    data:
      volume_level: "{{ v_tts_volume_after | float(0.4) }}"

  - alias: "Reset stop toggle after escalation completes"
    action: input_boolean.turn_off
    target:
      entity_id: !input stop_toggle

  - alias: "Fire cleanup script after escalation — if configured"
    if:
      - condition: template
        value_template: "{{ v_has_cleanup_script }}"
    then:
      - action: script.turn_on
        target:
          entity_id: !input stop_cleanup_script
