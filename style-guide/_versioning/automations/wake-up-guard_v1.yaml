blueprint:
  name: Wake-up guard â€“ with mobile Snooze/Stop (+ TTS interrupt)
  description: |
    Wake-up guard with:
      - Time + selected weekdays
      - Bed & workshop presence conditions
      - Wake-up TTS announcement
      - Snooze once
      - Stop for today
      - ONE wake-up music helper script
      - OPTIONAL mobile push notification with Snooze/Stop buttons
      - OPTIONAL Assist Satellite interrupt to cut TTS off faster

    FLOW
    ----
    1. At wakeup_time on active_days:
       - Only if ALL bed presence sensors have been ON for at least X minutes (you've been in bed)
       - Only if workshop/living room presence sensors have been OFF for at least Y minutes (you left)
    2. Optionally turns ON some switches/lights at wake-up.
    3. Sets TTS output player volume.
    4. Prepares wake-up message:
       - static text input, OR
       - generated by LLM (if enabled and agent_id provided).
    5. Optional mobile notification with Snooze/Stop buttons.
    6. TTS wake-up announcement.
    7. First Snooze/Stop window:
       - wait_for_trigger on:
         * Snooze/Stop input_booleans
         * OR mobile_app_notification_action
           (GUARD_SNOOZE / GUARD_STOP)
       - Normalize mobile events into Snooze/Stop toggles.
       - If Stop: stop everything, restore volume, done.
       - If Snooze: stop TTS, turn off switches/lights (optional), wait snooze_minutes.
    8. After snooze:
       - Resend mobile notification (optional).
       - TTS announcement again.
       - Second Snooze/Stop window:
         * Same normalization of mobile events into toggles.
         * If Stop: stop everything, restore volume, done.
         * If Snooze again: treated as Stop.
         * If nothing: run wake-up music helper, restore volume, done.

    NOTES
    -----
    * Snooze/Stop toggles are only used as control flags and can be driven by:
        - this blueprint (via mobile actions), or
        - your own dashboard buttons/scripts.
    * Mobile notification actions must be configured so that:
        - one uses action "GUARD_SNOOZE"
        - one uses action "GUARD_STOP"
      and the app sends mobile_app_notification_action with those action values.
    * Assist Satellite is optional; when provided, it is used to "cut off" TTS faster
      and optionally speak short confirmations.
    * When using ElevenLabs custom TTS (tts.elevenlabs_custom_tts), the blueprint
      passes a voice_profile string via options.voice_profile.

  domain: automation
  source_url: https://example.local/blueprints/wake-up-guard.yaml

  input:
    active_days:
      name: Active weekdays
      description: Days on which this wake-up should run.
      default:
        - mon
        - tue
        - wed
        - thu
        - fri
      selector:
        select:
          multiple: true
          mode: list
          options:
            - label: Monday
              value: mon
            - label: Tuesday
              value: tue
            - label: Wednesday
              value: wed
            - label: Thursday
              value: thu
            - label: Friday
              value: fri
            - label: Saturday
              value: sat
            - label: Sunday
              value: sun

    wakeup_time:
      name: Wake-up time
      description: Time at which the wake-up guard should fire.
      selector:
        time: {}

    bed_presence_sensors:
      name: Bed presence sensors
      description: >
        One or more bed presence entities (e.g. binary_sensors) that are ON
        when you are in bed. ALL of these must have been ON for at least
        "Minutes you've been in bed (before wakeup time)" before wakeup_time.
      selector:
        entity:
          multiple: true
          domain: binary_sensor

    min_bed_minutes:
      name: Minutes you've been in bed (before wakeup time)
      description: >
        How long ALL bed presence sensors must have been ON BEFORE and up to
        the wakeup time.
      default: 30
      selector:
        number:
          min: 1
          max: 240
          unit_of_measurement: min
          mode: slider

    workshop_presence_sensors:
      name: Workshop / living room presence sensors
      description: >
        One or more presence sensors for workshop / living room.
        ALL of these must have been OFF for at least
        "Minutes workshop must have been empty (before wakeup time)"
        BEFORE wakeup_time.
      default: []
      selector:
        entity:
          multiple: true
          domain: binary_sensor

    min_workshop_empty_minutes:
      name: Minutes workshop must have been empty (before wakeup time)
      description: >
        How long ALL workshop sensors must have been OFF (no presence)
        BEFORE and up to the wakeup time.
      default: 15
      selector:
        number:
          min: 1
          max: 180
          unit_of_measurement: min
          mode: slider

    workshop_switches:
      name: Optional switches to turn on at wake-up
      description: >
        Optional switches (e.g. smart plugs, lamps) to turn ON when the wake-up
        triggers. Leave empty to skip.
      default: []
      selector:
        entity:
          domain: switch
          multiple: true

    workshop_lights:
      name: Optional lights to turn on at wake-up
      description: >
        Optional lights to turn ON when the wake-up triggers. Leave empty to skip.
      default: []
      selector:
        entity:
          domain: light
          multiple: true

    tts_engine:
      name: TTS entity
      description: >
        TTS entity used for the wake-up announcement. If this is exactly
        tts.elevenlabs_custom_tts (HACS custom integration), the blueprint will
        pass the "ElevenLabs Custom voice profile" string as options.voice_profile.
      selector:
        entity:
          domain: tts

    tts_output_player:
      name: Media player for voice (TTS output)
      description: >
        Media player where TTS will play (e.g. a grouped speaker or a single speaker).
      selector:
        entity:
          domain: media_player

    tts_volume_before:
      name: TTS volume BEFORE wake-up TTS
      description: >
        Volume level to set on the TTS player BEFORE the wake-up TTS is played.
      default: 0.4
      selector:
        number:
          min: 0.0
          max: 1.0
          step: 0.01
          mode: slider

    tts_volume_after:
      name: TTS volume AFTER wake-up TTS
      description: >
        Volume level to restore on the TTS player AFTER the wake-up flow completes
        (Stop / snooze + music, etc.).
      default: 0.4
      selector:
        number:
          min: 0.0
          max: 1.0
          step: 0.01
          mode: slider

    stop_restore_delay:
      name: Delay (seconds) before restoring volume on Stop
      description: >
        Small delay in seconds before restoring TTS player volume after Stop.
        This is to avoid restoring volume too early while TTS is being cut.
      default: 1
      selector:
        number:
          min: 0
          max: 30
          unit_of_measurement: s
          mode: slider

    tts_message:
      name: Wake-up message text (fallback)
      description: >
        Static wake-up message text, used:
          - when LLM generation is disabled, or
          - when LLM call fails.
      default: "good morning miquel, time to get up."
      selector:
        text:
          multiline: true

    use_llm_wake_message:
      name: Generate wake-up text with LLM
      description: >
        If on, the wake-up rant will be generated on the fly by your conversation agent,
        using the prompt below. If off, the static "Wake-up message text" above is used.
      default: false
      selector:
        boolean: {}

    llm_agent_id:
      name: Conversation agent_id for wake message
      description: >
        agent_id used with conversation.process (for example an Extended OpenAI
        Conversation agent). Leave this empty to fall back to the
        static wake-up message.
      default: ""
      selector:
        text: {}

    llm_wake_prompt:
      name: LLM prompt for wake-up message
      description: >
        Prompt sent to the conversation agent to generate the rant.
        The blueprint automatically appends context about the post-TTS snooze/stop window
        based on the "Time window after TTS to watch for snooze/stop (seconds)" input.
      default: >
        you are a sarcastic but supportive assistant waking miquel up. make a single, continuous rant that roughly
        fits within the snooze/stop window, is annoying but not genuinely cruel, and ends
        with a clear call to get out of bed now.
      selector:
        text:
          multiline: true

    tts_voice_profile:
      name: ElevenLabs Custom voice profile (optional)
      description: >
        ONLY used when TTS entity is exactly tts.elevenlabs_custom_tts
        (HACS custom integration). Ignored for all other TTS entities.
      default: "Wake-up voice profile"
      selector:
        text: {}

    snooze_toggle:
      name: Snooze toggle (input_boolean)
      description: >
        Input_boolean used as "Snooze" control flag. WILL be turned ON by this blueprint
        when Snooze is triggered from the mobile notification. Can also be controlled
        from a dashboard button or another automation.
      selector:
        entity:
          domain: input_boolean

    stop_toggle:
      name: Stop toggle (input_boolean)
      description: >
        Input_boolean used as "Stop" control flag. WILL be turned ON by this blueprint
        when Stop is triggered from the mobile notification. Can also be controlled
        from a dashboard button or another automation.
      selector:
        entity:
          domain: input_boolean

    music_script:
      name: Wake-up music helper script
      description: >
        Script that starts your wake-up music or hands off to your music helper logic.
      selector:
        entity:
          domain: script

    notify_service:
      name: Notify service (optional)
      description: >
        Notify service used to send mobile notification with Snooze/Stop buttons,
        for example: notify.mobile_app_miquel
        Leave empty to skip mobile notifications.
      default: ""
      selector:
        text: {}

    post_tts_timeout:
      name: Time window after TTS to watch for snooze/stop (seconds)
      description: >
        Number of seconds AFTER TTS starts in which Snooze/Stop is listened for.
      default: 40
      selector:
        number:
          min: 1
          max: 600
          unit_of_measurement: s
          mode: slider

    snooze_minutes:
      name: Snooze minutes
      description: >
        Number of minutes to wait for Snooze before doing a second TTS pass.
        Only ONE snooze is allowed; a second snooze press is treated as Stop.
      default: 7
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: min
          mode: slider

    assist_satellite_entity:
      name: Assist Satellite (optional, for TTS interrupt)
      description: >
        Optional Assist Satellite entity to use for interrupting TTS faster and
        speaking short confirmations (like "ok, snoozing the wake-up alarm").
        Leave empty to skip Assist Satellite.
      default: ""
      selector:
        entity:
          domain: assist_satellite

mode: single
max_exceeded: silent

variables:
  v_active_days: !input active_days
  v_tts_engine: !input tts_engine
  v_notify_service: !input notify_service
  v_assist_satellite: !input assist_satellite_entity
  v_use_llm_wake: !input use_llm_wake_message
  v_llm_agent_id: !input llm_agent_id
  v_llm_wake_prompt: !input llm_wake_prompt
  v_post_tts_timeout: !input post_tts_timeout
  v_bed_presence_sensors: !input bed_presence_sensors
  v_min_bed_minutes: !input min_bed_minutes
  v_workshop_presence_sensors: !input workshop_presence_sensors
  v_min_workshop_empty_minutes: !input min_workshop_empty_minutes

trigger:
  - alias: "Wake-up time on selected days"
    platform: time
    at: !input wakeup_time

condition:
  - alias: "Today is in active_days"
    condition: template
    value_template: >
      {% set idx = now().weekday() %}
      {% if idx == 0 %}
        {% set today_code = 'mon' %}
      {% elif idx == 1 %}
        {% set today_code = 'tue' %}
      {% elif idx == 2 %}
        {% set today_code = 'wed' %}
      {% elif idx == 3 %}
        {% set today_code = 'thu' %}
      {% elif idx == 4 %}
        {% set today_code = 'fri' %}
      {% elif idx == 5 %}
        {% set today_code = 'sat' %}
      {% else %}
        {% set today_code = 'sun' %}
      {% endif %}
      {{ today_code in v_active_days }}

  - alias: "Bed presence has been ON for at least min_bed_minutes"
    condition: template
    value_template: >
      {% set sensors = expand(v_bed_presence_sensors | default([])) %}
      {% set min_minutes = v_min_bed_minutes | int %}
      {% if sensors | length == 0 %}
        false
      {% else %}
        {# NOTE: this currently only checks that all are ON now, not duration #}
        {% set ns = namespace(ok=true) %}
        {% for s in sensors %}
          {% if s.state != 'on' %}
            {% set ns.ok = false %}
          {% endif %}
        {% endfor %}
        {{ ns.ok }}
      {% endif %}

  - alias: "Workshop presence has been OFF for at least min_workshop_empty_minutes (if configured)"
    condition: template
    value_template: >
      {% set sensors = expand(v_workshop_presence_sensors | default([])) %}
      {% if sensors | length == 0 %}
        true
      {% else %}
        {% set min_minutes = v_min_workshop_empty_minutes | int %}
        {# NOTE: this currently only checks that all are OFF now, not duration #}
        {% set all_off = sensors | selectattr('state', 'eq', 'off') | list %}
        {{ (all_off | length) == (sensors | length) }}
      {% endif %}

action:
  - alias: "Turn ON switches (optional)"
    service: switch.turn_on
    target:
      entity_id: !input workshop_switches
    continue_on_error: true

  - alias: "Turn ON lights (optional)"
    service: light.turn_on
    target:
      entity_id: !input workshop_lights
    continue_on_error: true

  - alias: "Set TTS player volume BEFORE wake-up TTS"
    service: media_player.volume_set
    target:
      entity_id: !input tts_output_player
    data:
      volume_level: !input tts_volume_before

  - alias: "Prepare wake-up message (default static)"
    variables:
      wake_message: !input tts_message

  - alias: "Optionally generate wake-up text via LLM"
    choose:
      - conditions:
          - condition: template
            value_template: >
              {{ v_use_llm_wake and (v_llm_agent_id | default('') | string | length > 0) }}
        sequence:
          - alias: "Call conversation.process for wake-up message"
            service: conversation.process
            data:
              agent_id: "{{ v_llm_agent_id }}"
              text: >
                {{ (v_llm_wake_prompt | default('') | string)
                   ~ '\n\nsnooze_stop_window_seconds: '
                   ~ (v_post_tts_timeout | string) }}
            response_variable: wake_llm
            continue_on_error: true

          - alias: "Extract LLM response as wake_message"
            variables:
              wake_message: >
                {% set res = wake_llm | default({}) %}
                {{ res.response.speech.plain.speech | default(wake_message) }}

  - alias: "Send wake-up mobile notification (optional)"
    choose:
      - conditions:
          - condition: template
            value_template: >
              {{ (v_notify_service | default('')) | string | length > 0 }}
        sequence:
          - service: !input notify_service
            data:
              title: "Wake-up alarm"
              message: "time to get up, miquel. snooze or stop?"
              data:
                actions:
                  - action: "GUARD_SNOOZE"
                    title: "Snooze alarm"
                  - action: "GUARD_STOP"
                    title: "Stop alarm"
    default: []

  - alias: "Wake-up TTS announcement"
    choose:
      - conditions:
          - condition: template
            value_template: >
              {{ v_tts_engine == 'tts.elevenlabs_custom_tts' }}
        sequence:
          - service: tts.speak
            target:
              entity_id: !input tts_engine
            data:
              media_player_entity_id: !input tts_output_player
              message: "{{ wake_message }}"
              options:
                voice_profile: !input tts_voice_profile
    default:
      - alias: "Use official ElevenLabs / generic TTS (no voice_profile)"
        service: tts.speak
        target:
          entity_id: !input tts_engine
        data:
          media_player_entity_id: !input tts_output_player
          message: "{{ wake_message }}"

  - alias: "Wait for snooze/stop or timeout"
    wait_for_trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "GUARD_SNOOZE"
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "GUARD_STOP"
      - platform: state
        entity_id: !input snooze_toggle
        to: "on"
      - platform: state
        entity_id: !input stop_toggle
        to: "on"
    timeout:
      hours: 0
      minutes: 0
      seconds: !input post_tts_timeout
    continue_on_timeout: true

  - alias: "Sync Snooze/Stop triggers into toggles"
    choose:
      - conditions:
          - condition: template
            value_template: >
              {{ wait.trigger is not none
                 and wait.trigger.platform == 'event'
                 and (wait.trigger.event.data.action | default('')) == 'GUARD_SNOOZE' }}
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: !input snooze_toggle

      - conditions:
          - condition: template
            value_template: >
              {{ wait.trigger is not none
                 and wait.trigger.platform == 'event'
                 and (wait.trigger.event.data.action | default('')) == 'GUARD_STOP' }}
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: !input stop_toggle
    default: []

  - alias: "Handle snooze / stop / timeout"
    choose:
      # ----- STOP BRANCH -----
      - alias: "STOP: user turned ON stop_toggle"
        conditions:
          - condition: state
            entity_id: !input stop_toggle
            state: "on"
        sequence:
          - alias: "Stop wake-up TTS"
            service: media_player.media_stop
            target:
              entity_id: !input tts_output_player

          - alias: "Interrupt TTS via Assist Satellite (if provided)"
            choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ (v_assist_satellite | default('')) | length > 0 }}
                sequence:
                  - service: assist_satellite.announce
                    target:
                      entity_id: !input assist_satellite_entity
                    data:
                      message: "ok, stopping the wake-up alarm."
            default: []

          - alias: "Delay before restoring volume after Stop"
            delay:
              seconds: !input stop_restore_delay

          - alias: "Restore TTS player volume AFTER wake-up TTS (Stop branch)"
            service: media_player.volume_set
            target:
              entity_id: !input tts_output_player
            data:
              volume_level: !input tts_volume_after

          - alias: "Turn OFF snooze/stop toggles after Stop"
            service: input_boolean.turn_off
            target:
              entity_id:
                - !input snooze_toggle
                - !input stop_toggle
            continue_on_error: true

          - stop: "Wake-up completed after Stop."

      # ----- SNOOZE BRANCH -----
      - alias: "SNOOZE: user turned ON snooze_toggle"
        conditions:
          - condition: state
            entity_id: !input snooze_toggle
            state: "on"
        sequence:
          - alias: "Stop wake-up TTS for snooze"
            service: media_player.media_stop
            target:
              entity_id: !input tts_output_player

          - alias: "Interrupt TTS via Assist Satellite (if provided)"
            choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ (v_assist_satellite | default('')) | length > 0 }}
                sequence:
                  - service: assist_satellite.announce
                    target:
                      entity_id: !input assist_satellite_entity
                    data:
                      message: "ok, snoozing the wake-up alarm."
            default: []

          - alias: "Turn OFF snooze_toggle (one-shot)"
            service: input_boolean.turn_off
            target:
              entity_id: !input snooze_toggle
            continue_on_error: true

          - alias: "Turn OFF switches (optional) during snooze"
            service: switch.turn_off
            target:
              entity_id: !input workshop_switches
            continue_on_error: true

          - alias: "Turn OFF lights (optional) during snooze"
            service: light.turn_off
            target:
              entity_id: !input workshop_lights
            continue_on_error: true

          - alias: "Snooze delay"
            delay:
              hours: 0
              minutes: !input snooze_minutes
              seconds: 0

          - alias: "Send wake-up mobile notification AFTER snooze (optional)"
            choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ (v_notify_service | default('')) | string | length > 0 }}
                sequence:
                  - service: !input notify_service
                    data:
                      title: "Wake-up alarm (after snooze)"
                      message: "the wake-up alarm is back. snooze or stop?"
                      data:
                        actions:
                          - action: "GUARD_SNOOZE"
                            title: "Snooze alarm again"
                          - action: "GUARD_STOP"
                            title: "Stop alarm"
            default: []

          - alias: "Set TTS player volume BEFORE wake-up TTS (after snooze)"
            service: media_player.volume_set
            target:
              entity_id: !input tts_output_player
            data:
              volume_level: !input tts_volume_before

          - alias: "Wake-up TTS AFTER snooze"
            choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ v_tts_engine == 'tts.elevenlabs_custom_tts' }}
                sequence:
                  - service: tts.speak
                    target:
                      entity_id: !input tts_engine
                    data:
                      media_player_entity_id: !input tts_output_player
                      message: "{{ wake_message }}"
                      options:
                        voice_profile: !input tts_voice_profile
            default:
              - alias: "Use official ElevenLabs / generic TTS (no voice_profile) after snooze"
                service: tts.speak
                target:
                  entity_id: !input tts_engine
                data:
                  media_player_entity_id: !input tts_output_player
                  message: "{{ wake_message }}"

          - alias: "Wait for snooze/stop or timeout AFTER snooze"
            wait_for_trigger:
              - platform: event
                event_type: mobile_app_notification_action
                event_data:
                  action: "GUARD_SNOOZE"
              - platform: event
                event_type: mobile_app_notification_action
                event_data:
                  action: "GUARD_STOP"
              - platform: state
                entity_id: !input snooze_toggle
                to: "on"
              - platform: state
                entity_id: !input stop_toggle
                to: "on"
            timeout:
              hours: 0
              minutes: 0
              seconds: !input post_tts_timeout
            continue_on_timeout: true

          - alias: "Sync Snooze/Stop triggers into toggles AFTER snooze"
            choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ wait.trigger is not none
                         and wait.trigger.platform == 'event'
                         and (wait.trigger.event.data.action | default('')) == 'GUARD_SNOOZE' }}
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: !input snooze_toggle

              - conditions:
                  - condition: template
                    value_template: >
                      {{ wait.trigger is not none
                         and wait.trigger.platform == 'event'
                         and (wait.trigger.event.data.action | default('')) == 'GUARD_STOP' }}
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: !input stop_toggle
            default: []

          - alias: "Handle snooze/stop/timeout AFTER snooze"
            choose:
              # STOP after snooze
              - alias: "STOP after snooze: user turned ON stop_toggle"
                conditions:
                  - condition: state
                    entity_id: !input stop_toggle
                    state: "on"
                sequence:
                  - alias: "Stop wake-up TTS after snooze"
                    service: media_player.media_stop
                    target:
                      entity_id: !input tts_output_player

                  - alias: "Interrupt TTS via Assist Satellite (after snooze)"
                    choose:
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ (v_assist_satellite | default('')) | length > 0 }}
                        sequence:
                          - service: assist_satellite.announce
                            target:
                              entity_id: !input assist_satellite_entity
                            data:
                              message: "ok, stopping the wake-up alarm after snooze."
                    default: []

                  - alias: "Delay before restoring volume after Stop (after snooze)"
                    delay:
                      seconds: !input stop_restore_delay

                  - alias: "Restore TTS player volume AFTER wake-up TTS (after snooze Stop)"
                    service: media_player.volume_set
                    target:
                      entity_id: !input tts_output_player
                    data:
                      volume_level: !input tts_volume_after

                  - alias: "Turn OFF snooze/stop toggles after Stop (after snooze)"
                    service: input_boolean.turn_off
                    target:
                      entity_id:
                        - !input snooze_toggle
                        - !input stop_toggle
                    continue_on_error: true

                  - stop: "Wake-up completed after snooze + Stop."

              # SECOND SNOOZE disallowed: if snooze pressed again, treat as Stop
              - alias: "Second snooze press = Stop"
                conditions:
                  - condition: state
                    entity_id: !input snooze_toggle
                    state: "on"
                sequence:
                  - alias: "Stop wake-up TTS (second snooze)"
                    service: media_player.media_stop
                    target:
                      entity_id: !input tts_output_player

                  - alias: "Interrupt TTS via Assist Satellite (second snooze)"
                    choose:
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ (v_assist_satellite | default('')) | length > 0 }}
                        sequence:
                          - service: assist_satellite.announce
                            target:
                              entity_id: !input assist_satellite_entity
                            data:
                              message: "ok, stopping the wake-up alarm after snooze."
                    default: []

                  - alias: "Delay before restoring volume after Stop (second snooze)"
                    delay:
                      seconds: !input stop_restore_delay

                  - alias: "Restore TTS player volume AFTER wake-up TTS (second snooze)"
                    service: media_player.volume_set
                    target:
                      entity_id: !input tts_output_player
                    data:
                      volume_level: !input tts_volume_after

                  - alias: "Turn OFF snooze/stop toggles after second snooze"
                    service: input_boolean.turn_off
                    target:
                      entity_id:
                        - !input snooze_toggle
                        - !input stop_toggle
                    continue_on_error: true

                  - stop: "Wake-up completed after second snooze (treated as Stop)."

            default:
              - alias: "Normal path after snooze timeout (no further snooze/stop)"
                service: homeassistant.turn_on
                target:
                  entity_id: !input music_script

              - alias: "Restore TTS player volume AFTER wake-up TTS (after snooze normal path)"
                service: media_player.volume_set
                target:
                  entity_id: !input tts_output_player
                data:
                  volume_level: !input tts_volume_after

              - alias: "Turn OFF snooze/stop toggles after normal path (after snooze)"
                service: input_boolean.turn_off
                target:
                  entity_id:
                    - !input snooze_toggle
                    - !input stop_toggle
                continue_on_error: true

          - stop: "Wake-up completed after snooze + music."

    # ----- DEFAULT (NO SNOOZE / STOP) -----
    default:
      - alias: "Run wake-up music helper script (normal path)"
        service: homeassistant.turn_on
        target:
          entity_id: !input music_script

      - alias: "Restore TTS player volume AFTER wake-up TTS (normal path)"
        service: media_player.volume_set
        target:
          entity_id: !input tts_output_player
        data:
          volume_level: !input tts_volume_after
