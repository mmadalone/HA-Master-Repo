blueprint:
  name: "Escalating wake-up guard – inverted presence"
  author: madalone
  description: '![Escalating wake-up guard](/local/blueprint-images/escalating_wakeup_guard-header.jpg)

    # Escalating wake-up guard – inverted presence

    Multi-stage escalation alarm that uses inverted presence logic: instead
    of checking if you are in bed, it checks whether you have gotten up by
    monitoring non-bedroom activity sensors. No activity = still asleep =
    escalate further. Designed as Layer 2 behind llm_alarm.yaml.

    Volume and brightness interpolate smoothly from start to end values
    across a configurable number of stages (1–6). Lights, music, and LLM
    messages are all optional.

    ### Recent changes

    - **v6:** Replaced template weekday condition with native condition:time
      (§1.4), removed decorative cleanup banner (§3.5), added continue_on_error
      on flash cycle light calls (§5.2), removed orphaned v_active_days variable
    - **v5:** Added missing inner aliases (§3.5), removed decorative input
      section banners, added default guard on weekday condition (§3.6)
    - **v4:** continue_on_error on all non-critical calls (music, notify,
      lights, volume restore), aliases on flash delays, DRY comments on
      duplicated activity-sensor template
    - **v3:** Merged duplicate cleanup blocks (3→2), DRYed LLM resolution
      (3-branch choose → single path), type-safe LLM response parsing,
      continue_on_error on cleanup script calls, trigger id, stored traces'
  domain: automation
  homeassistant:
    min_version: "2024.6.0"
  input:

    section_1_schedule:
      name: "① Schedule"
      icon: mdi:calendar-clock
      description: When the escalation guard fires.
      input:

        active_days:
          name: Active weekdays
          description: >
            Days on which this guard should run. Typically matches your
            primary alarm days.
          default:
            - mon
            - tue
            - wed
            - thu
            - fri
          selector:
            select:
              multiple: true
              mode: list
              options:
                - label: Monday
                  value: mon
                - label: Tuesday
                  value: tue
                - label: Wednesday
                  value: wed
                - label: Thursday
                  value: thu
                - label: Friday
                  value: fri
                - label: Saturday
                  value: sat
                - label: Sunday
                  value: sun

        guard_time:
          name: Guard time
          description: >
            When escalation begins. Set this 5–10 minutes after your
            primary alarm so it only fires if you slept through Layer 1.
          selector:
            time: {}

    section_2_activity:
      name: "② Activity sensors"
      icon: mdi:motion-sensor
      description: >
        Non-bedroom sensors used for inverted presence detection. If ANY
        of these have been active recently, the user is considered awake
        and escalation stops immediately.
      input:

        activity_sensors:
          name: Activity sensors
          description: >
            Binary sensors outside the bedroom — motion, presence zones,
            door sensors. If any have been ON (or recently turned OFF
            within the lookback window), you are considered awake.
          selector:
            entity:
              domain: binary_sensor
              multiple: true

        activity_lookback:
          name: Activity lookback (minutes)
          description: >
            How recently a sensor must have been ON to count as activity.
            A sensor that turned OFF 3 minutes ago still means you were
            up 3 minutes ago. Default 5 minutes.
          default: 5
          selector:
            number:
              min: 1
              max: 30
              step: 1
              unit_of_measurement: min
              mode: slider

    section_3_tts:
      name: "③ TTS & voice"
      icon: mdi:volume-high
      description: >
        TTS engine for speaking messages, and output player for
        volume control during escalation.
      input:

        tts_entity:
          name: TTS engine
          description: >
            The text-to-speech entity used to speak wake-up messages
            (e.g. tts.elevenlabs_text_to_speech). The resolved message
            text is sent directly — no conversation agent in the loop.
          selector:
            entity:
              domain: tts

        tts_output_player:
          name: TTS output player
          description: >
            Media player that receives TTS audio and whose volume is
            controlled during escalation.
          selector:
            entity:
              domain: media_player

    section_4_escalation:
      name: "④ Escalation"
      icon: mdi:volume-vibrate
      description: >
        Configure the escalation ramp. Volume interpolates from start to
        end across all stages. Lights and music are optional — leave
        unconfigured to skip those features entirely.
      input:

        num_stages:
          name: Number of stages
          description: >
            How many escalation stages before giving up. Each stage
            increases volume and brightness (if configured) via
            smooth interpolation.
          default: 4
          selector:
            number:
              min: 1
              max: 6
              step: 1
              mode: slider

        stage_delay_minutes:
          name: Delay between stages (minutes)
          description: >
            Time to wait between each escalation stage. During this
            wait, activity sensors are monitored — if you get up,
            escalation stops.
          default: 10
          selector:
            number:
              min: 1
              max: 30
              step: 1
              unit_of_measurement: min
              mode: slider

        start_volume:
          name: Start volume
          description: TTS volume for the first stage.
          default: 0.30
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        end_volume:
          name: End volume
          description: TTS volume for the final stage.
          default: 1.0
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        lights:
          name: Lights (optional)
          description: >
            Lights to ramp up during escalation. Leave empty to skip
            all light actions. Brightness interpolates from start to
            end across stages.
          default: []
          selector:
            entity:
              domain: light
              multiple: true

        start_brightness:
          name: Start brightness
          description: >
            Brightness for the first stage (0–255). Ignored if no
            lights are configured.
          default: 50
          selector:
            number:
              min: 0
              max: 255
              step: 5
              mode: slider

        end_brightness:
          name: End brightness
          description: >
            Brightness for the final stage (0–255). Ignored if no
            lights are configured.
          default: 255
          selector:
            number:
              min: 0
              max: 255
              step: 5
              mode: slider

        flash_final_stage:
          name: Flash lights on final stage
          description: >
            Rapidly flash lights on/off during the final stage for
            maximum annoyance. Ignored if no lights are configured.
          default: true
          selector:
            boolean: {}

        flash_count:
          name: Flash count
          description: >
            Number of on/off flash cycles in the final stage.
            Ignored if flash is disabled or no lights configured.
          default: 10
          selector:
            number:
              min: 1
              max: 20
              step: 1
              mode: slider

        music_script:
          name: Music script (optional)
          description: >
            Script to start music playback (e.g. script.play_morning_radio).
            Leave empty to skip music entirely.
          default: ""
          selector:
            entity:
              domain: script

        music_at_stage:
          name: Start music at stage
          description: >
            Stage number at which music begins (0 = never). Ignored
            if no music script is configured. Music starts once and
            keeps playing through subsequent stages.
          default: 3
          selector:
            number:
              min: 0
              max: 6
              step: 1
              mode: slider

    section_5_messages:
      name: "⑤ Messages"
      icon: mdi:message-text
      collapsed: true
      description: >
        Static fallback messages for each tier. All three tiers can
        optionally use LLM-generated messages — enable per tier below
        and configure the LLM agent in section 6.
      input:

        first_stage_message:
          name: First stage message
          description: >
            Gentle first wake-up message. Used when LLM is disabled
            for the first stage, or as fallback if LLM fails.
          default: "Good morning. Time to get up."
          selector:
            text:
              multiline: true

        use_llm_first_stage:
          name: Use LLM for first stage
          description: >
            Generate the first-stage message via conversation agent
            instead of using the static message above.
          default: false
          selector:
            boolean: {}

        llm_prompt_first_stage:
          name: LLM prompt — first stage
          description: >
            Prompt sent to the conversation agent for the first stage.
            Supports {{ stage }}, {{ total }}, {{ stage_delay }}.
            Only used if LLM is enabled above.
          default: >-
            Generate a gentle, friendly wake-up message. Keep it under
            two sentences. Be warm but clear that it is time to get up.
            You have about {{ stage_delay }} minutes before the next
            escalation.
          selector:
            text:
              multiline: true

        middle_stage_message:
          name: Middle stage message
          description: >
            Message for stages between first and last. Supports Jinja2:
            {{ stage }} = current stage number, {{ total }} = total stages.
            Used when LLM is disabled, or as fallback if LLM fails.
          default: >-
            You are still in bed. This is stage {{ stage }} of {{ total }}.
          selector:
            text:
              multiline: true

        use_llm_middle_stage:
          name: Use LLM for middle stages
          description: >
            Generate middle-stage messages via conversation agent.
          default: false
          selector:
            boolean: {}

        llm_prompt_middle_stage:
          name: LLM prompt — middle stages
          description: >
            Prompt for middle stages. Supports {{ stage }}, {{ total }},
            {{ stage_delay }}. Only used if LLM is enabled above.
          default: >-
            Generate an escalating wake-up message. This is stage {{ stage }}
            of {{ total }}, with {{ stage_delay }} minutes between stages.
            Be progressively more insistent but not angry.
          selector:
            text:
              multiline: true

        final_stage_message:
          name: Final stage message
          description: >
            Nuclear last-resort message. Supports Jinja2: {{ stage }} and
            {{ total }}. Used when LLM is disabled, or as fallback.
          default: >-
            Last warning. Stage {{ stage }} of {{ total }}. I am not asking again.
          selector:
            text:
              multiline: true

        use_llm_final_stage:
          name: Use LLM for final stage
          description: >
            Generate the final-stage message via conversation agent.
          default: false
          selector:
            boolean: {}

        llm_prompt_final_stage:
          name: LLM prompt — final stage
          description: >
            Prompt for the final stage. Supports {{ stage }}, {{ total }},
            {{ stage_delay }}. Should produce an urgent, no-nonsense
            message. Only used if LLM is enabled above.
          default: >-
            Generate an urgent, final wake-up warning. This is the LAST
            stage. Be direct and firm. No pleasantries.
          selector:
            text:
              multiline: true

    section_6_llm:
      name: "⑥ LLM agent"
      icon: mdi:robot
      collapsed: true
      description: >
        Only needed if LLM is enabled for any message tier above.
      input:

        llm_agent:
          name: Conversation agent
          description: >
            The conversation agent to use for LLM message generation.
            Leave empty if not using LLM for any tier.
          default: ""
          selector:
            conversation_agent: {}

        llm_context_entities:
          name: Context entities (optional)
          description: >
            Sensor entities whose states will be included in the LLM
            prompt for richer context (weather, temperature, etc.).
          default: []
          selector:
            entity:
              multiple: true

    section_7_notifications:
      name: "⑦ Mobile notifications"
      icon: mdi:cellphone-message
      collapsed: true
      description: >
        Optional mobile push with a STOP button. No snooze — this IS
        the snooze escalation.
      input:

        notify_service:
          name: Notification service (optional)
          description: >
            Mobile notification service name, e.g. notify.mobile_app_pixel.
            Leave empty to skip mobile notifications. (HA does not offer a
            notification service selector — free text is required here.)
          default: ""
          selector:
            text: {}

        mobile_stop_action_id:
          name: Mobile stop action ID
          description: >
            Action identifier for the STOP button on the notification.
            Must be unique across your automations.
          default: "ESCALATION_STOP"
          selector:
            text: {}

    section_8_cleanup:
      name: "⑧ Cleanup & restore"
      icon: mdi:broom
      collapsed: true
      description: Post-escalation cleanup — volume restore, toggle reset, scripts.
      input:

        tts_volume_after:
          name: Restore volume
          description: Volume to restore on the TTS player after escalation ends.
          default: 0.4
          selector:
            number:
              min: 0.0
              max: 1.0
              step: 0.01
              mode: slider

        stop_cleanup_script:
          name: Cleanup script (optional)
          description: >
            Script to fire after escalation ends (e.g. stop music, reset
            lights). Leave empty to skip.
          default: ""
          selector:
            entity:
              domain: script

        stop_toggle:
          name: Stop toggle (input_boolean)
          description: >
            REQUIRED. An input_boolean that can be toggled ON from the HA
            UI or another automation to cancel escalation immediately.
            Gets reset to OFF on exit. Create one via Helpers if you
            don't already have it.
          selector:
            entity:
              domain: input_boolean

mode: restart
trace:
  stored_traces: 15

trigger:
  - id: guard_time
    trigger: time
    at: !input guard_time

condition:
  - alias: "Only run on active weekdays"
    condition: time
    weekday: !input active_days

variables:
  # v_ prefix = resolved !input value, available to templates below
  v_activity_sensors: !input activity_sensors
  v_activity_lookback: !input activity_lookback
  v_tts_entity: !input tts_entity
  v_tts_output_player: !input tts_output_player
  v_num_stages: !input num_stages
  v_stage_delay: !input stage_delay_minutes
  v_start_volume: !input start_volume
  v_end_volume: !input end_volume
  v_lights: !input lights
  v_has_lights: "{{ (v_lights | default([])) | length > 0 }}"
  v_start_brightness: !input start_brightness
  v_end_brightness: !input end_brightness
  v_flash_final_stage: !input flash_final_stage
  v_flash_count: !input flash_count
  v_music_script: !input music_script
  v_has_music: >-
    {{ v_music_script | default('') | string | length > 0
       and v_music_script not in ['[]', 'none', 'None', 'unknown'] }}
  v_music_at_stage: !input music_at_stage
  v_first_stage_message: !input first_stage_message
  v_use_llm_first: !input use_llm_first_stage
  v_llm_prompt_first: !input llm_prompt_first_stage
  v_middle_stage_message: !input middle_stage_message
  v_use_llm_middle: !input use_llm_middle_stage
  v_llm_prompt_middle: !input llm_prompt_middle_stage
  v_final_stage_message: !input final_stage_message
  v_use_llm_final: !input use_llm_final_stage
  v_llm_prompt_final: !input llm_prompt_final_stage
  v_llm_agent: !input llm_agent
  v_llm_context_entities: !input llm_context_entities
  v_notify_service: !input notify_service
  v_has_notify: "{{ v_notify_service | default('') | string | length > 0 }}"
  v_mobile_stop_action_id: !input mobile_stop_action_id
  v_tts_volume_after: !input tts_volume_after
  v_stop_cleanup_script: !input stop_cleanup_script
  v_has_cleanup_script: >-
    {{ v_stop_cleanup_script | default('') | string | length > 0
       and v_stop_cleanup_script not in ['[]', 'none', 'None', 'unknown'] }}

action:

  # ── Initial activity check — bail immediately if user is already up ──

  - alias: "Check activity sensors before starting — skip if user already awake"
    if:
      - condition: template
        # NOTE: duplicated in inter-stage cancel check — no extraction path in HA
        value_template: >-
          {% set sensors = expand(v_activity_sensors | default([])) %}
          {% set lookback_secs = (v_activity_lookback | int(5)) * 60 %}
          {% set ns = namespace(awake=false) %}
          {% for s in sensors %}
            {% if s.state == 'on' %}
              {% set ns.awake = true %}
            {% elif s.state == 'off'
                and (now() - s.last_changed).total_seconds() < lookback_secs %}
              {% set ns.awake = true %}
            {% endif %}
          {% endfor %}
          {{ ns.awake }}
    then:
      - stop: "User already up — activity detected before escalation started."

  # ── Escalation repeat loop ──

  - alias: "Escalation loop — repeat for each configured stage"
    repeat:
      count: "{{ v_num_stages | int(4) }}"
      sequence:

        # ── Compute interpolated values for this stage ──

        - alias: "Compute interpolation values for current stage"
          variables:
            progress: >-
              {{ (repeat.index - 1) / (v_num_stages | int(4) - 1)
                 if (v_num_stages | int(4)) > 1 else 1.0 }}
            volume: >-
              {{ (v_start_volume | float(0.3))
                 + ((v_end_volume | float(1.0)) - (v_start_volume | float(0.3)))
                 * (progress | float(0)) }}
            brightness: >-
              {{ ((v_start_brightness | int(50))
                  + ((v_end_brightness | int(255)) - (v_start_brightness | int(50)))
                  * (progress | float(0))) | int }}
            is_first: "{{ repeat.index == 1 }}"
            is_last: "{{ repeat.index == (v_num_stages | int(4)) }}"
            is_middle: "{{ repeat.index != 1 and repeat.index != (v_num_stages | int(4)) }}"
            start_music: >-
              {{ v_has_music
                 and (v_music_at_stage | int(0)) > 0
                 and repeat.index == (v_music_at_stage | int(0)) }}
            do_flash: >-
              {{ is_last and (v_flash_final_stage | default(true))
                 and v_has_lights }}
            stage: "{{ repeat.index }}"
            total: "{{ v_num_stages | int(4) }}"

        # ── Wait between stages (skip on first iteration) ──

        - alias: "Wait for next stage or cancellation — skip on first iteration"
          if:
            - condition: template
              value_template: "{{ not is_first }}"
          then:
            - alias: "Wait for stage delay — monitor for cancellation signals"
              wait_for_trigger:
                - trigger: event
                  event_type: mobile_app_notification_action
                  event_data:
                    action: "{{ v_mobile_stop_action_id }}"
                - trigger: state
                  entity_id: !input stop_toggle
                  to: "on"
                - trigger: state
                  entity_id: !input activity_sensors
                  to: "on"
              timeout:
                minutes: "{{ v_stage_delay | int(10) }}"
              continue_on_timeout: true

            - alias: "Check if escalation should stop — cancel signal or activity detected"
              if:
                - condition: or
                  conditions:
                    - alias: "Cancel signal received during inter-stage wait"
                      condition: template
                      value_template: "{{ wait.trigger is not none }}"
                    - alias: "Activity detected during or after wait (lookback check)"
                      condition: template
                      # NOTE: duplicated from initial pre-loop check — no extraction path in HA
                      value_template: >-
                        {% set sensors = expand(v_activity_sensors | default([])) %}
                        {% set lookback_secs = (v_activity_lookback | int(5)) * 60 %}
                        {% set ns = namespace(awake=false) %}
                        {% for s in sensors %}
                          {% if s.state == 'on' %}
                            {% set ns.awake = true %}
                          {% elif s.state == 'off'
                              and (now() - s.last_changed).total_seconds() < lookback_secs %}
                            {% set ns.awake = true %}
                          {% endif %}
                        {% endfor %}
                        {{ ns.awake }}
              then:
                - alias: "Restore TTS volume — escalation interrupted"
                  action: media_player.volume_set
                  target:
                    entity_id: !input tts_output_player
                  data:
                    volume_level: "{{ v_tts_volume_after | float(0.4) }}"
                  continue_on_error: true

                - alias: "Reset stop toggle — escalation interrupted"
                  action: input_boolean.turn_off
                  target:
                    entity_id: !input stop_toggle

                - alias: "Fire cleanup script — escalation interrupted (non-critical)"
                  if:
                    - condition: template
                      value_template: "{{ v_has_cleanup_script }}"
                  then:
                    - alias: "Execute cleanup script"
                      action: script.turn_on
                      target:
                        entity_id: "{{ v_stop_cleanup_script }}"
                      continue_on_error: true

                - stop: "Escalation interrupted — activity detected or stop signal received."

        # ── Set volume for this stage ──

        - alias: "Set TTS volume to interpolated level for this stage"
          action: media_player.volume_set
          target:
            entity_id: !input tts_output_player
          data:
            volume_level: "{{ volume | float(0.3) }}"

        # ── Set lights (optional) ──

        - alias: "Set lights to interpolated brightness — only if lights configured"
          if:
            - condition: template
              value_template: "{{ v_has_lights }}"
          then:
            - alias: "Turn on lights at interpolated brightness"
              action: light.turn_on
              target:
                entity_id: !input lights
              data:
                brightness: "{{ brightness | int(50) }}"
              continue_on_error: true

        # ── Select message parameters for this stage (DRY — one path for all tiers) ──

        - alias: "Select message tier — pick LLM flag, prompt, and static fallback for this stage"
          variables:
            use_llm: >-
              {{ (is_first and v_use_llm_first)
                 or (is_last and not is_first and v_use_llm_final)
                 or (is_middle and v_use_llm_middle) }}
            llm_prompt_raw: >-
              {% if is_first %}{{ v_llm_prompt_first }}
              {% elif is_last %}{{ v_llm_prompt_final }}
              {% else %}{{ v_llm_prompt_middle }}{% endif %}
            static_message: >-
              {% if is_first %}{{ v_first_stage_message }}
              {% elif is_last %}{{ v_final_stage_message
                 | replace('{{ stage }}', stage | string)
                 | replace('{{stage}}', stage | string)
                 | replace('{{ total }}', total | string)
                 | replace('{{total}}', total | string) }}
              {% else %}{{ v_middle_stage_message
                 | replace('{{ stage }}', stage | string)
                 | replace('{{stage}}', stage | string)
                 | replace('{{ total }}', total | string)
                 | replace('{{total}}', total | string) }}{% endif %}

        - alias: "Resolve message — LLM with safe fallback to static text"
          if:
            - condition: template
              value_template: >-
                {{ use_llm and (v_llm_agent | default('') | string | length > 0) }}
          then:
            - alias: "Generate message via conversation agent"
              action: conversation.process
              data:
                agent_id: "{{ v_llm_agent }}"
                text: >-
                  {{ llm_prompt_raw
                     | replace('{{ stage }}', stage | string)
                     | replace('{{stage}}', stage | string)
                     | replace('{{ total }}', total | string)
                     | replace('{{total}}', total | string)
                     | replace('{{ stage_delay }}', v_stage_delay | string)
                     | replace('{{stage_delay}}', v_stage_delay | string) }}
              response_variable: llm_response
              continue_on_error: true

            - alias: "Parse LLM response with type safety — fall back to static on any failure"
              variables:
                resolved_message: >-
                  {% if llm_response is defined and llm_response is mapping
                        and llm_response.get('response') is mapping %}
                    {% set speech = llm_response.get('response', {})
                      .get('speech', {}).get('plain', {}).get('speech', '') %}
                  {% else %}
                    {% set speech = '' %}
                  {% endif %}
                  {{ speech if speech | length > 0 else static_message }}
          else:
            - alias: "No LLM configured for this tier — use static message"
              variables:
                resolved_message: "{{ static_message }}"

        # ── Speak via direct TTS call ──

        - alias: "Speak resolved message via TTS engine"
          action: tts.speak
          target:
            entity_id: "{{ v_tts_entity }}"
          data:
            media_player_entity_id: "{{ v_tts_output_player }}"
            message: "{{ resolved_message | default('Wake up.') }}"
          continue_on_error: true

        # ── Start music (optional — once, at configured stage) ──

        - alias: "Start music if configured and this is the start stage"
          if:
            - condition: template
              value_template: "{{ start_music }}"
          then:
            - alias: "Fire music playback script"
              action: script.turn_on
              target:
                entity_id: "{{ v_music_script }}"
              continue_on_error: true

        # ── Mobile notification with STOP button (first stage only) ──

        - alias: "Send mobile notification with STOP button — first stage only"
          if:
            - condition: template
              value_template: "{{ is_first and v_has_notify }}"
          then:
            - alias: "Fire mobile notification with actionable STOP button"
              action: "{{ v_notify_service }}"
              continue_on_error: true
              data:
                title: "⏰ Wake-up escalation started"
                message: >-
                  Escalation guard is active — {{ v_num_stages }} stages,
                  {{ v_stage_delay }} min apart. Tap STOP to cancel.
                data:
                  actions:
                    - action: "{{ v_mobile_stop_action_id }}"
                      title: "STOP"

        # ── Flash lights on final stage (optional) ──

        - alias: "Flash lights on final stage — maximum annoyance mode"
          if:
            - condition: template
              value_template: "{{ do_flash }}"
          then:
            - alias: "Flash cycle — repeat for configured count"
              repeat:
                count: "{{ v_flash_count | int(10) }}"
                sequence:
                  - alias: "Flash off"
                    action: light.turn_off
                    target:
                      entity_id: !input lights
                    continue_on_error: true
                  - alias: "Flash off hold"
                    delay:
                      milliseconds: 500
                  - alias: "Flash on at full brightness"
                    action: light.turn_on
                    target:
                      entity_id: !input lights
                    data:
                      brightness: 255
                    continue_on_error: true
                  - alias: "Flash on hold"
                    delay:
                      milliseconds: 500

  - alias: "Restore TTS volume after escalation completes"
    action: media_player.volume_set
    target:
      entity_id: !input tts_output_player
    data:
      volume_level: "{{ v_tts_volume_after | float(0.4) }}"
    continue_on_error: true

  - alias: "Reset stop toggle after escalation completes"
    action: input_boolean.turn_off
    target:
      entity_id: !input stop_toggle

  - alias: "Fire cleanup script after escalation — if configured (non-critical)"
    if:
      - condition: template
        value_template: "{{ v_has_cleanup_script }}"
    then:
      - alias: "Execute cleanup script"
        action: script.turn_on
        target:
          entity_id: "{{ v_stop_cleanup_script }}"
        continue_on_error: true
