  - alias: "9d · Unified ledger-driven reminder loop"
    if:
      - condition: template
        value_template: >-
          {{ reminder_enabled | bool(false)
             and (ledger_entity | default('') | string | length) > 0 }}
    then:
      - variables:
          _rem_start_ts: "{{ as_timestamp(now()) }}"
          _fast_count: 0
          _re_escalate_count: 0
          _prev_satellite: ""
          _skip_next_wait: false

      - alias: "Unified reminder loop (fast-cadence → long-tail)"
        repeat:
          while:
            - alias: "UL-W1 · Ledger not empty"
              condition: template
              value_template: >-
                {% set raw = states(ledger_entity) | default('')
                    | replace('unknown', '') | trim %}
                {{ raw | length > 0 }}
            - alias: "UL-W2 · Ceiling not exceeded"
              condition: template
              value_template: >-
                {% set elapsed = (as_timestamp(now())
                    - (_rem_start_ts | float(0))) / 60 %}
                {{ elapsed < (ceiling_min | int(240)) }}
            - alias: "UL-W3 · Master toggle still on"
              condition: template
              value_template: "{{ is_state(toggle_entity, 'on') }}"
          sequence:
            # =============================================================
            # UL-1 · Compute phase and wait
            # =============================================================
            - alias: "UL-1 · Compute current phase"
              variables:
                _phase: >-
                  {% set fc = _fast_count | default(0) | int(0) %}
                  {% set re = _re_escalate_count | default(0) | int(0) %}
                  {% if fc < (reminder_max | int(3)) %}fast
                  {% elif re > 0 %}fast
                  {% elif (long_tail_min | int(0)) > 0 %}long_tail
                  {% else %}done{% endif %}

            - alias: "UL-1a · Exit if both phases exhausted"
              condition: template
              value_template: "{{ _phase != 'done' }}"

            - alias: "UL-1b · Wait — fast-cadence (plain delay)"
              if:
                - condition: template
                  value_template: >-
                    {{ _phase == 'fast'
                       and not (_skip_next_wait
                                | default(false) | bool) }}
              then:
                - delay:
                    minutes: "{{ reminder_interval_min | int(5) }}"

            - alias: "UL-1c · Wait — long-tail (interruptible by presence)"
              if:
                - condition: template
                  value_template: >-
                    {{ _phase == 'long_tail'
                       and not (_skip_next_wait
                                | default(false) | bool) }}
              then:
                - wait_for_trigger:
                    - trigger: template
                      value_template: >-
                        {% set ns = namespace(idx=-1) %}
                        {% for s in presence_list %}
                          {% if states(s) | default('off') == 'on'
                                and ns.idx == -1 %}
                            {% set ns.idx = loop.index0 %}
                          {% endif %}
                        {% endfor %}
                        {% set sat = satellite_list[ns.idx]
                            | default('')
                            if ns.idx >= 0
                               and ns.idx < (satellite_list | length)
                            else '' %}
                        {{ sat != (_prev_satellite | default(''))
                           and (_prev_satellite | default('')
                                | length) > 0 }}
                  timeout:
                    minutes: "{{ long_tail_min | int(15) }}"
                  continue_on_timeout: true

            - alias: "UL-1d · Detect presence-triggered wakeup"
              variables:
                _wait_interrupted: >-
                  {% if _phase == 'long_tail'
                        and not (_skip_next_wait
                                 | default(false) | bool) %}
                    {{ wait.trigger is defined
                       and wait.trigger is not none }}
                  {% else %}
                    false
                  {% endif %}
                _skip_next_wait: false

            # =============================================================
            # UL-2 · Read and parse ledger
            # =============================================================
            - alias: "UL-2 · Read ledger and parse entries"
              variables:
                _ledger_raw: >-
                  {{ states(ledger_entity) | default('')
                     | replace('unknown', '') | trim }}
                _ledger_entries: >-
                  {% set raw = _ledger_raw | default('') | trim %}
                  {% if raw | length == 0 %}[]
                  {% else %}
                    {% set ns = namespace(result=[]) %}
                    {% for entry in raw.split(',') %}
                      {% set parts = entry.split('|') %}
                      {% if parts | length >= 3 %}
                        {% set ns.result = ns.result + [{
                            'sender': parts[0] | trim,
                            'epoch': parts[1] | trim | int(0),
                            'app': parts[2] | trim
                        }] %}
                      {% endif %}
                    {% endfor %}
                    {{ ns.result }}
                  {% endif %}
                _ledger_count: >-
                  {{ _ledger_entries | length }}
                _is_bundled: >-
                  {{ _ledger_count | int(0) > 1 }}

            - alias: "UL-2a · Skip if ledger emptied during wait"
              condition: template
              value_template: >-
                {{ _ledger_count | int(0) > 0 }}

            # =============================================================
            # UL-3 · Gate checks
            # =============================================================
            - alias: "UL-3a · Re-check DND"
              condition: template
              value_template: >-
                {% set dnd = dnd_entity | default('') | string %}
                {% if dnd | length == 0 %}true
                {% else %}
                  {{ states(dnd) | default('off')
                     in ['off', 'unavailable', 'unknown'] }}
                {% endif %}

            - alias: "UL-3b · Re-check quiet hours"
              condition: template
              value_template: >-
                {% if not (enable_quiet | bool(false)) %}true
                {% else %}
                  {% set qs = today_at(quiet_start_val
                      | default('23:00:00')) %}
                  {% set qe = today_at(quiet_end_val
                      | default('07:00:00')) %}
                  {% if qs < qe %}
                    {{ not (qs <= now() < qe) }}
                  {% else %}
                    {{ qe <= now() < qs }}
                  {% endif %}
                {% endif %}

            - alias: "UL-3c · Evict stale ledger entries if phone sustained-interactive"
              if:
                - condition: template
                  value_template: >-
                    {% set ent = phone_interactive_entity
                        | default('') | string %}
                    {% if ent | length == 0 %}false
                    {% elif states(ent) | default('off') != 'on' %}false
                    {% else %}
                      {% set changed = states[ent].last_changed
                          | default(now()) %}
                      {% set mins = ((now() - changed)
                          .total_seconds() / 60) | round(1) %}
                      {{ mins >= (phone_interactive_min
                          | int(2)) }}
                    {% endif %}
              then:
                - variables:
                    _evict_threshold: >-
                      {{ as_timestamp(now())
                         - ((phone_interactive_min | int(2))
                            * 60) }}
                    _ledger_after_evict: >-
                      {% set ns = namespace(kept=[]) %}
                      {% for e in _ledger_entries %}
                        {% if e.epoch | int(0)
                              > (_evict_threshold | float(0)) %}
                          {% set ns.kept = ns.kept
                              + [e.sender ~ '|' ~ e.epoch
                                 ~ '|' ~ e.app] %}
                        {% endif %}
                      {% endfor %}
                      {{ ns.kept | join(',') }}
                - action: input_text.set_value
                  continue_on_error: true
                  target:
                    entity_id: "{{ ledger_entity }}"
                  data:
                    value: "{{ _ledger_after_evict | trim }}"
                - variables:
                    _ledger_raw: "{{ _ledger_after_evict | trim }}"
                    _ledger_entries: >-
                      {% set raw = _ledger_after_evict | trim %}
                      {% if raw | length == 0 %}[]
                      {% else %}
                        {% set ns = namespace(result=[]) %}
                        {% for entry in raw.split(',') %}
                          {% set parts = entry.split('|') %}
                          {% if parts | length >= 3 %}
                            {% set ns.result = ns.result + [{
                                'sender': parts[0] | trim,
                                'epoch': parts[1] | trim | int(0),
                                'app': parts[2] | trim
                            }] %}
                          {% endif %}
                        {% endfor %}
                        {{ ns.result }}
                      {% endif %}
                    _ledger_count: >-
                      {{ _ledger_entries | length }}

            - alias: "UL-3d · Remove dismissed notification from ledger"
              if:
                - condition: template
                  value_template: >-
                    {% set ent = last_removed_entity
                        | default('') | string %}
                    {% if ent | length == 0 %}false
                    {% else %}
                      {% set rm = states[ent].attributes
                          | default({}) %}
                      {% set rm_sender = rm.get('android.title',
                          '') | string | lower | trim %}
                      {% set rm_pkg = rm.get('package', '')
                          | string | lower | trim %}
                      {% set rm_post = rm.get('post_time', 0)
                          | int(0) %}
                      {% set ns = namespace(found=false) %}
                      {% for e in _ledger_entries %}
                        {% if e.sender == rm_sender
                              and e.app == rm_pkg
                              and rm_post >= e.epoch %}
                          {% set ns.found = true %}
                        {% endif %}
                      {% endfor %}
                      {{ ns.found }}
                    {% endif %}
              then:
                - variables:
                    _rm_attrs: >-
                      {{ states[last_removed_entity].attributes
                         | default({}) }}
                    _rm_sender: >-
                      {{ _rm_attrs.get('android.title', '')
                         | string | lower | trim }}
                    _rm_pkg: >-
                      {{ _rm_attrs.get('package', '')
                         | string | lower | trim }}
                    _rm_post: >-
                      {{ _rm_attrs.get('post_time', 0)
                         | int(0) }}
                    _ledger_after_dismiss: >-
                      {% set ns = namespace(kept=[], removed=false) %}
                      {% for e in _ledger_entries %}
                        {% if not ns.removed
                              and e.sender == _rm_sender
                              and e.app == _rm_pkg
                              and _rm_post >= e.epoch %}
                          {% set ns.removed = true %}
                        {% else %}
                          {% set ns.kept = ns.kept
                              + [e.sender ~ '|' ~ e.epoch
                                 ~ '|' ~ e.app] %}
                        {% endif %}
                      {% endfor %}
                      {{ ns.kept | join(',') }}
                - action: input_text.set_value
                  continue_on_error: true
                  target:
                    entity_id: "{{ ledger_entity }}"
                  data:
                    value: "{{ _ledger_after_dismiss | trim }}"
                - variables:
                    _ledger_raw: >-
                      {{ _ledger_after_dismiss | trim }}
                    _ledger_entries: >-
                      {% set raw = _ledger_after_dismiss | trim %}
                      {% if raw | length == 0 %}[]
                      {% else %}
                        {% set ns = namespace(result=[]) %}
                        {% for entry in raw.split(',') %}
                          {% set parts = entry.split('|') %}
                          {% if parts | length >= 3 %}
                            {% set ns.result = ns.result + [{
                                'sender': parts[0] | trim,
                                'epoch': parts[1] | trim
                                    | int(0),
                                'app': parts[2] | trim
                            }] %}
                          {% endif %}
                        {% endfor %}
                        {{ ns.result }}
                      {% endif %}
                    _ledger_count: >-
                      {{ _ledger_entries | length }}

            - alias: "UL-3e · Skip if ledger emptied by eviction or dismiss"
              condition: template
              value_template: >-
                {{ _ledger_count | int(0) > 0 }}

            # =============================================================
            # UL-4 · Re-resolve presence + retrigger handling
            # =============================================================
            - alias: "UL-4 · Re-resolve presence for this tick"
              variables:
                _r_active_index: >-
                  {% set ns = namespace(idx=-1) %}
                  {% for s in presence_list %}
                    {% if states(s) | default('off') == 'on'
                          and ns.idx == -1 %}
                      {% set ns.idx = loop.index0 %}
                    {% endif %}
                  {% endfor %}
                  {{ ns.idx }}
                _r_satellite: >-
                  {% set idx = _r_active_index | int(-1) %}
                  {% if idx >= 0
                        and idx < (satellite_list | length) %}
                    {{ satellite_list[idx] }}
                  {% else %}{{ '' }}{% endif %}
                _r_has_satellite: >-
                  {{ (_r_satellite | default('')
                      | string | length) > 0 }}
                _presence_changed: >-
                  {{ _r_satellite != (_prev_satellite
                      | default(''))
                     and (_prev_satellite | default('')
                          | length) > 0 }}

            - alias: "UL-4a · Gate: satellite found or push fallback"
              condition: template
              value_template: >-
                {{ _r_has_satellite
                   or fallback == 'mobile_push' }}

            - alias: "UL-4b · Handle presence retrigger (long-tail only)"
              if:
                - condition: template
                  value_template: >-
                    {{ _presence_changed | bool(false)
                       and _phase == 'long_tail' }}
              then:
                - choose:
                    - alias: "Re-escalate — reset fast-cadence counter"
                      conditions:
                        - condition: template
                          value_template: >-
                            {{ retrigger_mode == 're_escalate' }}
                      sequence:
                        - variables:
                            _re_escalate_count: >-
                              {{ reminder_max | int(3) }}
                    - alias: "Single burst — skip wait on next tick"
                      conditions:
                        - condition: template
                          value_template: >-
                            {{ retrigger_mode == 'single_burst' }}
                      sequence:
                        - variables:
                            _skip_next_wait: true

            - variables:
                _prev_satellite: "{{ _r_satellite }}"

            # =============================================================
            # UL-5 · Re-read sensor + resolve ringer
            # =============================================================
            - alias: "UL-5 · Re-read sensor attributes for updated thread"
              variables:
                _r_attrs: >-
                  {{ states[sensor_entity].attributes
                     | default({}) }}
                _r_sender_raw: >-
                  {% set raw = _r_attrs.get('android.title', '')
                      | string %}
                  {{ 'Unknown sender' if raw in ['null', '']
                     else raw }}
                _r_package: >-
                  {{ _r_attrs.get('package', '') }}
                _r_text: >-
                  {% set lines = _r_attrs.get(
                      'android.textLines', none) %}
                  {% if lines is iterable
                        and lines is not string
                        and lines | length > 0 %}
                    {{ lines | join(' · ') }}
                  {% else %}
                    {% set raw = _r_attrs.get(
                        'android.text', '') | string %}
                    {{ '' if raw == 'null' else raw }}
                  {% endif %}
                _r_display_sender: >-
                  {%- set sender = _r_sender_raw | default('')
                      | string -%}
                  {%- set raw = aliases_map | default('')
                      | string | trim -%}
                  {%- if raw | length == 0 -%}
                    {{ sender }}
                  {%- else -%}
                    {%- set lower_s = sender | lower -%}
                    {%- set ns = namespace(matched='') -%}
                    {%- for pair in raw.split(',') -%}
                      {%- set parts = pair.split('=', 1) -%}
                      {%- if parts | length == 2 -%}
                        {%- set key = parts[0] | trim -%}
                        {%- set val = parts[1] | trim -%}
                        {%- if key | lower == lower_s
                              and ns.matched == '' -%}
                          {%- set ns.matched = val -%}
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                    {%- set _alias_raw = ns.matched
                        if ns.matched | length > 0
                        else sender -%}
                    {{ _alias_raw | replace(' my ', ' your ')
                       | replace(' My ', ' Your ') }}
                  {%- endif -%}
                _r_truncated: >-
                  {% set text = _r_text | default('')
                      | string %}
                  {% set cap = char_limit | int(500) %}
                  {% set raw_al = aliases_map | default('')
                      | string | trim %}
                  {% set ns = namespace(body=text) %}
                  {% if raw_al | length > 0 %}
                    {% for pair in raw_al.split(',') %}
                      {% set parts = pair.split('=', 1) %}
                      {% if parts | length == 2 %}
                        {% set key = parts[0] | trim %}
                        {% set val = parts[1] | trim %}
                        {% if key | length > 0 %}
                          {% set ns.body = ns.body
                              | replace(key, val) %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  {% if ns.body | length > cap %}
                    {{ ns.body[:cap] ~ '...' }}
                  {% else %}
                    {{ ns.body }}
                  {% endif %}

            - alias: "UL-5a · Resolve ringer mode"
              variables:
                _r_ringer: >-
                  {% set ent = ringer_entity | default('')
                      | string %}
                  {% if ent | length == 0 %}normal
                  {% else %}
                    {{ states(ent) | default('normal') }}
                  {% endif %}
                _r_saved_vol: >-
                  {% if _r_has_satellite %}
                    {{ state_attr(_r_satellite, 'volume_level')
                       | default(0.5) | float(0.5) }}
                  {% else %}{{ 0.5 }}{% endif %}

            - alias: "UL-5b · Skip TTS if phone is silent"
              condition: template
              value_template: >-
                {{ _r_ringer != 'silent'
                   or (dnd_entity | default('')
                       | string | length) == 0 }}

            # =============================================================
            # UL-6 · Duck playing media
            # =============================================================
            - alias: "UL-6 · Snapshot playing media for duck"
              variables:
                _r_ducked: >-
                  {% set players = duck_player_entities
                      | default([]) %}
                  {% set ns = namespace(result=[]) %}
                  {% for p in players %}
                    {% if states(p) | default('idle')
                          == 'playing' %}
                      {% set vol = state_attr(p, 'volume_level')
                          | default(0.5) | float(0.5) %}
                      {% set ns.result = ns.result +
                          [{'entity_id': p, 'volume': vol}] %}
                    {% endif %}
                  {% endfor %}
                  {{ ns.result }}

            - alias: "UL-6a · Increment duck refcount"
              if:
                - condition: template
                  value_template: >-
                    {{ (duck_refcount_entity | default('')
                        | string | length) > 0
                       and _r_ducked | length > 0 }}
              then:
                - action: input_number.increment
                  continue_on_error: true
                  target:
                    entity_id: "{{ duck_refcount_entity }}"

            - alias: "UL-6b · Set ducking flag ON"
              if:
                - condition: template
                  value_template: >-
                    {{ (ducking_flag_entity | default('')
                        | string | length) > 0
                       and _r_ducked | length > 0 }}
              then:
                - action: input_boolean.turn_on
                  continue_on_error: true
                  target:
                    entity_id: "{{ ducking_flag_entity }}"

            - alias: "UL-6c · Duck playing players"
              if:
                - condition: template
                  value_template: "{{ _r_ducked | length > 0 }}"
              then:
                - repeat:
                    for_each: "{{ _r_ducked }}"
                    sequence:
                      - action: media_player.volume_set
                        continue_on_error: true
                        target:
                          entity_id: "{{ repeat.item.entity_id }}"
                        data:
                          volume_level: >-
                            {{ duck_vol | float(0.10) }}

            # =============================================================
            # UL-7 · Call LLM for reminder summary
            # =============================================================
            - alias: "UL-7 · Call LLM for reminder"
              continue_on_error: true
              action: conversation.process
              response_variable: reminder_llm_result
              data:
                agent_id: !input conversation_agent
                text: >-
                  {% if _is_bundled | bool(false) %}
                  {{ bundled_prompt_text }}

                  You have {{ _ledger_count }} unread
                  notifications to remind the user about.
                  Summarize ALL senders concisely in one
                  announcement. Mention each sender by name
                  and their app.
                  {% else %}
                  {{ reminder_prompt_text }}
                  {% endif %}

                  {% set _read_mode = reminder_read_mode
                      | default('paraphrase') %}
                  {% if _read_mode == 'verbatim' %}
                  Read the message text exactly as written —
                  word for word. Do not paraphrase, summarize,
                  or skip any part of the message.
                  {% elif _read_mode == 'progressive' %}
                  {% set _elapsed_iters = _fast_count | int(0)
                      + (repeat.index | int(1)) %}
                  {% if _elapsed_iters < 3 %}
                  Paraphrase the message naturally — do not
                  read it verbatim.
                  {% else %}
                  The user has ignored multiple reminders. Read
                  the message text exactly as written — word for
                  word. No paraphrasing.
                  {% endif %}
                  {% else %}
                  Do not read the message verbatim — paraphrase
                  it naturally in your own words.
                  {% endif %}

                  {% if (agent_name | default('') | string
                        | trim) | length > 0 %}
                  Your name is {{ agent_name }}. If the message
                  mentions your name, refers to "the AI", "the
                  assistant", or otherwise addresses you —
                  acknowledge it naturally in your reminder.
                  {% endif %}

                  {% set _total_elapsed = ((as_timestamp(now())
                      - (_rem_start_ts | float(0)))
                      / 60) | round(0) %}
                  This is reminder iteration {{ repeat.index }}
                  (phase: {{ _phase }}) — approximately
                  {{ _total_elapsed }} minutes since the first
                  reminder. The user has not checked their phone.

                  The message thread below is LIVE and may
                  include replies the user sent since the last
                  reminder. If the thread contains user replies,
                  acknowledge them — but still remind the user
                  to check their phone for the full conversation.

                  {% if not (_is_bundled | bool(false)) %}
                  The sender's preferred name is
                  {{ _r_display_sender }}. Refer to them
                  naturally by this name. If the preferred name
                  is a relationship phrase, always introduce
                  them with the article "the" — say "the love
                  of your life", never "your love of your life".
                  {% endif %}

                  CRITICAL: Never reproduce laughter syllables
                  or emoji characters literally — describe the
                  emotion they convey.

                  {% if _is_bundled | bool(false) %}
                  --- BEGIN UNREAD NOTIFICATIONS (LEDGER) ---
                  {% for e in _ledger_entries %}
                  {{ loop.index }}. sender: {{ e.sender
                      | replace('<', '‹')
                      | replace('>', '›') }} | app: {{ e.app
                      | replace('<', '‹')
                      | replace('>', '›') }} | {{ ((
                      as_timestamp(now()) - (e.epoch | int(0)))
                      / 60) | round(0) }} min ago
                  {% endfor %}
                  --- END UNREAD NOTIFICATIONS ---

                  The current notification thread (below) shows
                  the most recent conversation. Other senders
                  listed above may not have visible thread data
                  — mention them by name and app regardless.
                  {% endif %}

                  --- BEGIN NOTIFICATION DATA (LIVE) ---
                  sender: {{ _r_display_sender
                      | replace('<', '‹')
                      | replace('>', '›') }}
                  app: {{ app_label }}
                  message: {{ _r_truncated
                      | replace('<', '‹')
                      | replace('>', '›') }}
                  {% if include_group | bool(false) %}
                  is_group: {{ notif_is_group }}
                  {% endif %}
                  current_time: {{ now().strftime('%H:%M') }}
                  --- END NOTIFICATION DATA ---

                  --- THREAD FORMAT CONTEXT ---
                  Lines in the message thread prefixed with
                  "You:" are messages sent BY the notification
                  recipient (the person you are speaking to) —
                  not from the sender or any third party. Do not
                  treat the text after "You:" as a person's
                  name. These are the user's own outbound
                  replies.
                  --- END THREAD FORMAT CONTEXT ---

                  --- PRONOUN CONTEXT ---
                  When "you" or "tú" appears in the message
                  text, it usually refers to the notification
                  recipient — not to you. The exception is when
                  the sender addresses you by name; in that
                  case, they are speaking to you directly.
                  --- END PRONOUN CONTEXT ---
                  {% set petnames = user_petnames_list
                      | default('') | string | trim %}
                  {% if petnames | length > 0 %}

                  --- PET NAME CONTEXT ---
                  {{ petnames }}
                  --- END PET NAME CONTEXT ---
                  {% endif %}
                  {% set _expr_sens = expressive_sens
                      | default('moderate') %}

                  --- EXPRESSIVE TEXT INTERPRETATION ---
                  The message may contain informal, expressive
                  text that is NOT meant to be read literally.
                  Interpret these patterns naturally for spoken
                  delivery:
                  {% if _expr_sens == 'conservative' %}
                  Only interpret obvious laughter patterns
                  (hahaha, jajaja, LOL) and explicit emoji-only
                  messages. Leave other informal text as-is.
                  {% elif _expr_sens == 'aggressive' %}
                  Aggressively interpret ALL informal text as
                  expressive intent — elongated words, emoji
                  clusters, repeated punctuation, slang, and
                  any text that looks emotional. Convert
                  everything into natural spoken language.
                  {% else %}
                  Interpret laughter, elongated words (nooooo,
                  siiii), emoji clusters, and other clearly
                  expressive text as emotional intent. Describe
                  what the sender is expressing rather than
                  spelling out the characters.
                  {% endif %}

                  Key rules:
                  - Laughter → describe as laughter, never
                    spell out syllables
                  - Emoji-only → describe sentiment, never
                    name individual emoji
                  - Elongation → interpret emphasis, don't
                    reproduce stretching
                  - Repeated punctuation → convey energy
                    through delivery, not by reading punctuation
                  {% set _expr_ref = expressive_ref | default('')
                      | string | trim %}
                  {% if _expr_ref | length > 0 %}

                  Cultural reference patterns:
                  {{ _expr_ref }}
                  {% endif %}
                  --- END EXPRESSIVE TEXT INTERPRETATION ---
                  {% if tts_engine | default('basic')
                        == 'elevenlabs_v3' %}
                  {% set _tag_style = audio_tag_density
                      | default('moderate') %}

                  --- TTS PERFORMANCE DIRECTIVES (ElevenLabs v3) ---
                  Your output will be spoken by an ElevenLabs v3
                  voice. You may insert audio tags in square
                  brackets to direct voice performance:
                  [laughs], [whispers], [shouts], [sighs],
                  [pauses], [sarcastic], [excited], [gasps],
                  [cheerfully], [deadpan], [playfully].
                  {% if _tag_style == 'minimal' %}
                  Use tags sparingly — only for strong emotional
                  moments. Most reminders need zero tags.
                  {% elif _tag_style == 'dramatic' %}
                  Use tags liberally for theatrical delivery.
                  React, pause, emote — make it a performance.
                  {% else %}
                  Use 1-2 tags per reminder for natural emphasis.
                  Don't overdo it.
                  {% endif %}
                  Tags go inline: "[laughs] She thinks that's
                  hilarious." Never break words with tags. Never
                  end with an audio tag — always follow with
                  speech.
                  --- END TTS PERFORMANCE DIRECTIVES ---
                  {% endif %}
                  {% if burst_mode | default('thread_aware')
                        == 'thread_aware' %}

                  --- THREAD-AWARE BURST HANDLING ---
                  The thread may include messages that arrived
                  in a burst since the last announcement or
                  reminder. Focus on what is NEW — do not
                  re-summarize content already delivered. If
                  nothing is new since the last reminder, keep
                  it brief.
                  --- END THREAD-AWARE BURST HANDLING ---
                  {% endif %}

            - alias: "UL-7a · Extract LLM response"
              variables:
                _r_announcement: >-
                  {% if reminder_llm_result is defined
                        and reminder_llm_result.response
                            is defined
                        and reminder_llm_result.response
                            .speech is defined
                        and reminder_llm_result.response
                            .speech.plain is defined
                        and reminder_llm_result.response
                            .speech.plain.speech
                            is defined %}
                    {% set raw = reminder_llm_result.response
                        .speech.plain.speech | trim %}
                    {% set skip_tokens = ['SKIP_OUTGOING',
                        'SKIP_SELF', 'SKIP_JUNK',
                        'SKIP_DUPLICATE', 'SKIP_MEDIA'] %}
                    {% if raw | upper in skip_tokens %}
                      {{ '' }}
                    {% else %}
                      {{ raw }}
                    {% endif %}
                  {% else %}
                    {% if _is_bundled | bool(false) %}
                      Reminder: you have {{ _ledger_count }}
                      unread messages. Check your phone.
                    {% else %}
                      Reminder: you still have an unread
                      {{ app_label }} message from
                      {{ _r_display_sender }}. Check your phone.
                    {% endif %}
                  {% endif %}

            - alias: "UL-7b · Skip TTS if LLM returned skip token"
              condition: template
              value_template: >-
                {{ (_r_announcement | default('')
                    | string | trim | length) > 0 }}

            # =============================================================
            # UL-8 · Volume adjust + TTS delivery
            # =============================================================
            - alias: "UL-8 · Set volume (vibrate or output)"
              choose:
                - alias: "Vibrate — quiet volume"
                  conditions:
                    - condition: template
                      value_template: >-
                        {{ _r_ringer == 'vibrate'
                           and _r_has_satellite }}
                  sequence:
                    - action: media_player.volume_set
                      continue_on_error: true
                      target:
                        entity_id: "{{ _r_satellite }}"
                      data:
                        volume_level: >-
                          {{ quiet_vol | float(0.15) }}
              default:
                - alias: "Normal ringer — apply output volume"
                  if:
                    - condition: template
                      value_template: >-
                        {{ tts_output_vol | float(0) > 0
                           and _r_has_satellite }}
                  then:
                    - action: media_player.volume_set
                      continue_on_error: true
                      target:
                        entity_id: "{{ _r_satellite }}"
                      data:
                        volume_level: >-
                          {{ tts_output_vol | float(0.5) }}

            - alias: "UL-8a · Deliver TTS or push"
              choose:
                - alias: "Satellite — TTS speak"
                  conditions:
                    - condition: template
                      value_template: "{{ _r_has_satellite }}"
                  sequence:
                    - alias: "TTS speak"
                      action: tts.speak
                      continue_on_error: true
                      target:
                        entity_id: "{{ tts_entity }}"
                      data: >-
                        {% set msg = _r_announcement %}
                        {% if tts_mode
                            == 'elevenlabs_custom_service' %}
                          {% if tts_announce | bool(false) %}
                            {{ {"message": msg,
                                "media_player_entity_id":
                                  _r_satellite,
                                "options":
                                  {"voice_profile":
                                    voice_profile},
                                "announce": true} }}
                          {% else %}
                            {{ {"message": msg,
                                "media_player_entity_id":
                                  _r_satellite,
                                "options":
                                  {"voice_profile":
                                    voice_profile}} }}
                          {% endif %}
                        {% else %}
                          {% if tts_announce | bool(false) %}
                            {{ {"message": msg,
                                "media_player_entity_id":
                                  _r_satellite,
                                "announce": true} }}
                          {% else %}
                            {{ {"message": msg,
                                "media_player_entity_id":
                                  _r_satellite} }}
                          {% endif %}
                        {% endif %}

                - alias: "No satellite — mobile push"
                  conditions:
                    - condition: template
                      value_template: >-
                        {{ not _r_has_satellite
                           and fallback == 'mobile_push'
                           and (mobile_service | default('')
                               | string | length) > 0 }}
                  sequence:
                    - action: "{{ mobile_service }}"
                      continue_on_error: true
                      data:
                        title: >-
                          {% if _is_bundled | bool(false) %}
                          Reminder: {{ _ledger_count }} unread
                          {% else %}
                          Reminder: {{ app_label }}
                          — {{ _r_display_sender }}
                          {% endif %}
                        message: "{{ _r_announcement }}"

            # =============================================================
            # UL-9 · Wait playback + restore volumes
            # =============================================================
            - alias: "UL-9 · Wait for playback to finish"
              if:
                - condition: template
                  value_template: >-
                    {{ _r_has_satellite
                       and (_r_ringer == 'vibrate'
                            or tts_output_vol | float(0) > 0
                            or _r_ducked | default([])
                               | length > 0) }}
              then:
                - alias: "Poll satellite until idle"
                  repeat:
                    until:
                      - condition: template
                        value_template: >-
                          {{ states(_r_satellite)
                             | default('idle')
                             not in ['playing']
                             or repeat.index
                                >= (restore_delay
                                    | int(8)) }}
                    sequence:
                      - delay:
                          seconds: 1

            - alias: "UL-9a · Decrement duck refcount"
              if:
                - condition: template
                  value_template: >-
                    {{ (duck_refcount_entity | default('')
                        | string | length) > 0
                       and _r_ducked | default([])
                          | length > 0 }}
              then:
                - action: input_number.decrement
                  continue_on_error: true
                  target:
                    entity_id: "{{ duck_refcount_entity }}"

            - alias: "UL-9b · Resolve restore permission"
              variables:
                _r_is_last_duck: >-
                  {% set rc = duck_refcount_entity
                      | default('') | string %}
                  {{ rc | length == 0
                     or states(rc) | int(0) <= 0 }}
                _r_restore_sat_vol: >-
                  {% set helper = sat_vol_snapshot_entity
                      | default('') | string %}
                  {% if helper | length > 0 %}
                    {% set raw = states(helper) | default('')
                        | string | trim %}
                    {% if raw not in ['unknown',
                          'unavailable', ''] %}
                      {{ raw | float(0.5) }}
                    {% else %}
                      {{ _r_saved_vol | float(0.5) }}
                    {% endif %}
                  {% else %}
                    {{ _r_saved_vol | float(0.5) }}
                  {% endif %}
                _r_restore_players: >-
                  {% set helper = duck_snapshot_entity
                      | default('') | string %}
                  {% if helper | length > 0 %}
                    {% set raw = states(helper) | default('')
                        | string | trim %}
                    {% if raw not in ['unknown',
                          'unavailable', '']
                          and raw[0:1] == '[' %}
                      {{ raw | from_json
                         | default(_r_ducked | default([])) }}
                    {% else %}
                      {{ _r_ducked | default([]) }}
                    {% endif %}
                  {% else %}
                    {{ _r_ducked | default([]) }}
                  {% endif %}
