# üè† Casa Madalone ‚Äî Home Assistant Configuration

![Casa Madalone](https://raw.githubusercontent.com/mmadalone/HA-Master-Repo/main/images/header/casa-madalone-header.jpeg)

A fully AI-assisted smart home running on Home Assistant, featuring custom voice assistants with distinct personalities, presence-based music routing, and a bedtime negotiation system that argues with you about going to sleep.

All code in this repository is generated by **Claude 4.6** (Anthropic). All images are generated by **Google Gemini**.
Many of these blueprints are still in testing phase.

---

## The Setup

**Hardware:**
- Raspberry Pi 5 running Home Assistant
- 2√ó Home Assistant Voice Preview Edition (workshop + living room)
- 2√ó Aqara FP2 presence sensors (multi-zone: workshop/entrance/kitchen, living room/bedroom, bathroom shower/sink/toilet)
- Aqara G3 camera hub
- Sonos Era 100 (workshop)
- Sonos Roam 2 (bathroom)
- GL-MT6000 router
- APC UPS (backing the entire HA stack)
- Assorted Alexa devices

**Key Integrations:**
- [Extended OpenAI Conversation](https://github.com/jekalmin/extended_openai_conversation) ‚Äî LLM-driven conversation agents with tool calling and custom personas
- OpenAI (GPT-4o) ‚Äî LLM backend for conversation agents
- ElevenLabs ‚Äî text-to-speech with custom character voices
- Music Assistant ‚Äî multi-room audio management
- ESPHome ‚Äî device firmware and voice pipelines
- [microWakeWord](https://github.com/kahrendt/microWakeWord) ‚Äî on-device custom wake word detection

---

## Voice Assistants

Two AI personalities run the house, each with a dedicated room, conversation agent, and ElevenLabs TTS voice. What makes it interesting is the **dual wake word system** ‚Äî each persona has two wake words that route to different agent configurations:

**Rick Sanchez** ‚Äî Workshop satellite
Nihilistic genius scientist. Sarcastic, perpetually annoyed, curses freely. Will help you but makes sure you know it's beneath him.

- *"Hey Rick"* ‚Üí concise responses, quick commands
- *"Yo Rick"* ‚Üí verbose mode, detailed answers and longer conversations

**Quark** ‚Äî Living room satellite
Ferengi bartender from Deep Space Nine. Sees everything through the lens of profit and the Rules of Acquisition. Scheming but ultimately helpful.

- *"Hey Quark"* ‚Üí concise responses, quick commands
- *"Yo Quark"* ‚Üí verbose mode, detailed answers and longer conversations

The "Hey" wake words route to the standard agent ‚Äî fast, short answers for things like "Hey Rick, what time is it?" The "Yo" wake words route to the verbose agent variant ‚Äî longer, more detailed responses with expanded tool access for when you want an actual conversation or need the agent to do something complex.

All four custom wake word models are trained with [microWakeWord](https://github.com/kahrendt/microWakeWord) and run on-device on the Voice PE's ESP32-S3. The trained models are available in the [mmadalone/microwakeword](https://github.com/mmadalone/microwakeword) repository. Each satellite also retains the default *"Okay Nabu"* wake word from the base Voice PE package.

---

## Conversation Agents

All agents run through [Extended OpenAI Conversation](https://github.com/jekalmin/extended_openai_conversation) with GPT-4o as the LLM backend, extensive system prompts defining each persona's personality, and ElevenLabs custom voices for TTS output. Agent names follow a `<Persona> - <Integration> - <Variant>` naming convention.

**Pipeline agents** ‚Äî triggered by wake words through the voice satellite:

| Agent | Triggered by | Role |
|-------|-------------|------|
| Rick - Extended | *"Hey Rick"* | General-purpose, concise workshop assistant |
| Rick - Extended - Verbose | *"Yo Rick"* | Detailed responses, expanded tool access |
| Quark - Extended | *"Hey Quark"* | General-purpose, concise living room assistant |
| Quark - Extended - Verbose | *"Yo Quark"* | Detailed responses, expanded tool access |

**Music-specialized:**

| Agent | Role |
|-------|------|
| Rick - Extended - Verbose - Music | Music control with exposed Music Assistant tool scripts ‚Äî play, stop, skip, volume, search |

**Scenario agents** ‚Äî called by blueprints via `conversation.process`, not directly by wake words:

| Agent | Called by | Role |
|-------|----------|------|
| Rick - Extended - Coming Home | Coming Home blueprint | Arrival greeting, helps set up lights/TV/music |
| Rick - Extended - Bedtime | Bedtime Negotiator blueprint | Bedtime routine negotiation, Rick style |
| Quark - Extended - Bedtime | Bedtime Negotiator blueprint | Bedtime routine negotiation, Quark style |

**Anthropic/Claude agents** (configured but not yet tested with blueprints):

| Agent | Role |
|-------|------|
| Rick - Anthropic | Claude-based Rick, general purpose |
| Quark - Anthropic | Claude-based Quark, general purpose |

The general-purpose agents use `execute_services` for basic HA service calls. The music and scenario-specific agents have dedicated HA scripts exposed as callable tools (e.g., `voice_stop_radio`, `voice_play_bedtime_audiobook`, `voice_shut_up`) ‚Äî the agent calls the script, the script handles the actual service call with proper error handling. See the style guide's ¬ß8.3.2 for the script-as-tool pattern.

**Compatibility note:** All LLM-driven blueprints (Bedtime Negotiator, Coming Home, Voice Music Control, Escalating Wake-Up Guard) have been tested exclusively with Extended OpenAI Conversation and GPT-4o. The Anthropic/Claude conversation agents are configured but have not yet been validated with the blueprint toolchains.

---

## Notable Automations & Blueprints

### üéµ Music Follow-Me
Presence-based multi-room audio routing. Music follows you between rooms using Aqara FP2 zone detection, with configurable priority ordering, cooldown timers, and multi-person detection that disables following when 3+ sensors are active. Supports mixed ecosystems (Sonos + Voice PE) with the understanding that cross-protocol sync is impossible.

### üõèÔ∏è Bedtime Negotiator
A multi-stage bedtime routine blueprint that uses the AI conversation agent to negotiate with the user. Features include:
- Contextual opening lines based on time and room
- Trust mode that remembers your preferences
- TV shutdown with ask/skip/auto logic
- Conversational media selection (audiobooks, podcasts, music) via Music Assistant search
- Sleep timers and gradual wind-down
- ~1900 lines of YAML. Yes, really.

### üé§ Voice-Controlled Music Assistant
Full voice control over MA with play/pause, search, genre/mood playback, shuffle/repeat, volume management, and multi-language support (English + German). Includes "play something else" cycling through search results.

### üì° Volume Ducking
Automatic volume management for TTS announcements ‚Äî saves current volume state, ducks media, plays the announcement, restores volume. Handles the race condition between TTS completion and volume restore.

---

## Style Guide

The `/HA Master Style Guide/` directory contains a comprehensive YAML generation style guide used by AI agents (primarily Claude) when generating Home Assistant configurations. It covers:

| File | Contents |
|------|----------|
| `00_core_philosophy.md` | Directive precedence, safety rules, coding principles |
| `01_blueprint_patterns.md` | Blueprint structure, selectors, input sections, min_version |
| `02_automation_patterns.md` | Triggers, conditions, actions, presence patterns, GPS handling |
| `03_conversation_agents.md` | OpenAI integration, multi-agent coordination, return values |
| `04_esphome_patterns.md` | Device configs, packages, wake words, OTA |
| `05_music_assistant_patterns.md` | MA integration, enqueue modes, TTS coexistence |
| `06_anti_patterns_and_workflow.md` | Common mistakes, deprecation tracking, migration paths |
| `07_troubleshooting.md` | Debugging patterns, trace analysis |
| `08_voice_assistant_pattern.md` | 6-layer voice architecture, ElevenLabs fallback, TTS streaming |
| `09_qa_audit_checklist.md` | QA checks, audit triggers, user commands (`run audit`, `check secrets`, etc.) |

The guide is opinionated ‚Äî it enforces `!secret` usage in all examples, requires action aliases for trace debugging, mandates error handling on network calls, and includes AI-readability checks specifically designed for vibe coding workflows.

---

## Attribution & Credits

**Integrations & Tools:**
- [Extended OpenAI Conversation](https://github.com/jekalmin/extended_openai_conversation) by jekalmin ‚Äî the conversation agent integration that powers all LLM-driven voice interactions, tool registration, and multi-agent coordination
- [microWakeWord](https://github.com/kahrendt/microWakeWord) by Kevin Ahrendt ‚Äî on-device wake word detection engine for ESP32-S3, used to train all four custom persona wake words
- [Music Assistant](https://music-assistant.io/) ‚Äî multi-room audio management, play_media service, and queue control
- [ESPHome](https://esphome.io/) ‚Äî device firmware framework for Voice PE satellites
- [Nabu Casa Voice PE](https://github.com/esphome/home-assistant-voice-pe) ‚Äî base ESPHome packages for Home Assistant Voice Preview Edition hardware
- [ElevenLabs](https://elevenlabs.io/) ‚Äî custom TTS voices for Rick and Quark personas

**Blueprint Inspiration:**
- [brix29/ha_music_voice_control_spotifyplus](https://github.com/brix29/ha_music_voice_control_spotifyplus) ‚Äî voice control patterns for SpotifyPlus
- [Phil Hawthorne's music follow-me concept](https://philhawthorne.com/making-music-follow-you-around-the-home-with-home-assistant-and-sonos/) ‚Äî presence-based audio routing inspiration
- Home Assistant community blueprints exchange ‚Äî various patterns and approaches

**Custom Wake Word Models:**
- Trained models for *Hey Rick*, *Yo Rick*, *Hey Quark*, and *Yo Quark* are available at [mmadalone/microwakeword](https://github.com/mmadalone/microwakeword)

**Cultural References:**
- *Star Trek: Deep Space Nine* (Paramount) ‚Äî Quark, the Ferengi Rules of Acquisition, and the style guide's personality
- *Rick and Morty* (Adult Swim) ‚Äî Rick Sanchez persona and collaborative imagery

If you recognize your work here and I haven't credited you, please reach out and I'll fix it immediately.

---

## How It's Built

This entire configuration is **vibe coded** ‚Äî built through conversational AI sessions with Claude 4.6. The style guide exists specifically to keep AI-generated YAML consistent, safe, and debuggable across sessions. The QA audit checklist (`09_qa_audit_checklist.md`) runs automatically during generation and can be triggered manually with commands like `run audit` or `check secrets`.

No YAML in this repository was written by hand. Every line was generated, reviewed, and iterated through conversation with Claude.

---

## License

This is a personal home automation configuration shared for reference and inspiration. Use whatever's useful to you. If you build on any of the blueprints, a mention would be appreciated but isn't required.
