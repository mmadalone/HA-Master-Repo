# üè† Casa Madalone ‚Äî Home Assistant Configuration

A fully AI-assisted smart home running on Home Assistant, featuring custom voice assistants with distinct personalities, presence-based music routing, and a bedtime negotiation system that argues with you about going to sleep.

All code in this repository is generated by **Claude 4.6** (Anthropic). All images are generated by **Google Gemini**.
Many of these are still in testing phase.

---

## The Setup

**Hardware:**
- Raspberry Pi 5 running Home Assistant
- 2√ó Home Assistant Voice Preview Edition (workshop + living room)
- 2√ó Aqara FP2 presence sensors (multi-zone: workshop/entrance/kitchen, living room/bedroom, bathroom shower/sink/toilet)
- Aqara G3 camera hub
- Sonos Era 100 (workshop)
- Sonos Roam 2 (bathroom)
- GL-MT6000 router
- APC UPS (backing the entire HA stack)
- Assorted Alexa devices

**Key Integrations:**
- OpenAI (GPT-4o) ‚Äî conversation agents with custom personas
- ElevenLabs ‚Äî text-to-speech with character voices
- Music Assistant ‚Äî multi-room audio management
- ESPHome ‚Äî device firmware and voice pipeline

---

## Voice Assistants

Two AI personalities run the house, each with a dedicated wake word, conversation agent, and TTS voice:

**Rick Sanchez** ‚Äî Wake word: *"Hey Rick"*
Nihilistic genius scientist. Sarcastic, perpetually annoyed, curses freely. Will help you but makes sure you know it's beneath him. Handles the workshop and general-purpose commands.

**Quark** ‚Äî Wake word: *"Hey Quark"*
Ferengi bartender from Deep Space Nine. Sees everything through the lens of profit and the Rules of Acquisition. Scheming but ultimately helpful. Handles living room and bedtime routines.

Both run through OpenAI's conversation agent with extensive system prompts and ElevenLabs custom voices.

---

## Notable Automations & Blueprints

### üéµ Music Follow-Me
Presence-based multi-room audio routing. Music follows you between rooms using Aqara FP2 zone detection, with configurable priority ordering, cooldown timers, and multi-person detection that disables following when 3+ sensors are active. Supports mixed ecosystems (Sonos + Voice PE) with the understanding that cross-protocol sync is impossible.

### üõèÔ∏è Bedtime Negotiator
A multi-stage bedtime routine blueprint that uses the AI conversation agent to negotiate with the user. Features include:
- Contextual opening lines based on time and room
- Trust mode that remembers your preferences
- TV shutdown with ask/skip/auto logic
- Conversational media selection (audiobooks, podcasts, music) via Music Assistant search
- Sleep timers and gradual wind-down
- ~1900 lines of YAML. Yes, really.

### üé§ Voice-Controlled Music ssistant
Full voice control over MA with play/pause, search, genre/mood playback, shuffle/repeat, volume management, and multi-language support (English + German). Includes "play something else" cycling through search results.

### üì° Volume Ducking
Automatic volume management for TTS announcements ‚Äî saves current volume state, ducks media, plays the announcement, restores volume. Handles the race condition between TTS completion and volume restore.

---

## Style Guide

The `/HA Master Style Guide/` directory contains a comprehensive YAML generation style guide used by AI agents (primarily Claude) when generating Home Assistant configurations. It covers:

| File | Contents |
|------|----------|
| `00_core_philosophy.md` | Directive precedence, safety rules, coding principles |
| `01_blueprint_patterns.md` | Blueprint structure, selectors, input sections, min_version |
| `02_automation_patterns.md` | Triggers, conditions, actions, presence patterns, GPS handling |
| `03_conversation_agents.md` | OpenAI integration, multi-agent coordination, return values |
| `04_esphome_patterns.md` | Device configs, packages, wake words, OTA |
| `05_music_assistant_patterns.md` | MA integration, enqueue modes, TTS coexistence |
| `06_anti_patterns_and_workflow.md` | Common mistakes, deprecation tracking, migration paths |
| `07_troubleshooting.md` | Debugging patterns, trace analysis |
| `08_voice_assistant_pattern.md` | 6-layer voice architecture, ElevenLabs fallback, TTS streaming |
| `09_qa_audit_checklist.md` | QA checks, audit triggers, user commands (`run audit`, `check secrets`, etc.) |

The guide is opinionated ‚Äî it enforces `!secret` usage in all examples, requires action aliases for trace debugging, mandates error handling on network calls, and includes AI-readability checks specifically designed for vibe coding workflows.

---

## Attribution & Credits

Some blueprints in this repository are based on or inspired by community-contributed work. I haven't yet done a proper audit to credit every original author ‚Äî that's on my to-do list and I'll update this section with proper attribution once I've traced everything back to its source. If you recognize your work here and I haven't credited you, I apologize ‚Äî please reach out and I'll fix it immediately.

Known influences and sources:
- [brix29/ha_music_voice_control_spotifyplus](https://github.com/brix29/ha_music_voice_control_spotifyplus) ‚Äî voice control patterns for SpotifyPlus
- [Phil Hawthorne's music follow-me concept](https://philhawthorne.com/making-music-follow-you-around-the-home-with-home-assistant-and-sonos/) ‚Äî presence-based audio routing inspiration
- Home Assistant community blueprints exchange ‚Äî various patterns and approaches

---

## How It's Built

This entire configuration is **vibe coded** ‚Äî built through conversational AI sessions with Claude 4.6. The style guide exists specifically to keep AI-generated YAML consistent, safe, and debuggable across sessions. The QA audit checklist (`09_qa_audit_checklist.md`) runs automatically during generation and can be triggered manually with commands like `run audit` or `check secrets`.

No YAML in this repository was written by hand. Every line was generated, reviewed, and iterated through conversation with Claude.

---

## License

This is a personal home automation configuration shared for reference and inspiration. Use whatever's useful to you. If you build on any of the blueprints, a mention would be appreciated but isn't required.
