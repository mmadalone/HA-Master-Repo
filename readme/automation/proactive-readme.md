# Proactive – Presence-based suggestions

![Proactive header](https://raw.githubusercontent.com/mmadalone/HA-Master-Repo/main/images/header/proactive-header.jpeg)

When presence is detected in an area during a configured time window, this blueprint proactively speaks a TTS message drawn from pre-populated `input_text` helpers (morning, afternoon, and evening). Messages can be generated by a separate AI automation and refreshed after each delivery. The blueprint includes configurable cooldown, nag-while-present mode, and an optional bedtime yes/no question via Assist Satellite that can trigger a bedtime routine script.

> **Companion blueprint:** [Proactive – Direct LLM](../proactive_llm-readme.md) generates messages on the fly via a conversation agent instead of reading from input_text helpers. Choose this variant when you want pre-cached messages with lower latency; choose Direct LLM when you want fresh context-aware generation every time.

## How It Works

```
┌─────────────────────────────────────────────────────────┐
│                    TRIGGER LAYER                        │
│  ┌──────────────┐ ┌────────────┐ ┌───────────────────┐  │
│  │ Presence ON  │ │ /5 min tick│ │ start_time daily  │  │
│  │ (any sensor) │ │ (nag mode) │ │ (bedtime only)    │  │
│  └──────┬───────┘ └─────┬──────┘ └────────┬──────────┘  │
└─────────┼───────────────┼─────────────────┼─────────────┘
          │               │                 │
          ▼               ▼                 ▼
┌─────────────────────────────────────────────────────────┐
│                   CONDITION GATE                        │
│  • Within active time window?                           │
│  • Presence still detected?                             │
│  • Periodic tick → repeat mode on?                      │
│  • Bedtime trigger → bedtime mode enabled?              │
│  • Cooldown elapsed? Max nags not exceeded?             │
└────────────────────────┬────────────────────────────────┘
                         │ all pass
                         ▼
┌─────────────────────────────────────────────────────────┐
│                   ACTION SEQUENCE                       │
│  1. Resolve time-of-day → pick input_text helper        │
│  2. Build message (or use fallback if helper is empty)  │
│  3. Speak via chosen TTS mode (standard or ElevenLabs)  │
│  4. If refresh enabled → press refresh button           │
│  5. If bedtime enabled:                                 │
│     a. Wait for TTS to finish                           │
│     b. Ask yes/no via Assist Satellite                  │
│     c. If "yes" → run bedtime script                    │
└─────────────────────────────────────────────────────────┘
```

## Key Design Decisions

### Pre-cached messages vs. live LLM generation
This variant reads messages from `input_text` helpers that are populated by a separate automation (typically an LLM refresh cycle). This gives near-instant TTS delivery with no API latency at speak time. The companion Direct LLM variant trades latency for freshness — it calls the conversation agent on every trigger.

### Triple trigger architecture
Three triggers serve different entry paths: presence-on for first arrival, a 5-minute time_pattern for nagging while present, and a daily time trigger for bedtime mode. Each trigger has its own condition gate so non-applicable triggers are filtered cheaply before the action sequence runs.

### Session-aware nag limiting
The max-nags logic doesn't use a counter helper — it infers nag count from the duration of the current presence session relative to the cooldown interval. This avoids stale counter state if the automation restarts mid-session.

## Features

- **Time-of-day message selection** — automatically picks morning, afternoon, or evening message based on current hour (or always evening in bedtime mode).
- **Dual TTS mode support** — standard `tts.speak` entity or ElevenLabs custom integration with voice profile selection.
- **Configurable nag behavior** — one-shot on arrival, or repeated at the cooldown interval with an optional nag limit per session.
- **Post-run message refresh** — optionally presses an `input_button` after speaking to trigger AI message regeneration.
- **Bedtime question flow** — asks a yes/no question via Assist Satellite and runs a configurable bedtime script on "yes."
- **Fallback messages** — if an `input_text` helper is empty, unavailable, or unknown, speaks a built-in default referencing the area name.
- **TTS fallback branch** — unknown TTS modes log a warning and fall back to standard TTS rather than silently failing.

## Prerequisites

- **Home Assistant 2024.10.0+** (Assist Satellite support)
- **Presence sensors** — binary sensors for room presence (e.g., Aqara FP2 room groups)
- **TTS integration** — any `tts.*` entity, or the HACS ElevenLabs custom integration for voice profile support
- **input_text helpers** — three per area (morning, afternoon, evening) to store messages
- **Optional:** input_button helper for refresh trigger, Assist Satellite entity for bedtime questions, bedtime routine script

## Installation

1. Copy `proactive.yaml` to `config/blueprints/automation/madalone/`.
2. Reload blueprints: **Settings → Automations & Scenes → Blueprints → ⟳**.
3. Create a new automation from the **"Proactive – Presence-based suggestions"** blueprint.
4. Or import directly via: `https://github.com/mmadalone/HA-Master-Repo/blob/main/automation/proactive.yaml`

## Configuration

### ① Detection
| Input | Default | Description |
|-------|---------|-------------|
| Presence sensors | _(empty)_ | Binary sensors indicating presence in this area |
| Area name | _(empty)_ | Friendly name used in fallback messages |

### ② TTS Configuration
| Input | Default | Description |
|-------|---------|-------------|
| Speaker / media player | _(none)_ | Media player entity for TTS output |
| TTS mode | `standard_tts_entity` | Standard TTS or ElevenLabs custom service |
| TTS entity | _(none)_ | TTS entity for `tts.speak` calls |
| ElevenLabs voice profile | _(empty)_ | Voice profile name for ElevenLabs custom mode |

### ③ Schedule & Timing
| Input | Default | Description |
|-------|---------|-------------|
| Active from | `08:00:00` | Start of daily active window |
| Active until | `23:00:00` | End of daily active window (supports cross-midnight) |
| Cooldown / nag interval | `30` min | Minimum minutes between messages |

### ④ Nagging Behavior
| Input | Default | Description |
|-------|---------|-------------|
| Keep nagging while present | `false` | Repeat messages at cooldown interval while presence holds |
| Max nags per session | `0` (unlimited) | Stop nagging after N messages per presence session |

### ⑤ Message Sources
| Input | Default | Description |
|-------|---------|-------------|
| Morning message input_text | _(none)_ | input_text storing morning message |
| Afternoon message input_text | _(none)_ | input_text storing afternoon message |
| Evening message input_text | _(none)_ | input_text storing evening message |
| Refresh messages after each run | `false` | Press refresh button after speaking |
| Refresh button | _(none)_ | input_button that triggers message regeneration |

### ⑥ Bedtime Question
| Input | Default | Description |
|-------|---------|-------------|
| Ask bedtime question | `false` | Enable yes/no question after TTS |
| Delay before question | `5` sec | Wait for TTS audio to finish before asking |
| Assist Satellite | _(none)_ | Voice PE entity for the question |
| Question text | _"Miquel, do you want me to help you go to bed now?"_ | The yes/no question spoken |
| Bedtime script | _(none)_ | Script to run on "yes" answer |

## Comparison with Direct LLM Variant

| Feature | Proactive (this) | Proactive – Direct LLM |
|---------|-----------------|----------------------|
| Message source | Pre-cached input_text helpers | Live LLM generation per trigger |
| Latency | Near-instant (no API call at speak time) | 2–5s (conversation.process call) |
| Context freshness | Depends on refresh cycle | Always current |
| API cost per speak | Zero | One LLM call |
| Refresh mechanism | Optional input_button press | Built-in (every trigger) |
| Prompt customization | Via separate refresh automation | Inline prompt input |

## Technical Notes

- **Automation mode:** `single` / `max_exceeded: silent` — prevents overlapping runs if presence flaps.
- **Template safety:** All `states()` calls use `| default('', true)` to handle unavailable/unknown entities gracefully.
- **Bedtime answer handling:** Uses `continue_on_error: true` on `assist_satellite.ask_question` — if the satellite is unresponsive or times out, the automation completes without crashing.
- **TTS fallback:** The `choose` block includes a `default:` branch that logs a `system_log.write` warning and falls back to standard TTS if an unknown `tts_mode` is somehow configured.
- **Bedtime trigger gating:** The `bedtime_time` trigger (daily at `start_time`) is gated by a condition so it only fires when `enable_bedtime_question` is true. Non-bedtime instances ignore it.

## Changelog

- **v6:** Audit fixes — added `source_url`, TTS `choose` default fallback branch, gated bedtime trigger on `enable_bedtime_question`, companion README.
- **v5:** Collapsible section audit — added `collapsed:` to all sections, defaults on all entity inputs.
- **v4:** Style guide compliance — collapsible sections, modern syntax, template safety.
- **v3:** Added bedtime question via Assist Satellite, nag limits.
- **v2:** Added ElevenLabs custom TTS mode, refresh button support.

## Author

**madalone**

## License

MIT
