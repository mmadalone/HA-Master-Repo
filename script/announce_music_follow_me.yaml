blueprint:
  name: Announce Music Follow Me â€“ TTS (v2.0)
  description: |
    ![Announce Music Follow Me](https://raw.githubusercontent.com/mmadalone/HA-Master-Repo/main/images/header/announce-music-follow-me-header.jpeg)

    ## Announce Music Follow Me â€“ TTS

    Announces via TTS where the music was moved for the
    "Music Assistant â€“ Follow Me" automation.

    ### Features
    - Works with any TTS entity (Piper, ElevenLabs, etc.).
    - Editable random Rick/Quark-style messages (one per list entry).
    - Optional single default message for non-random mode.
    - ElevenLabs-friendly options:
      - Official: `voice` (via options.voice).
      - Custom: `voice_profile` (via options.voice_profile).
      - If voice_profile is set, voice is NOT sent.

    ### Placeholders
    - `{player_name}`   â†’ Friendly name of the target player
    - `{target_player}` â†’ Entity ID of the target player

    ### Version / Changelog
    - **v2.0** â€” Full style-guide compliance: collapsible sections, `action:` syntax,
      aliases, `continue_on_error`, template safety, DRY fallback, header image,
      version tagging.
    - **v1.0** â€” Initial release.

  domain: script
  source_url: https://github.com/mmadalone/HA-Master-Repo/blob/main/script/announce_music_follow_me.yaml
  homeassistant:
    min_version: 2024.6.0

  input:
    tts_configuration:
      name: "ðŸŽ™ï¸ TTS Configuration"
      icon: mdi:account-voice
      collapsed: false
      input:
        tts_entity:
          name: TTS entity
          description: >
            The TTS entity to use for announcements (e.g. ElevenLabs, Piper,
            your Rick/Quark TTS). Example: tts.elevenlabs_tts,
            tts.elevenlabs_custom_tts.
          default:
          selector:
            entity:
              domain: tts

    message_settings:
      name: "ðŸ’¬ Message Settings"
      icon: mdi:message-text
      collapsed: true
      input:
        use_random_messages:
          name: Use random fun messages
          description: >
            If enabled, the script will use a random message from the list
            below. If disabled, it will use the "Default message template".
          default: true
          selector:
            boolean: {}

        custom_random_messages:
          name: Random messages (editable list)
          description: >
            YAML list of messages. Used when "Use random fun messages" is
            enabled. Use {player_name} and/or {target_player} as placeholders.
            If you clear this list, a built-in set of Rick-style defaults
            is used.
          default:
            - "Rick here. Moving the music to {player_name}. Try to keep up."
            - "Quark here. I moved your music to {player_name}. Your latinum is in good hands."
            - "Music transferred to {player_name}. Don't screw this up."
            - "Yo! Your tunes are now blasting in {player_name}."
            - "Portal opened. Music jumped to {player_name}."
          selector:
            object: {}

        default_message:
          name: Default message template (non-random mode)
          description: >
            Used when "Use random fun messages" is OFF.
            Use {player_name} and/or {target_player} as placeholders.
          default: "Moving the music to {player_name}."
          selector:
            text:
              multiline: true

    elevenlabs_options:
      name: "ðŸ”Š ElevenLabs Options"
      icon: mdi:microphone-settings
      collapsed: true
      input:
        elevenlabs_voice:
          name: ElevenLabs voice (official integration only)
          description: >
            For the OFFICIAL ElevenLabs integration (tts.elevenlabs):
            Sets the `voice` option of tts.speak (voice ID or voice name).
            Ignored if a custom voice_profile is set.
          default: ""
          selector:
            text: {}

        elevenlabs_voice_profile:
          name: ElevenLabs custom voice profile (custom integration)
          description: >
            For CUSTOM ElevenLabs integrations (e.g.
            tts.elevenlabs_custom_tts): Sets the `voice_profile` option of
            tts.speak. When this is set, the `voice` option is NOT sent.
          default: ""
          selector:
            text: {}

mode: queued
max_exceeded: silent

fields:
  target_player:
    name: Target player
    description: >
      Media player where the music was moved, or where to play this test
      announcement when running the script manually.
    example: media_player.workshop
    selector:
      entity:
        domain: media_player

variables:
  tts_entity_id: !input tts_entity
  random_mode: !input use_random_messages
  custom_msgs: !input custom_random_messages
  default_msg_template: !input default_message
  el_voice: !input elevenlabs_voice
  el_voice_profile: !input elevenlabs_voice_profile
  fallback_messages:
    - "Rick here. Moving the music to {player_name}. Try to keep up."
    - "Quark here. I moved your music to {player_name}. Your latinum is in good hands."
    - "Music transferred to {player_name}. Don't screw this up."
    - "Yo! Your tunes are now blasting in {player_name}."
    - "Portal opened. Music jumped to {player_name}."

sequence:
  - alias: "Announce music follow-me via TTS"
    action: tts.speak
    continue_on_error: true
    target:
      entity_id: "{{ tts_entity_id }}"
    data:
      media_player_entity_id: "{{ target_player }}"
      message: >
        {{
          (
            custom_msgs
            if (random_mode | bool)
            else [default_msg_template | default('Moving the music to {player_name}.', true)]
          )
          | default(fallback_messages, true)
          | random
          | replace(
              '{player_name}',
              state_attr(target_player, 'friendly_name')
                | default(target_player, true)
            )
          | replace('{target_player}', target_player)
        }}
      options:
        voice: >
          {{
            el_voice
            if (not el_voice_profile) and el_voice
            else omit
          }}
        voice_profile: >
          {{
            el_voice_profile
            if el_voice_profile
            else omit
          }}
