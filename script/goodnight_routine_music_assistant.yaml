blueprint:
  name: "Goodnight Routine – Bedtime Negotiator (Music Assistant)"
  author: madalone
  description: >
    ![Image](https://raw.githubusercontent.com/mmadalone/HA-Master-Repo/main/images/header/goodnight_routine_music_assistant-header.jpeg)

    # Goodnight Routine – Bedtime Negotiator (Music Assistant)

    Interactive voice-driven goodnight routine with multi-stage negotiation.
    Uses assist_satellite.ask_question for conversational YES/NO flow on a
    Voice PE satellite — perfect for bedtime automation with personality.

    **Flow:**

    1. Optional pre-announcement (manual text or AI input_text helper).

    2. Stage 1 – Devices: ask to switch off lights/switches/media players.

    3. Stage 2 – IR Devices: ask to run IR off scripts (TV, amp, etc.).

    4. Stage 3 – Music / Bedtime Story: ask if you want audio, then branch
       by music mode (single preset, multi-preset choice, dynamic input_text,
       or free-text voice search via Music Assistant).

    5. Optional post-announcement (manual text or AI input_text helper).

    Each stage is independently toggleable. Question text, YES confirm, and
    NO confirm messages are all editable — and each can optionally source its
    text from an input_text helper for AI-refreshed messages.

    ### Recent changes

    - **v2.0.0:** Full compliance rebuild — collapsible input sections (①–⑥),
      alias on every action step, continue_on_error on all external calls,
      states() default guards, deduplicated music playback block, removed dead
      music_allowed variable, fixed Stage 2→3 coupling bug (IR NO no longer
      blocks music), source_url + min_version + header image added.

  domain: script
  source_url: https://github.com/mmadalone/HA-Master-Repo/blob/main/script/goodnight_routine_music_assistant.yaml
  homeassistant:
    min_version: "2024.10.0"

  input:
    # =========================================================================
    # ① CORE SETTINGS
    # =========================================================================
    core_settings:
      name: "① Core Settings"
      icon: mdi:cog
      collapsed: false
      description: >
        Voice satellite, TTS engine, speaker, and device targets for
        the goodnight routine stages.
      input:
        music_assist_satellite:
          name: Assist Satellite for all questions
          description: >
            Assist Satellite (Voice PE) that asks the devices/IR/music
            questions, listens for answers, and speaks confirm messages.
            Should be the satellite near your bed.
          default: ""
          selector:
            entity:
              domain: assist_satellite

        tts_entity:
          name: TTS entity
          description: >
            TTS entity for tts.speak (e.g. tts.elevenlabs_custom_tts).
            Used for pre/post announcements when satellite mode is disabled.
          default: ""
          selector:
            entity:
              domain: tts

        tts_media_player:
          name: Speaker for TTS
          description: >
            Media player to speak from for pre/post announcements when
            not using the satellite directly.
          default: ""
          selector:
            entity:
              domain: media_player

        tts_voice_profile:
          name: ElevenLabs voice profile (optional)
          description: >
            Optional voice_profile for tts.speak options (e.g.
            "Quark - Custom 11"). Leave empty to omit.
          default: ""
          selector:
            text: {}

        use_satellite_for_pre_post:
          name: Use satellite for pre/post TTS (duck-friendly)
          description: >
            If enabled, pre/post announcements use assist_satellite.announce
            instead of tts.speak. Makes the satellite enter 'responding'
            state so ducking automations can lower music.
          default: true
          selector:
            boolean: {}

        off_targets:
          name: Devices to turn off
          description: >
            Entities, devices or areas that can be switched off in
            Stage 1. The routine will ask before turning them off.
          default: {}
          selector:
            target: {}

        ir_off_scripts:
          name: IR off scripts
          description: >
            One or more scripts that send IR "off" commands for TV,
            amp, or other IR devices. Stage 2 will ask before running them.
          default: []
          selector:
            entity:
              domain: script
              multiple: true

    # =========================================================================
    # ② PRE-ANNOUNCEMENT
    # =========================================================================
    pre_announcement:
      name: "② Pre-Announcement"
      icon: mdi:bullhorn
      collapsed: true
      description: >
        Optional TTS message spoken before the goodnight stages begin.
        Can source text from an AI input_text helper or manual entry.
      input:
        pre_tts_use_helper:
          name: Use helper for pre-announcement
          description: >
            Get the pre-announcement message from an input_text helper
            (e.g. filled by an AI message refresher automation).
          default: false
          selector:
            boolean: {}

        pre_tts_helper:
          name: Pre-announcement input_text helper
          description: >
            input_text entity holding AI-generated pre-announcement text.
            Only used when "Use helper" is enabled.
          default: ""
          selector:
            entity:
              domain: input_text

        pre_tts_use_manual:
          name: Use manual pre-announcement text
          description: >
            If enabled, use the manual text field below. If both helper
            and manual are enabled, helper takes priority when not empty.
          default: true
          selector:
            boolean: {}

        pre_tts_message:
          name: Manual pre-announcement message
          description: >
            Text to speak before stages begin. Only used when manual
            mode is enabled and helper is empty or disabled.
          default: ""
          selector:
            text:
              multiline: true

    # =========================================================================
    # ③ STAGE 1 – DEVICES
    # =========================================================================
    stage_1_devices:
      name: "③ Stage 1 – Devices"
      icon: mdi:power-plug-off
      collapsed: true
      description: >
        Ask whether to switch off the targeted devices. Toggleable stage
        with editable question, YES confirm, and NO confirm messages —
        each optionally sourced from an input_text helper.
      input:
        enable_devices_question:
          name: Enable Stage 1 – Devices question
          description: >
            If enabled, the routine asks whether to switch off the
            targeted devices before proceeding.
          default: true
          selector:
            boolean: {}

        devices_question_text:
          name: Stage 1 – Devices question text (manual)
          description: >
            Manual question text for Stage 1. Example:
            "Do you want me to switch off the TV and lights?"
          default: "Do you want me to switch off the selected devices?"
          selector:
            text:
              multiline: true

        devices_use_helper_question:
          name: Stage 1 – use helper for question
          description: >
            Source the question text from the input_text helper below
            instead of manual text (when helper is not empty).
          default: false
          selector:
            boolean: {}

        devices_question_helper:
          name: Stage 1 – question input_text helper
          description: >
            input_text containing the AI-written Stage 1 question.
          default: ""
          selector:
            entity:
              domain: input_text

        devices_yes_confirm_message:
          name: Stage 1 – YES confirm (manual)
          description: >
            Message spoken when user answers YES to devices question.
          default: "Good choice. Less power wasted, more profit. Turning them off."
          selector:
            text:
              multiline: true

        devices_use_helper_yes:
          name: Stage 1 – use helper for YES confirm
          description: >
            Source the YES confirm from the input_text helper below.
          default: false
          selector:
            boolean: {}

        devices_yes_helper:
          name: Stage 1 – YES confirm input_text helper
          description: >
            input_text containing the YES confirm for Stage 1.
          default: ""
          selector:
            entity:
              domain: input_text

        devices_no_confirm_message:
          name: Stage 1 – NO confirm (manual)
          description: >
            Message spoken when user answers NO to devices question.
          default: "Fine, leaving them on. Your electricity bill, not mine."
          selector:
            text:
              multiline: true

        devices_use_helper_no:
          name: Stage 1 – use helper for NO confirm
          description: >
            Source the NO confirm from the input_text helper below.
          default: false
          selector:
            boolean: {}

        devices_no_helper:
          name: Stage 1 – NO confirm input_text helper
          description: >
            input_text containing the NO confirm for Stage 1.
          default: ""
          selector:
            entity:
              domain: input_text

    # =========================================================================
    # ④ STAGE 2 – IR DEVICES
    # =========================================================================
    stage_2_ir_devices:
      name: "④ Stage 2 – IR Devices"
      icon: mdi:remote
      collapsed: true
      description: >
        Ask whether to run IR off scripts for TV, amp, and other
        infrared-controlled devices. Same helper/manual pattern as Stage 1.
      input:
        enable_ir_question:
          name: Enable Stage 2 – IR devices question
          description: >
            If enabled, the routine asks whether to run IR off scripts.
          default: true
          selector:
            boolean: {}

        ir_question_text:
          name: Stage 2 – IR question text (manual)
          description: >
            Manual question for Stage 2. Example:
            "Want me to blast the TV and amp with a goodnight IR command?"
          default: "Do you want me to switch off the IR-controlled devices like the TV?"
          selector:
            text:
              multiline: true

        ir_use_helper_question:
          name: Stage 2 – use helper for question
          description: >
            Source the question from the input_text helper below.
          default: false
          selector:
            boolean: {}

        ir_question_helper:
          name: Stage 2 – question input_text helper
          description: >
            input_text containing the AI-written Stage 2 question.
          default: ""
          selector:
            entity:
              domain: input_text

        ir_yes_confirm_message:
          name: Stage 2 – IR YES confirm (manual)
          description: >
            Message spoken when user answers YES to IR question.
          default: "Got it. Sending the IR commands and shutting them down."
          selector:
            text:
              multiline: true

        ir_use_helper_yes:
          name: Stage 2 – use helper for YES confirm
          description: >
            Source the YES confirm from the input_text helper below.
          default: false
          selector:
            boolean: {}

        ir_yes_helper:
          name: Stage 2 – YES confirm input_text helper
          description: >
            input_text containing the YES confirm for Stage 2.
          default: ""
          selector:
            entity:
              domain: input_text

        ir_no_confirm_message:
          name: Stage 2 – IR NO confirm (manual)
          description: >
            Message spoken when user answers NO to IR question.
          default: "Alright, leaving the IR devices as they are."
          selector:
            text:
              multiline: true

        ir_use_helper_no:
          name: Stage 2 – use helper for NO confirm
          description: >
            Source the NO confirm from the input_text helper below.
          default: false
          selector:
            boolean: {}

        ir_no_helper:
          name: Stage 2 – NO confirm input_text helper
          description: >
            input_text containing the NO confirm for Stage 2.
          default: ""
          selector:
            entity:
              domain: input_text

    # =========================================================================
    # ⑤ STAGE 3 – MUSIC / BEDTIME STORY
    # =========================================================================
    stage_3_music:
      name: "⑤ Stage 3 – Music / Bedtime Story"
      icon: mdi:music-note
      collapsed: true
      description: >
        Ask if you want music or a bedtime story. On YES, branch by
        music mode: single preset, multi-preset choice, dynamic
        input_text URI, or free-text voice search via Music Assistant.
      input:
        enable_music_question:
          name: Enable Stage 3 – Music / bedtime story
          description: >
            If enabled, the routine asks if you want music or a story.
          default: true
          selector:
            boolean: {}

        music_intro_question_text:
          name: Stage 3 – intro question text (manual)
          description: >
            First question about music/bedtime audio.
          default: "Would you like some music or maybe a bedtime story?"
          selector:
            text:
              multiline: true

        music_use_helper_intro:
          name: Stage 3 – use helper for intro question
          description: >
            Source the intro question from the input_text helper below.
          default: false
          selector:
            boolean: {}

        music_intro_question_helper:
          name: Stage 3 – intro question input_text helper
          description: >
            input_text containing the AI-written intro question.
          default: ""
          selector:
            entity:
              domain: input_text

        music_yes_confirm_message:
          name: Stage 3 – YES confirm (manual)
          description: >
            Message spoken when user answers YES to music question.
          default: "Excellent. Let me get something playing for you."
          selector:
            text:
              multiline: true

        music_use_helper_yes:
          name: Stage 3 – use helper for YES confirm
          description: >
            Source the YES confirm from the input_text helper below.
          default: false
          selector:
            boolean: {}

        music_yes_helper:
          name: Stage 3 – YES confirm input_text helper
          description: >
            input_text containing the YES confirm for Stage 3.
          default: ""
          selector:
            entity:
              domain: input_text

        music_no_confirm_message:
          name: Stage 3 – NO confirm (manual)
          description: >
            Message spoken when user answers NO to music question.
          default: "Alright, no music or stories. Just silence and your thoughts."
          selector:
            text:
              multiline: true

        music_use_helper_no:
          name: Stage 3 – use helper for NO confirm
          description: >
            Source the NO confirm from the input_text helper below.
          default: false
          selector:
            boolean: {}

        music_no_helper:
          name: Stage 3 – NO confirm input_text helper
          description: >
            input_text containing the NO confirm for Stage 3.
          default: ""
          selector:
            entity:
              domain: input_text

        music_mode:
          name: Music mode – how to choose what plays
          description: >
            How the routine picks music after you say YES:
            preset_single — play one fixed media_id immediately.
            preset_multi — ask which of up to 3 labeled presets you want.
            from_input_text — read media_id from an input_text helper.
            free_text_name — ask "what do you want?" and send your
            spoken answer as media_id to Music Assistant.
          default: preset_single
          selector:
            select:
              options:
                - preset_single
                - preset_multi
                - from_input_text
                - free_text_name

        music_player:
          name: Music Assistant player
          description: >
            Media player controlled by Music Assistant for playback.
          default: ""
          selector:
            entity:
              domain: media_player

        music_volume:
          name: Music player volume
          description: >
            Volume (0.0–1.0) to set before playback. Set to 0 to skip.
          default: 0.15
          selector:
            number:
              min: 0
              max: 1
              step: 0.01

        music_media_type:
          name: Music Assistant media type
          description: >
            Hint about the item type. "auto" lets Music Assistant guess.
          default: auto
          selector:
            select:
              options:
                - auto
                - playlist
                - album
                - track
                - artist
                - radio

        music_media_id:
          name: Single preset media_id
          description: >
            media_id (URI or ID) for preset_single mode.
            Example: "spotify://playlist/abc123".
          default: ""
          selector:
            text:
              multiline: false

        music_media_input_text:
          name: input_text for dynamic media_id
          description: >
            input_text entity holding the media_id for from_input_text mode.
          default: ""
          selector:
            entity:
              domain: input_text

        music_question_text:
          name: Stage 3 – secondary music question text
          description: >
            Second question for preset_multi / free_text_name modes
            after user already said YES to music.
          default: "What do you want me to play from your Music Assistant library?"
          selector:
            text:
              multiline: true

        music_use_helper_secondary:
          name: Stage 3 – use helper for secondary question
          description: >
            Source the secondary question from the input_text helper below.
          default: false
          selector:
            boolean: {}

        music_secondary_question_helper:
          name: Stage 3 – secondary question input_text helper
          description: >
            input_text containing the secondary music question.
          default: ""
          selector:
            entity:
              domain: input_text

        music_preset_1_label:
          name: Preset 1 label
          description: >
            Spoken name for preset 1 (e.g. "bedtime stories for cynics").
            Only used in preset_multi mode. No punctuation.
          default: ""
          selector:
            text: {}

        music_preset_1_media_id:
          name: Preset 1 media_id
          description: >
            Music Assistant media_id for preset 1.
          default: ""
          selector:
            text: {}

        music_preset_2_label:
          name: Preset 2 label
          description: >
            Spoken name for preset 2 (e.g. "sleep mix").
          default: ""
          selector:
            text: {}

        music_preset_2_media_id:
          name: Preset 2 media_id
          description: >
            Music Assistant media_id for preset 2.
          default: ""
          selector:
            text: {}

        music_preset_3_label:
          name: Preset 3 label
          description: >
            Spoken name for preset 3 (e.g. "audiobook night").
          default: ""
          selector:
            text: {}

        music_preset_3_media_id:
          name: Preset 3 media_id
          description: >
            Music Assistant media_id for preset 3.
          default: ""
          selector:
            text: {}

    # =========================================================================
    # ⑥ POST-ANNOUNCEMENT
    # =========================================================================
    post_announcement:
      name: "⑥ Post-Announcement"
      icon: mdi:message-check
      collapsed: true
      description: >
        Optional TTS message spoken after all goodnight stages complete.
        Same helper/manual pattern as the pre-announcement.
      input:
        post_tts_use_helper:
          name: Use helper for post-announcement
          description: >
            Get the post-announcement message from an input_text helper.
          default: false
          selector:
            boolean: {}

        post_tts_helper:
          name: Post-announcement input_text helper
          description: >
            input_text entity holding AI-generated post-announcement text.
          default: ""
          selector:
            entity:
              domain: input_text

        post_tts_use_manual:
          name: Use manual post-announcement text
          description: >
            If enabled, use the manual text field. Helper takes priority
            when both are enabled and helper is not empty.
          default: true
          selector:
            boolean: {}

        post_tts_message:
          name: Manual post-announcement message
          description: >
            Text to speak after the routine finishes.
          default: ""
          selector:
            text:
              multiline: true

mode: single
max_exceeded: silent

# ---------------------------------------------------------------------------
# VARIABLES — resolve all inputs once for template access
# ---------------------------------------------------------------------------
variables:
  tts_entity: !input tts_entity
  tts_media_player: !input tts_media_player
  tts_voice_profile: !input tts_voice_profile
  use_satellite_for_pre_post: !input use_satellite_for_pre_post

  pre_tts_use_helper: !input pre_tts_use_helper
  pre_tts_helper: !input pre_tts_helper
  pre_tts_use_manual: !input pre_tts_use_manual
  pre_tts_message: !input pre_tts_message

  post_tts_use_helper: !input post_tts_use_helper
  post_tts_helper: !input post_tts_helper
  post_tts_use_manual: !input post_tts_use_manual
  post_tts_message: !input post_tts_message

  enable_devices_question: !input enable_devices_question
  devices_question_text: !input devices_question_text
  devices_use_helper_question: !input devices_use_helper_question
  devices_question_helper: !input devices_question_helper
  devices_yes_confirm_message: !input devices_yes_confirm_message
  devices_use_helper_yes: !input devices_use_helper_yes
  devices_yes_helper: !input devices_yes_helper
  devices_no_confirm_message: !input devices_no_confirm_message
  devices_use_helper_no: !input devices_use_helper_no
  devices_no_helper: !input devices_no_helper

  enable_ir_question: !input enable_ir_question
  ir_question_text: !input ir_question_text
  ir_use_helper_question: !input ir_use_helper_question
  ir_question_helper: !input ir_question_helper
  ir_yes_confirm_message: !input ir_yes_confirm_message
  ir_use_helper_yes: !input ir_use_helper_yes
  ir_yes_helper: !input ir_yes_helper
  ir_no_confirm_message: !input ir_no_confirm_message
  ir_use_helper_no: !input ir_use_helper_no
  ir_no_helper: !input ir_no_helper

  enable_music_question: !input enable_music_question
  music_assist_satellite: !input music_assist_satellite
  music_intro_question_text: !input music_intro_question_text
  music_use_helper_intro: !input music_use_helper_intro
  music_intro_question_helper: !input music_intro_question_helper
  music_yes_confirm_message: !input music_yes_confirm_message
  music_use_helper_yes: !input music_use_helper_yes
  music_yes_helper: !input music_yes_helper
  music_no_confirm_message: !input music_no_confirm_message
  music_use_helper_no: !input music_use_helper_no
  music_no_helper: !input music_no_helper

  music_mode: !input music_mode
  music_player: !input music_player
  music_volume: !input music_volume
  music_media_type: !input music_media_type
  music_media_id: !input music_media_id
  music_media_input_text: !input music_media_input_text
  music_question_text: !input music_question_text
  music_use_helper_secondary: !input music_use_helper_secondary
  music_secondary_question_helper: !input music_secondary_question_helper

  music_preset_1_label: !input music_preset_1_label
  music_preset_1_media_id: !input music_preset_1_media_id
  music_preset_2_label: !input music_preset_2_label
  music_preset_2_media_id: !input music_preset_2_media_id
  music_preset_3_label: !input music_preset_3_label
  music_preset_3_media_id: !input music_preset_3_media_id

# ---------------------------------------------------------------------------
# SEQUENCE
# ---------------------------------------------------------------------------
sequence:
  # ── Step 1: Resolve pre- and post-announcement text (helper vs manual) ──
  - alias: "Resolve pre/post announcement text — helper priority fallback"
    variables:
      pre_tts_final: >
        {% set use_helper = pre_tts_use_helper | default(false) %}
        {% set use_manual = pre_tts_use_manual | default(false) %}
        {% set helper_entity = pre_tts_helper | default('') %}
        {% set helper_text =
             states(helper_entity) | default('') if helper_entity != '' else '' %}
        {% if use_helper and (helper_text | trim != '') %}
          {{ helper_text }}
        {% elif use_manual %}
          {{ pre_tts_message | default('') }}
        {% else %}
          {{ '' }}
        {% endif %}
      post_tts_final: >
        {% set use_helper = post_tts_use_helper | default(false) %}
        {% set use_manual = post_tts_use_manual | default(false) %}
        {% set helper_entity = post_tts_helper | default('') %}
        {% set helper_text =
             states(helper_entity) | default('') if helper_entity != '' else '' %}
        {% if use_helper and (helper_text | trim != '') %}
          {{ helper_text }}
        {% elif use_manual %}
          {{ post_tts_message | default('') }}
        {% else %}
          {{ '' }}
        {% endif %}

  # ── Step 2: Resolve all stage question/confirm texts ──
  - alias: "Resolve stage 1/2/3 question and confirm texts — helper priority"
    variables:
      devices_question_final: >
        {% set use_h = devices_use_helper_question | default(false) %}
        {% set he = devices_question_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ devices_question_text | default('') }}{% endif %}
      devices_yes_final: >
        {% set use_h = devices_use_helper_yes | default(false) %}
        {% set he = devices_yes_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ devices_yes_confirm_message | default('') }}{% endif %}
      devices_no_final: >
        {% set use_h = devices_use_helper_no | default(false) %}
        {% set he = devices_no_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ devices_no_confirm_message | default('') }}{% endif %}

      ir_question_final: >
        {% set use_h = ir_use_helper_question | default(false) %}
        {% set he = ir_question_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ ir_question_text | default('') }}{% endif %}
      ir_yes_final: >
        {% set use_h = ir_use_helper_yes | default(false) %}
        {% set he = ir_yes_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ ir_yes_confirm_message | default('') }}{% endif %}
      ir_no_final: >
        {% set use_h = ir_use_helper_no | default(false) %}
        {% set he = ir_no_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ ir_no_confirm_message | default('') }}{% endif %}

      music_intro_question_final: >
        {% set use_h = music_use_helper_intro | default(false) %}
        {% set he = music_intro_question_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ music_intro_question_text | default('') }}{% endif %}
      music_yes_final: >
        {% set use_h = music_use_helper_yes | default(false) %}
        {% set he = music_yes_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ music_yes_confirm_message | default('') }}{% endif %}
      music_no_final: >
        {% set use_h = music_use_helper_no | default(false) %}
        {% set he = music_no_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ music_no_confirm_message | default('') }}{% endif %}
      music_question_final: >
        {% set use_h = music_use_helper_secondary | default(false) %}
        {% set he = music_secondary_question_helper | default('') %}
        {% set ht = states(he) | default('') if he != '' else '' %}
        {% if use_h and (ht | trim != '') %}{{ ht }}
        {% else %}{{ music_question_text | default('') }}{% endif %}

  # ── Step 3: Optional pre-announcement TTS ──
  - alias: "Pre-announcement gate — skip when text is empty"
    choose:
      - conditions:
          - condition: template
            value_template: "{{ pre_tts_final | trim != '' }}"
        sequence:
          - alias: "Pre-announcement — branch satellite vs TTS"
            choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_satellite_for_pre_post }}"
                sequence:
                  - alias: "Pre-announce via satellite — duck-friendly"
                    action: assist_satellite.announce
                    continue_on_error: true
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ pre_tts_final }}"
                      preannounce: false
              - conditions:
                  - condition: template
                    value_template: "{{ tts_voice_profile | trim != '' }}"
                sequence:
                  - alias: "Pre-announce via TTS — with voice profile"
                    action: tts.speak
                    continue_on_error: true
                    target:
                      entity_id: "{{ tts_entity }}"
                    data:
                      message: "{{ pre_tts_final }}"
                      media_player_entity_id: "{{ tts_media_player }}"
                      options:
                        voice_profile: "{{ tts_voice_profile }}"
            default:
              - alias: "Pre-announce via TTS — no voice profile"
                action: tts.speak
                continue_on_error: true
                target:
                  entity_id: "{{ tts_entity }}"
                data:
                  message: "{{ pre_tts_final }}"
                  media_player_entity_id: "{{ tts_media_player }}"

  # ── Step 4: Stage 1 – Devices question ──
  - alias: "Stage 1 gate — devices question enabled?"
    choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_devices_question }}"
        sequence:
          - alias: "Stage 1 — ask: switch off devices?"
            action: assist_satellite.ask_question
            continue_on_error: true
            data:
              entity_id: "{{ music_assist_satellite }}"
              question: "{{ devices_question_final }}"
              answers:
                - id: "yes"
                  sentences:
                    - "yes"
                    - "yeah"
                    - "sure"
                    - "ok"
                    - "okay"
                    - "please"
                    - "go ahead"
                    - "do it"
                - id: "no"
                  sentences:
                    - "no"
                    - "no thanks"
                    - "not now"
                    - "leave them"
                    - "leave them on"
                    - "cancel"
                    - "skip"
            response_variable: devices_answer

          - alias: "Stage 1 — branch YES (turn off) vs NO (leave on)"
            choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ devices_answer is defined and
                         devices_answer.id | default('') == 'yes' }}
                sequence:
                  - alias: "Stage 1 YES — confirm message"
                    action: assist_satellite.announce
                    continue_on_error: true
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ devices_yes_final }}"
                      preannounce: false
                  - alias: "Stage 1 YES — turn off targeted devices"
                    action: homeassistant.turn_off
                    continue_on_error: true
                    target: !input off_targets
            default:
              - alias: "Stage 1 NO/timeout — confirm leaving devices on"
                action: assist_satellite.announce
                continue_on_error: true
                target:
                  entity_id: "{{ music_assist_satellite }}"
                data:
                  message: "{{ devices_no_final }}"
                  preannounce: false

  # ── Step 5: Stage 2 – IR devices question ──
  - alias: "Stage 2 gate — IR question enabled?"
    choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_ir_question }}"
        sequence:
          - alias: "Stage 2 — ask: run IR off scripts?"
            action: assist_satellite.ask_question
            continue_on_error: true
            data:
              entity_id: "{{ music_assist_satellite }}"
              question: "{{ ir_question_final }}"
              answers:
                - id: "yes"
                  sentences:
                    - "yes"
                    - "yeah"
                    - "sure"
                    - "ok"
                    - "okay"
                    - "please"
                    - "go ahead"
                    - "do it"
                - id: "no"
                  sentences:
                    - "no"
                    - "no thanks"
                    - "not now"
                    - "leave it"
                    - "leave it on"
                    - "cancel"
                    - "skip"
            response_variable: ir_answer

          - alias: "Stage 2 — branch YES (run IR off) vs NO (leave on)"
            choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ ir_answer is defined and
                         ir_answer.id | default('') == 'yes' }}
                sequence:
                  - alias: "Stage 2 YES — confirm message"
                    action: assist_satellite.announce
                    continue_on_error: true
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ ir_yes_final }}"
                      preannounce: false
                  - alias: "Stage 2 YES — run IR off scripts"
                    action: script.turn_on
                    continue_on_error: true
                    target:
                      entity_id: !input ir_off_scripts
            default:
              - alias: "Stage 2 NO/timeout — confirm leaving IR devices on"
                action: assist_satellite.announce
                continue_on_error: true
                target:
                  entity_id: "{{ music_assist_satellite }}"
                data:
                  message: "{{ ir_no_final }}"
                  preannounce: false

  # ── Step 6: Stage 3 – Music / bedtime story ──
  - alias: "Stage 3 gate — music question enabled?"
    choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_music_question }}"
        sequence:
          # 6a) Intro: do you want music at all?
          - alias: "Stage 3 — ask: want music or a bedtime story?"
            action: assist_satellite.ask_question
            continue_on_error: true
            data:
              entity_id: "{{ music_assist_satellite }}"
              question: "{{ music_intro_question_final }}"
              answers:
                - id: "yes"
                  sentences:
                    - "yes"
                    - "yeah"
                    - "sure"
                    - "ok"
                    - "okay"
                    - "please"
                    - "go ahead"
                - id: "no"
                  sentences:
                    - "no"
                    - "no thanks"
                    - "not now"
                    - "nothing"
                    - "cancel"
                    - "skip"
            response_variable: music_intro_answer

          - alias: "Stage 3 — branch YES (pick music) vs NO (silence)"
            choose:
              # 6b) YES → confirm + resolve media by mode
              - conditions:
                  - condition: template
                    value_template: >
                      {{ music_intro_answer is defined and
                         music_intro_answer.id | default('') == 'yes' }}
                sequence:
                  - alias: "Stage 3 YES — confirm music selection"
                    action: assist_satellite.announce
                    continue_on_error: true
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ music_yes_final }}"
                      preannounce: false

                  # -- Resolve chosen_media_id by music_mode --
                  - alias: "Stage 3 — branch by music mode to resolve media_id"
                    choose:
                      # ── preset_multi: ask which of 3 presets ──
                      - conditions:
                          - condition: template
                            value_template: "{{ music_mode == 'preset_multi' }}"
                        sequence:
                          - alias: "Stage 3 preset_multi — ask which preset"
                            action: assist_satellite.ask_question
                            continue_on_error: true
                            data:
                              entity_id: "{{ music_assist_satellite }}"
                              question: "{{ music_question_final }}"
                              answers:
                                - id: "preset1"
                                  sentences:
                                    - "{{ music_preset_1_label }}"
                                    - "play {{ music_preset_1_label }}"
                                - id: "preset2"
                                  sentences:
                                    - "{{ music_preset_2_label }}"
                                    - "play {{ music_preset_2_label }}"
                                - id: "preset3"
                                  sentences:
                                    - "{{ music_preset_3_label }}"
                                    - "play {{ music_preset_3_label }}"
                                - id: "none"
                                  sentences:
                                    - "no"
                                    - "nothing"
                                    - "no thanks"
                                    - "cancel"
                            response_variable: music_answer

                          - alias: "Stage 3 preset_multi — resolve media_id from choice"
                            variables:
                              chosen_media_id: >
                                {% if music_answer is not defined %}{{ '' }}
                                {% elif music_answer.id | default('') == 'preset1' %}
                                  {{ music_preset_1_media_id | default('') }}
                                {% elif music_answer.id | default('') == 'preset2' %}
                                  {{ music_preset_2_media_id | default('') }}
                                {% elif music_answer.id | default('') == 'preset3' %}
                                  {{ music_preset_3_media_id | default('') }}
                                {% else %}{{ '' }}{% endif %}

                      # ── free_text_name: ask what to play with {item} slot ──
                      - conditions:
                          - condition: template
                            value_template: "{{ music_mode == 'free_text_name' }}"
                        sequence:
                          - alias: "Stage 3 free_text — ask what to play"
                            action: assist_satellite.ask_question
                            continue_on_error: true
                            data:
                              entity_id: "{{ music_assist_satellite }}"
                              question: "{{ music_question_final }}"
                              answers:
                                - id: "chosen"
                                  sentences:
                                    - "{item}"
                                    - "yes {item}"
                                    - "play {item}"
                                    - "play {item} please"
                                    - "please play {item}"
                                - id: "none"
                                  sentences:
                                    - "no"
                                    - "nothing"
                                    - "no thanks"
                                    - "cancel"
                            response_variable: music_answer

                          - alias: "Stage 3 free_text — extract spoken item as media_id"
                            variables:
                              chosen_media_id: >
                                {% if music_answer is defined
                                      and music_answer.id | default('') == 'chosen'
                                      and music_answer.slots is defined
                                      and 'item' in music_answer.slots %}
                                  {{ music_answer.slots.item }}
                                {% else %}{{ '' }}{% endif %}

                    # ── preset_single / from_input_text: resolve directly ──
                    default:
                      - alias: "Stage 3 preset_single/input_text — resolve media_id"
                        variables:
                          chosen_media_id: >
                            {% if music_mode == 'from_input_text' %}
                              {{ states(music_media_input_text | default('')) | default('') }}
                            {% else %}
                              {{ music_media_id | default('') }}
                            {% endif %}

                  # -- Unified playback block (deduped from 3× copy-paste) --
                  - alias: "Stage 3 playback gate — media_id resolved and not empty?"
                    condition: template
                    value_template: "{{ chosen_media_id | default('') | trim != '' }}"

                  - alias: "Stage 3 volume — set if above zero"
                    if:
                      - condition: template
                        value_template: "{{ (music_volume | float(0)) > 0 }}"
                    then:
                      - alias: "Stage 3 volume — set Music Assistant player volume"
                        action: media_player.volume_set
                        continue_on_error: true
                        target:
                          entity_id: "{{ music_player }}"
                        data:
                          volume_level: "{{ music_volume | float(0) }}"

                  - alias: "Stage 3 play — branch auto vs explicit media_type"
                    if:
                      - condition: template
                        value_template: "{{ music_media_type | default('auto') != 'auto' }}"
                    then:
                      - alias: "Stage 3 play — Music Assistant with explicit media_type"
                        action: music_assistant.play_media
                        continue_on_error: true
                        target:
                          entity_id: "{{ music_player }}"
                        data:
                          media_id: "{{ chosen_media_id }}"
                          media_type: "{{ music_media_type }}"
                          enqueue: play
                    else:
                      - alias: "Stage 3 play — Music Assistant auto media_type"
                        action: music_assistant.play_media
                        continue_on_error: true
                        target:
                          entity_id: "{{ music_player }}"
                        data:
                          media_id: "{{ chosen_media_id }}"
                          enqueue: play

            # 6c) NO / timeout → confirm silence
            default:
              - alias: "Stage 3 NO/timeout — confirm no music"
                action: assist_satellite.announce
                continue_on_error: true
                target:
                  entity_id: "{{ music_assist_satellite }}"
                data:
                  message: "{{ music_no_final }}"
                  preannounce: false

  # ── Step 7: Optional post-announcement TTS ──
  - alias: "Post-announcement gate — skip when text is empty"
    choose:
      - conditions:
          - condition: template
            value_template: "{{ post_tts_final | trim != '' }}"
        sequence:
          - alias: "Post-announcement — branch satellite vs TTS"
            choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_satellite_for_pre_post }}"
                sequence:
                  - alias: "Post-announce via satellite — duck-friendly"
                    action: assist_satellite.announce
                    continue_on_error: true
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ post_tts_final }}"
                      preannounce: false
              - conditions:
                  - condition: template
                    value_template: "{{ tts_voice_profile | trim != '' }}"
                sequence:
                  - alias: "Post-announce via TTS — with voice profile"
                    action: tts.speak
                    continue_on_error: true
                    target:
                      entity_id: "{{ tts_entity }}"
                    data:
                      message: "{{ post_tts_final }}"
                      media_player_entity_id: "{{ tts_media_player }}"
                      options:
                        voice_profile: "{{ tts_voice_profile }}"
            default:
              - alias: "Post-announce via TTS — no voice profile"
                action: tts.speak
                continue_on_error: true
                target:
                  entity_id: "{{ tts_entity }}"
                data:
                  message: "{{ post_tts_final }}"
                  media_player_entity_id: "{{ tts_media_player }}"
