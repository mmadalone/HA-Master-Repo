blueprint:
  name: "Goodnight Routine – Bedtime Negotiator (Quark style)"
  description: >
    Interactive goodnight routine with Quark-style negotiation:

    FLOW
    ----
    1) Optional pre-announcement (manual or AI helper).
    2) Stage 1 – Devices:
       "Do you want me to switch off [devices]?"
       • If YES: confirm, turn them off, continue.
       • If NO: confirm, leave them on, continue.
    3) Stage 2 – IR devices:
       "Do you want me to switch off [IR devices]?"
       • If YES: confirm, run IR off scripts, continue.
       • If NO: confirm, continue.
    4) Stage 3 – Music / bedtime story:
       "Would you like some music or maybe a bedtime story?"
       • If YES: confirm, then:
           - preset_single/from_input_text: play directly.
           - preset_multi/free_text_name: ask what to play and start it.
       • If NO: confirm, continue.
    5) Optional post-announcement (manual or AI helper).

    Each stage is:
    - Toggleable (on/off)
    - Question text is editable
    - YES/NO confirm messages are editable
    - And each of those texts can optionally come from input_text helpers
      so an AI "message refresher" automation can rewrite them.

  domain: script

  input:
    off_targets:
      name: Devices to turn off
      description: >
        Entities, devices or areas that *can* be switched off as part of
        the goodnight routine (lights, switches, media players, etc.).
        Stage 1 will *ask* if you want these turned off.
      selector:
        target: {}

    ir_off_scripts:
      name: IR off scripts
      description: >
        One or more scripts that send IR "off" commands for your TV and
        other IR devices. Stage 2 will ask if you want to run them.
      selector:
        entity:
          domain: script
          multiple: true

    use_satellite_for_pre_post:
      name: Use Voice PE satellite for pre/post TTS (duck-friendly)
      description: >
        If enabled, pre- and post-announcement messages will be sent via
        assist_satellite.announce on the selected satellite instead of
        tts.speak. This makes the satellite go into 'responding', so your
        ducking automation can lower the music.
      default: true
      selector:
        boolean: {}

    tts_entity:
      name: TTS entity
      description: >
        TTS entity to use with tts.speak (for example
        tts.elevenlabs_custom_tts or tts.elevenlabs).
      selector:
        entity:
          domain: tts

    tts_media_player:
      name: Speaker for TTS
      description: >
        Media player Quark/Rick should speak from for the pre/post
        announcements (when not using the satellite directly).
      selector:
        entity:
          domain: media_player

    tts_voice_profile:
      name: ElevenLabs voice profile (optional)
      description: >
        Optional voice_profile to send in tts.speak options, for example
        "Quark - Custom 11". Leave empty to omit the options field.
      default: ""
      selector:
        text: {}

    # --- Pre-announcement ---

    pre_tts_use_helper:
      name: Use helper for pre-announcement
      description: >
        If enabled, get the pre-announcement message from an input_text
        helper (for example, filled by an AI "refresh Quark bedtime
        messages" automation).
      default: false
      selector:
        boolean: {}

    pre_tts_helper:
      name: Pre-announcement input_text helper
      description: >
        input_text entity that holds the AI-generated pre-announcement
        text. Only used when "Use helper for pre-announcement" is enabled.
        Example: input_text.quark_goodnight_pre_line.
      default: ""
      selector:
        entity:
          domain: input_text

    pre_tts_use_manual:
      name: Use manual pre-announcement text
      description: >
        If enabled, use the manual pre-announcement text field below.
        If both helper and manual are enabled, the helper value will be
        used when not empty; otherwise the manual text is used.
      default: true
      selector:
        boolean: {}

    pre_tts_message:
      name: Manual pre-announcement message
      description: >
        Optional text to speak before the goodnight routine actions run,
        when "Use manual pre-announcement text" is enabled and the helper
        is empty or disabled. Leave empty to skip.
      default: ""
      selector:
        text:
          multiline: true

    # --- Post-announcement ---

    post_tts_use_helper:
      name: Use helper for post-announcement
      description: >
        If enabled, get the post-announcement message from an input_text
        helper (for example, input_text.quark_gn_post).
      default: false
      selector:
        boolean: {}

    post_tts_helper:
      name: Post-announcement input_text helper
      description: >
        input_text entity that holds the AI-generated post-announcement
        text. Only used when "Use helper for post-announcement" is enabled.
        Example: input_text.quark_gn_post.
      default: ""
      selector:
        entity:
          domain: input_text

    post_tts_use_manual:
      name: Use manual post-announcement text
      description: >
        If enabled, use the manual post-announcement text field below.
        If both helper and manual are enabled, the helper value will be
        used when not empty; otherwise the manual text is used.
      default: true
      selector:
        boolean: {}

    post_tts_message:
      name: Manual post-announcement message
      description: >
        Optional text to speak after the goodnight routine finishes,
        when "Use manual post-announcement text" is enabled and the helper
        is empty or disabled. Leave empty to skip.
      default: ""
      selector:
        text:
          multiline: true

    # --- Stage 1: Devices question ---

    enable_devices_question:
      name: Enable Stage 1 – Devices question
      description: >
        If enabled, Quark will ask if you want to switch off the
        "Devices to turn off". The actual device names should be
        described in the question text or helper.
      default: true
      selector:
        boolean: {}

    devices_question_text:
      name: Stage 1 – Devices question text (manual)
      description: >
        Manual question to ask before turning off the "Devices to turn off".
        Example:
        "Miquel, do you want me to switch off the TV, living room lights,
        and whatever else is still wasting power?"
      default: "Miquel, do you want me to switch off the selected devices?"
      selector:
        text:
          multiline: true

    devices_use_helper_question:
      name: Stage 1 – use helper for question
      description: >
        If enabled, the devices question text will be taken from the
        helper below (when not empty) instead of the manual text.
      default: false
      selector:
        boolean: {}

    devices_question_helper:
      name: Stage 1 – question input_text helper
      description: >
        input_text entity containing the Stage 1 devices question, for
        example written by an AI refresher automation.
        Example: input_text.quark_gn_devices_question.
      default: ""
      selector:
        entity:
          domain: input_text

    devices_yes_confirm_message:
      name: Stage 1 – Devices YES confirm (manual)
      description: >
        Manual message Quark says when you answer YES to the devices question.
        Example:
        "Good choice. Less power wasted, more profit. Turning them off."
      default: "Good choice. Less power wasted, more profit. Turning them off."
      selector:
        text:
          multiline: true

    devices_use_helper_yes:
      name: Stage 1 – use helper for YES confirm
      description: >
        If enabled, the YES confirm message will be taken from this
        helper instead of the manual text, when not empty.
      default: false
      selector:
        boolean: {}

    devices_yes_helper:
      name: Stage 1 – YES confirm input_text helper
      description: >
        input_text containing the YES confirm message for Stage 1.
        Example: input_text.quark_gn_devices_yes.
      default: ""
      selector:
        entity:
          domain: input_text

    devices_no_confirm_message:
      name: Stage 1 – Devices NO confirm (manual)
      description: >
        Manual message Quark says when you answer NO to the devices question.
        Example:
        "Fine, fine, leave them on. Your electricity bill, not mine."
      default: "Fine, leaving them on. Your electricity bill, not mine."
      selector:
        text:
          multiline: true

    devices_use_helper_no:
      name: Stage 1 – use helper for NO confirm
      description: >
        If enabled, the NO confirm message will be taken from this
        helper instead of the manual text, when not empty.
      default: false
      selector:
        boolean: {}

    devices_no_helper:
      name: Stage 1 – NO confirm input_text helper
      description: >
        input_text containing the NO confirm message for Stage 1.
        Example: input_text.quark_gn_devices_no.
      default: ""
      selector:
        entity:
          domain: input_text

    # --- Stage 2: IR devices question ---

    enable_ir_question:
      name: Enable Stage 2 – IR devices question
      description: >
        If enabled, Quark will ask if you want to run the IR off scripts
        (for TV, amp, etc.).
      default: true
      selector:
        boolean: {}

    ir_question_text:
      name: Stage 2 – IR devices question text (manual)
      description: >
        Manual question to ask before running the IR off scripts.
        Example:
        "Want me to blast the TV and amp with a goodnight IR command?"
      default: "Do you want me to switch off the IR-controlled devices like the TV?"
      selector:
        text:
          multiline: true

    ir_use_helper_question:
      name: Stage 2 – use helper for question
      description: >
        If enabled, the IR devices question text will be taken from the
        helper below (when not empty) instead of the manual text.
      default: false
      selector:
        boolean: {}

    ir_question_helper:
      name: Stage 2 – question input_text helper
      description: >
        input_text containing the Stage 2 IR devices question, for
        example written by an AI refresher automation.
        Example: input_text.quark_gn_ir_question.
      default: ""
      selector:
        entity:
          domain: input_text

    ir_yes_confirm_message:
      name: Stage 2 – IR YES confirm (manual)
      description: >
        Manual message Quark says when you answer YES to the IR question.
        Example:
        "IR torpedoes away. TV and friends are going dark."
      default: "Got it. Sending the IR commands and shutting them down."
      selector:
        text:
          multiline: true

    ir_use_helper_yes:
      name: Stage 2 – use helper for YES confirm
      description: >
        If enabled, the YES confirm message will be taken from this
        helper instead of the manual text, when not empty.
      default: false
      selector:
        boolean: {}

    ir_yes_helper:
      name: Stage 2 – YES confirm input_text helper
      description: >
        input_text containing the YES confirm message for Stage 2.
        Example: input_text.quark_gn_ir_yes.
      default: ""
      selector:
        entity:
          domain: input_text

    ir_no_confirm_message:
      name: Stage 2 – IR NO confirm (manual)
      description: >
        Manual message Quark says when you answer NO to the IR question.
        Example:
        "Leaving the TV armed and dangerous. Your call."
      default: "Alright, leaving the IR devices as they are."
      selector:
        text:
          multiline: true

    ir_use_helper_no:
      name: Stage 2 – use helper for NO confirm
      description: >
        If enabled, the NO confirm message will be taken from this
        helper instead of the manual text, when not empty.
      default: false
      selector:
        boolean: {}

    ir_no_helper:
      name: Stage 2 – NO confirm input_text helper
      description: >
        input_text containing the NO confirm message for Stage 2.
        Example: input_text.quark_gn_ir_no.
      default: ""
      selector:
        entity:
          domain: input_text

    # --- Stage 3: Music / bedtime story intro ---

    enable_music_question:
      name: Enable Stage 3 – Music / bedtime story
      description: >
        If enabled, Quark will ask if you want some music or a bedtime
        story. On YES he will either play a preset or ask a second
        question (for multi-preset / free-text modes).
      default: true
      selector:
        boolean: {}

    music_assist_satellite:
      name: Assist Satellite for all questions
      description: >
        Assist Satellite (Voice Preview) that should:
        - Ask the devices/IR/music questions
        - Listen for your answers
        - Speak the confirm messages
        This should be the Voice PE near your bed.
      selector:
        entity:
          domain: assist_satellite

    music_intro_question_text:
      name: Stage 3 – Music intro question text (manual)
      description: >
        Manual first question about music/bedtime audio.
        Example:
        "Would you like some music or maybe a bedtime story while you fall asleep?"
      default: "Would you like some music or maybe a bedtime story?"
      selector:
        text:
          multiline: true

    music_use_helper_intro:
      name: Stage 3 – use helper for intro question
      description: >
        If enabled, the music intro question will be taken from the
        helper below (when not empty) instead of the manual text.
      default: false
      selector:
        boolean: {}

    music_intro_question_helper:
      name: Stage 3 – intro question input_text helper
      description: >
        input_text containing the Stage 3 music intro question, for
        example written by an AI refresher automation.
        Example: input_text.quark_gn_music_intro_question.
      default: ""
      selector:
        entity:
          domain: input_text

    music_yes_confirm_message:
      name: Stage 3 – Music YES confirm (manual)
      description: >
        Manual message Quark says when you answer YES to the intro music question.
        Example:
        "Now we’re talking. Let’s pick something to flood your ears with."
      default: "Excellent. Let me get something playing for you."
      selector:
        text:
          multiline: true

    music_use_helper_yes:
      name: Stage 3 – use helper for YES confirm
      description: >
        If enabled, the YES confirm message will be taken from this
        helper instead of the manual text, when not empty.
      default: false
      selector:
        boolean: {}

    music_yes_helper:
      name: Stage 3 – YES confirm input_text helper
      description: >
        input_text containing the YES confirm message for Stage 3.
        Example: input_text.quark_gn_music_yes.
      default: ""
      selector:
        entity:
          domain: input_text

    music_no_confirm_message:
      name: Stage 3 – Music NO confirm (manual)
      description: >
        Manual message Quark says when you answer NO to the intro music question.
        Example:
        "No music, no stories. Pure silence. Very profitable."
      default: "Alright, no music or stories. Just silence and your thoughts."
      selector:
        text:
          multiline: true

    music_use_helper_no:
      name: Stage 3 – use helper for NO confirm
      description: >
        If enabled, the NO confirm message will be taken from this
        helper instead of the manual text, when not empty.
      default: false
      selector:
        boolean: {}

    music_no_helper:
      name: Stage 3 – NO confirm input_text helper
      description: >
        input_text containing the NO confirm message for Stage 3.
        Example: input_text.quark_gn_music_no.
      default: ""
      selector:
        entity:
          domain: input_text

    # --- Music selection mode and details ---

    music_mode:
      name: Music mode – how to choose what to play
      description: >
        How Quark decides what to play if you say YES to music:
        - preset_single: play one fixed media_id immediately.
        - preset_multi: ask which of up to 3 labeled presets you want.
        - from_input_text: read media_id from an input_text and play it.
        - free_text_name: ask "what do you want to play?" and send your
          answer directly as media_id to Music Assistant.
      default: preset_single
      selector:
        select:
          options:
            - preset_single
            - preset_multi
            - from_input_text
            - free_text_name

    music_player:
      name: Music Assistant player
      description: >
        Media player controlled by Music Assistant that should play the
        chosen bedtime audio.
      selector:
        entity:
          domain: media_player

    music_volume:
      name: Music player volume
      description: >
        Volume level (0.0–1.0) to set on the Music Assistant player
        before starting playback. Set to 0 to skip changing the volume.
      default: 0
      selector:
        number:
          min: 0
          max: 1
          step: 0.01

    music_media_type:
      name: Music Assistant media type
      description: >
        Optional hint about the type of item you are playing.
        If set to 'auto', Music Assistant will try to guess.
        Valid types: playlist, album, track, artist, radio.
      default: auto
      selector:
        select:
          options:
            - auto
            - playlist
            - album
            - track
            - artist
            - radio

    music_media_id:
      name: Single preset Music Assistant media_id
      description: >
        The media_id (URI or ID) to send to music_assistant.play_media
        in 'preset_single' mode, for example:
        "spotify://playlist/abc123".
      default: ""
      selector:
        text:
          multiline: false

    music_media_input_text:
      name: input_text for dynamic media_id
      description: >
        input_text entity that holds the media_id to play when using
        'from_input_text' mode. The script will read its state at runtime.
      selector:
        entity:
          domain: input_text

    music_question_text:
      name: Stage 3 – Secondary music question text
      description: >
        Second question used only for 'preset_multi' or 'free_text_name'
        modes, when you already said YES to music and Quark needs to know
        *what* to play.
        Example:
        "What do you want me to play? You can say bedtime stories for
        cynics, sleep mix, or audiobook night."
      default: "What do you want me to play from your Music Assistant library?"
      selector:
        text:
          multiline: true
    music_use_helper_secondary:
      name: Stage 3 – use helper for secondary question
      description: >
        If enabled, the secondary music question will be taken from the
        helper below (when not empty) instead of the manual text.
      default: false
      selector:
        boolean: {}

    music_secondary_question_helper:
      name: Stage 3 – secondary question input_text helper
      description: >
        input_text containing the Stage 3 secondary music question, for
        example written by an AI refresher automation.
        For you: input_text.quark_gn_music_secondary_question.
      default: ""
      selector:
        entity:
          domain: input_text

    music_preset_1_label:
      name: Preset 1 label
      description: >
        Spoken name for preset 1, e.g. "bedtime stories for cynics".
        Only used when music_mode is 'preset_multi'. Do not include
        punctuation characters here (no commas, dots, etc.).
      default: ""
      selector:
        text: {}

    music_preset_1_media_id:
      name: Preset 1 media_id
      description: >
        Music Assistant media_id (URI or ID) for preset 1.
      default: ""
      selector:
        text: {}

    music_preset_2_label:
      name: Preset 2 label
      description: >
        Spoken name for preset 2, e.g. "sleep mix".
        Only used when music_mode is 'preset_multi'. Do not include
        punctuation characters here.
      default: ""
      selector:
        text: {}

    music_preset_2_media_id:
      name: Preset 2 media_id
      description: >
        Music Assistant media_id (URI or ID) for preset 2.
      default: ""
      selector:
        text: {}

    music_preset_3_label:
      name: Preset 3 label
      description: >
        Spoken name for preset 3, e.g. "audiobook night".
        Only used when music_mode is 'preset_multi'. Do not include
        punctuation characters here.
      default: ""
      selector:
        text: {}

    music_preset_3_media_id:
      name: Preset 3 media_id
      description: >
        Music Assistant media_id (URI or ID) for preset 3.
      default: ""
      selector:
        text: {}

mode: single
max_exceeded: silent

variables:
  tts_entity: !input tts_entity
  tts_media_player: !input tts_media_player
  tts_voice_profile: !input tts_voice_profile
  use_satellite_for_pre_post: !input use_satellite_for_pre_post

  pre_tts_use_helper: !input pre_tts_use_helper
  pre_tts_helper: !input pre_tts_helper
  pre_tts_use_manual: !input pre_tts_use_manual
  pre_tts_message: !input pre_tts_message

  post_tts_use_helper: !input post_tts_use_helper
  post_tts_helper: !input post_tts_helper
  post_tts_use_manual: !input post_tts_use_manual
  post_tts_message: !input post_tts_message

  enable_devices_question: !input enable_devices_question
  devices_question_text: !input devices_question_text
  devices_use_helper_question: !input devices_use_helper_question
  devices_question_helper: !input devices_question_helper
  devices_yes_confirm_message: !input devices_yes_confirm_message
  devices_use_helper_yes: !input devices_use_helper_yes
  devices_yes_helper: !input devices_yes_helper
  devices_no_confirm_message: !input devices_no_confirm_message
  devices_use_helper_no: !input devices_use_helper_no
  devices_no_helper: !input devices_no_helper

  enable_ir_question: !input enable_ir_question
  ir_question_text: !input ir_question_text
  ir_use_helper_question: !input ir_use_helper_question
  ir_question_helper: !input ir_question_helper
  ir_yes_confirm_message: !input ir_yes_confirm_message
  ir_use_helper_yes: !input ir_use_helper_yes
  ir_yes_helper: !input ir_yes_helper
  ir_no_confirm_message: !input ir_no_confirm_message
  ir_use_helper_no: !input ir_use_helper_no
  ir_no_helper: !input ir_no_helper

  enable_music_question: !input enable_music_question
  music_assist_satellite: !input music_assist_satellite
  music_intro_question_text: !input music_intro_question_text
  music_use_helper_intro: !input music_use_helper_intro
  music_intro_question_helper: !input music_intro_question_helper
  music_yes_confirm_message: !input music_yes_confirm_message
  music_use_helper_yes: !input music_use_helper_yes
  music_yes_helper: !input music_yes_helper
  music_no_confirm_message: !input music_no_confirm_message
  music_use_helper_no: !input music_use_helper_no
  music_no_helper: !input music_no_helper

  music_mode: !input music_mode
  music_player: !input music_player
  music_volume: !input music_volume
  music_media_type: !input music_media_type
  music_media_id: !input music_media_id
  music_media_input_text: !input music_media_input_text
  music_question_text: !input music_question_text
  music_use_helper_secondary: !input music_use_helper_secondary
  music_secondary_question_helper: !input music_secondary_question_helper

  music_preset_1_label: !input music_preset_1_label
  music_preset_1_media_id: !input music_preset_1_media_id
  music_preset_2_label: !input music_preset_2_label
  music_preset_2_media_id: !input music_preset_2_media_id
  music_preset_3_label: !input music_preset_3_label
  music_preset_3_media_id: !input music_preset_3_media_id

sequence:
  # 1) Decide pre- and post-announcement texts (helper vs manual)
  - variables:
      pre_tts_final: >
        {% set use_helper = pre_tts_use_helper | default(false) %}
        {% set use_manual = pre_tts_use_manual | default(false) %}
        {% set helper_entity = pre_tts_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_helper and (helper_text | trim != '') %}
          {{ helper_text }}
        {% elif use_manual %}
          {{ pre_tts_message }}
        {% else %}
          {{ '' }}
        {% endif %}
      post_tts_final: >
        {% set use_helper = post_tts_use_helper | default(false) %}
        {% set use_manual = post_tts_use_manual | default(false) %}
        {% set helper_entity = post_tts_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_helper and (helper_text | trim != '') %}
          {{ helper_text }}
        {% elif use_manual %}
          {{ post_tts_message }}
        {% else %}
          {{ '' }}
        {% endif %}

  # 2) Decide final texts for all 3 stages (helpers vs manual)
  - variables:
      devices_question_final: >
        {% set use_h = devices_use_helper_question | default(false) %}
        {% set helper_entity = devices_question_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ devices_question_text }}
        {% endif %}
      devices_yes_final: >
        {% set use_h = devices_use_helper_yes | default(false) %}
        {% set helper_entity = devices_yes_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ devices_yes_confirm_message }}
        {% endif %}
      devices_no_final: >
        {% set use_h = devices_use_helper_no | default(false) %}
        {% set helper_entity = devices_no_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ devices_no_confirm_message }}
        {% endif %}

      ir_question_final: >
        {% set use_h = ir_use_helper_question | default(false) %}
        {% set helper_entity = ir_question_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ ir_question_text }}
        {% endif %}
      ir_yes_final: >
        {% set use_h = ir_use_helper_yes | default(false) %}
        {% set helper_entity = ir_yes_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ ir_yes_confirm_message }}
        {% endif %}
      ir_no_final: >
        {% set use_h = ir_use_helper_no | default(false) %}
        {% set helper_entity = ir_no_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ ir_no_confirm_message }}
        {% endif %}

      music_intro_question_final: >
        {% set use_h = music_use_helper_intro | default(false) %}
        {% set helper_entity = music_intro_question_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ music_intro_question_text }}
        {% endif %}
      music_yes_final: >
        {% set use_h = music_use_helper_yes | default(false) %}
        {% set helper_entity = music_yes_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ music_yes_confirm_message }}
        {% endif %}
      music_no_final: >
        {% set use_h = music_use_helper_no | default(false) %}
        {% set helper_entity = music_no_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ music_no_confirm_message }}
        {% endif %}
      music_question_final: >
        {% set use_h = music_use_helper_secondary | default(false) %}
        {% set helper_entity = music_secondary_question_helper | default('') %}
        {% set helper_text =
             states(helper_entity) if helper_entity is not none and helper_entity != '' else '' %}
        {% if use_h and (helper_text | trim != '') %}
          {{ helper_text }}
        {% else %}
          {{ music_question_text }}
        {% endif %}

  # 3) Optional pre-announcement TTS (with satellite option)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ pre_tts_final | trim != '' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_satellite_for_pre_post }}"
                sequence:
                  - action: assist_satellite.announce
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ pre_tts_final }}"
                      preannounce: false
              - conditions:
                  - condition: template
                    value_template: "{{ tts_voice_profile | trim != '' }}"
                sequence:
                  - action: tts.speak
                    target:
                      entity_id: "{{ tts_entity }}"
                    data:
                      message: "{{ pre_tts_final }}"
                      media_player_entity_id: "{{ tts_media_player }}"
                      options:
                        voice_profile: "{{ tts_voice_profile }}"
            default:
              - action: tts.speak
                target:
                  entity_id: "{{ tts_entity }}"
                data:
                  message: "{{ pre_tts_final }}"
                  media_player_entity_id: "{{ tts_media_player }}"

  # 4) Stage 1 – Devices question
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_devices_question }}"
        sequence:
          - action: assist_satellite.ask_question
            data:
              entity_id: "{{ music_assist_satellite }}"
              question: "{{ devices_question_final }}"
              answers:
                - id: "yes"
                  sentences:
                    - "yes"
                    - "yeah"
                    - "sure"
                    - "ok"
                    - "okay"
                    - "please"
                - id: "no"
                  sentences:
                    - "no"
                    - "no thanks"
                    - "not now"
                    - "leave them"
                    - "cancel"
            response_variable: devices_answer

          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ devices_answer is defined and devices_answer.id == 'yes' }}
                sequence:
                  - action: assist_satellite.announce
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ devices_yes_final }}"
                      preannounce: false
                  - action: homeassistant.turn_off
                    target: !input off_targets
            default:
              - action: assist_satellite.announce
                target:
                  entity_id: "{{ music_assist_satellite }}"
                data:
                  message: "{{ devices_no_final }}"
                  preannounce: false

  # 5) Stage 2 – IR devices question
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ enable_ir_question }}"
        sequence:
          - action: assist_satellite.ask_question
            data:
              entity_id: "{{ music_assist_satellite }}"
              question: "{{ ir_question_final }}"
              answers:
                - id: "yes"
                  sentences:
                    - "yes"
                    - "yeah"
                    - "sure"
                    - "ok"
                    - "okay"
                    - "please"
                - id: "no"
                  sentences:
                    - "no"
                    - "no thanks"
                    - "not now"
                    - "leave it"
                    - "leave it on"
                    - "cancel"
            response_variable: ir_answer

          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ ir_answer is defined and ir_answer.id == 'yes' }}
                sequence:
                  - action: assist_satellite.announce
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ ir_yes_final }}"
                      preannounce: false
                  - action: script.turn_on
                    target:
                      entity_id: !input ir_off_scripts
            default:
              - variables:
                  music_allowed: false
              - action: assist_satellite.announce
                target:
                  entity_id: "{{ music_assist_satellite }}"
                data:
                  message: "{{ ir_no_final }}"
                  preannounce: false

  # 6) Stage 3 – Music / bedtime story
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ enable_music_question and (
                   not enable_ir_question
                   or ir_answer is not defined
                   or ir_answer.id == 'yes'
              ) }}

        sequence:
          # 6a) Intro YES/NO: do you want music at all?
          - action: assist_satellite.ask_question
            data:
              entity_id: "{{ music_assist_satellite }}"
              question: "{{ music_intro_question_final }}"
              answers:
                - id: "yes"
                  sentences:
                    - "yes"
                    - "yeah"
                    - "sure"
                    - "ok"
                    - "okay"
                    - "please"
                - id: "no"
                  sentences:
                    - "no"
                    - "no thanks"
                    - "not now"
                    - "nothing"
                    - "cancel"
            response_variable: music_intro_answer

          - choose:
              # 6b) YES to music → confirm + branch by music_mode
              - conditions:
                  - condition: template
                    value_template: >
                      {{ music_intro_answer is defined and music_intro_answer.id == 'yes' }}
                sequence:
                  - action: assist_satellite.announce
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ music_yes_final }}"
                      preannounce: false

                  - choose:
                      # preset_multi: ask which preset label
                      - conditions:
                          - condition: template
                            value_template: "{{ music_mode == 'preset_multi' }}"
                        sequence:
                          - action: assist_satellite.ask_question
                            data:
                              entity_id: "{{ music_assist_satellite }}"
                              question: "{{ music_question_final }}"
                              answers:
                                - id: "preset1"
                                  sentences:
                                    - "{{ music_preset_1_label }}"
                                    - "play {{ music_preset_1_label }}"
                                - id: "preset2"
                                  sentences:
                                    - "{{ music_preset_2_label }}"
                                    - "play {{ music_preset_2_label }}"
                                - id: "preset3"
                                  sentences:
                                    - "{{ music_preset_3_label }}"
                                    - "play {{ music_preset_3_label }}"
                                - id: "none"
                                  sentences:
                                    - "no"
                                    - "nothing"
                                    - "no thanks"
                                    - "cancel"
                            response_variable: music_answer

                          - variables:
                              chosen_media_id: >
                                {% if music_answer is not defined %}
                                  {{ '' }}
                                {% elif music_answer.id == 'preset1' %}
                                  {{ music_preset_1_media_id }}
                                {% elif music_answer.id == 'preset2' %}
                                  {{ music_preset_2_media_id }}
                                {% elif music_answer.id == 'preset3' %}
                                  {{ music_preset_3_media_id }}
                                {% else %}
                                  {{ '' }}
                                {% endif %}

                          - condition: template
                            value_template: "{{ chosen_media_id | trim != '' }}"

                          - if:
                              - condition: template
                                value_template: "{{ (music_volume | float(0)) > 0 }}"
                            then:
                              - action: media_player.volume_set
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  volume_level: "{{ music_volume | float(0) }}"

                          - if:
                              - condition: template
                                value_template: "{{ music_media_type != 'auto' }}"
                            then:
                              - action: music_assistant.play_media
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  media_id: "{{ chosen_media_id }}"
                                  media_type: "{{ music_media_type }}"
                                  enqueue: play
                            else:
                              - action: music_assistant.play_media
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  media_id: "{{ chosen_media_id }}"
                                  enqueue: play

                      # free_text_name: ask "what do you want" with {item} slot
                      - conditions:
                          - condition: template
                            value_template: "{{ music_mode == 'free_text_name' }}"
                        sequence:
                          - action: assist_satellite.ask_question
                            data:
                              entity_id: "{{ music_assist_satellite }}"
                              question: "{{ music_question_final }}"
                              answers:
                                - id: "chosen"
                                  sentences:
                                    - "{item}"
                                    - "yes {item}"
                                    - "play {item}"
                                    - "play {item} please"
                                    - "please play {item}"
                                - id: "none"
                                  sentences:
                                    - "no"
                                    - "nothing"
                                    - "no thanks"
                                    - "cancel"
                            response_variable: music_answer

                          - variables:
                              chosen_media_id: >
                                {% if music_answer is defined
                                      and music_answer.id == 'chosen'
                                      and music_answer.slots is defined
                                      and 'item' in music_answer.slots %}
                                  {{ music_answer.slots.item }}
                                {% else %}
                                  {{ '' }}
                                {% endif %}

                          - condition: template
                            value_template: "{{ chosen_media_id | trim != '' }}"

                          - if:
                              - condition: template
                                value_template: "{{ (music_volume | float(0)) > 0 }}"
                            then:
                              - action: media_player.volume_set
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  volume_level: "{{ music_volume | float(0) }}"

                          - if:
                              - condition: template
                                value_template: "{{ music_media_type != 'auto' }}"
                            then:
                              - action: music_assistant.play_media
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  media_id: "{{ chosen_media_id }}"
                                  media_type: "{{ music_media_type }}"
                                  enqueue: play
                            else:
                              - action: music_assistant.play_media
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  media_id: "{{ chosen_media_id }}"
                                  enqueue: play

                      # preset_single or from_input_text: play directly, no second question
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ music_mode != 'preset_multi' and
                                 music_mode != 'free_text_name' }}
                        sequence:
                          - variables:
                              chosen_media_id: >
                                {% if music_mode == 'from_input_text' %}
                                  {{ states(music_media_input_text) }}
                                {% else %}
                                  {{ music_media_id }}
                                {% endif %}

                          - condition: template
                            value_template: "{{ chosen_media_id | trim != '' }}"

                          - if:
                              - condition: template
                                value_template: "{{ (music_volume | float(0)) > 0 }}"
                            then:
                              - action: media_player.volume_set
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  volume_level: "{{ music_volume | float(0) }}"

                          - if:
                              - condition: template
                                value_template: "{{ music_media_type != 'auto' }}"
                            then:
                              - action: music_assistant.play_media
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  media_id: "{{ chosen_media_id }}"
                                  media_type: "{{ music_media_type }}"
                                  enqueue: play
                            else:
                              - action: music_assistant.play_media
                                target:
                                  entity_id: "{{ music_player }}"
                                data:
                                  media_id: "{{ chosen_media_id }}"
                                  enqueue: play

            # 6c) NO (or timeout) to intro music question → confirm NO
            default:
              - action: assist_satellite.announce
                target:
                  entity_id: "{{ music_assist_satellite }}"
                data:
                  message: "{{ music_no_final }}"
                  preannounce: false

  # 7) Optional post-announcement TTS (with satellite option)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ post_tts_final | trim != '' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_satellite_for_pre_post }}"
                sequence:
                  - action: assist_satellite.announce
                    target:
                      entity_id: "{{ music_assist_satellite }}"
                    data:
                      message: "{{ post_tts_final }}"
                      preannounce: false
              - conditions:
                  - condition: template
                    value_template: "{{ tts_voice_profile | trim != '' }}"
                sequence:
                  - action: tts.speak
                    target:
                      entity_id: "{{ tts_entity }}"
                    data:
                      message: "{{ post_tts_final }}"
                      media_player_entity_id: "{{ tts_media_player }}"
                      options:
                        voice_profile: "{{ tts_voice_profile }}"
            default:
              - action: tts.speak
                target:
                  entity_id: "{{ tts_entity }}"
                data:
                  message: "{{ post_tts_final }}"
                  media_player_entity_id: "{{ tts_media_player }}"
